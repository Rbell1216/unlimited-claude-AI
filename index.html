<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Pro UI (Puter)</title>

<script src="https://js.puter.com/v2/"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<style>
body { margin:0; font-family:system-ui; background:#121212; color:#eee; }
#app { display:flex; height:100vh; }
.sidebar { width:260px; background:#1e1e1e; padding:10px; overflow:auto; border-right:1px solid #333; }
.main { flex:1; display:flex; flex-direction:column; }
.chat { flex:1; padding:15px; overflow:auto; }
.msg { margin-bottom:12px; max-width:70%; padding:10px; border-radius:10px; }
.user { background:#ff6b35; color:white; margin-left:auto; }
.ai { background:#222; }
.controls { padding:10px; border-top:1px solid #333; display:flex; gap:6px; }
textarea { flex:1; padding:10px; border-radius:6px; background:#222; color:#fff; border:1px solid #444; }
button { padding:8px 12px; background:#ff6b35; border:none; border-radius:6px; color:white; cursor:pointer; }
select { width:100%; padding:6px; background:#222; color:#fff; border:1px solid #444; }
</style>
</head>

<body>
<div id="app">
<div class="sidebar">
<h3>Models</h3>
<input id="modelSearch" placeholder="Search models..." style="width:100%;padding:6px;">
<select id="modelDropdown" size="8"></select>
<hr>
<h3>Conversations</h3>
<div id="convList"></div>
</div>

<div class="main">
<div class="chat" id="chat"></div>
<div class="controls">
<textarea id="input" rows="1" placeholder="Type message... Ctrl+Enter to send"></textarea>
<button id="send">Send</button>
<button id="stop" style="background:#444">Stop</button>
</div>
</div>
</div>

<script>
const App = {
 models: [],
 currentModel: null,
 conversations: [],
 currentConv: null,
 streaming: false,
 controller: null,

 async init() {
   await this.loadModels();
   this.loadConversations();
   this.bindUI();
 },

 // ---------------- MODELS ----------------
 async loadModels() {
   const cached = localStorage.getItem("puter_models");
   if (cached) {
     this.models = JSON.parse(cached);
   } else {
     this.models = await puter.ai.listModels();
     localStorage.setItem("puter_models", JSON.stringify(this.models));
   }
   this.currentModel = this.models[0]?.id;
   this.buildModelUI();
 },

 classify(name) {
   if (/vision|image/i.test(name)) return "üñº";
   if (/audio|whisper/i.test(name)) return "üéß";
   return "üß†";
 },

 buildModelUI() {
   const dropdown = document.getElementById("modelDropdown");
   dropdown.innerHTML = "";
   this.models.forEach(m => {
     const opt = document.createElement("option");
     opt.value = m.id;
     opt.textContent = `${this.classify(m.name||m.id)} ${m.name||m.id}`;
     dropdown.appendChild(opt);
   });
   dropdown.value = this.currentModel;
 },

 // ---------------- CONVERSATIONS ----------------
 saveConversations() {
   localStorage.setItem("conversations", JSON.stringify(this.conversations));
 },

 loadConversations() {
   const saved = localStorage.getItem("conversations");
   if (saved) this.conversations = JSON.parse(saved);
   this.renderConvList();
 },

 newConversation() {
   const id = Date.now().toString();
   const conv = {id, messages:[]};
   this.conversations.unshift(conv);
   this.currentConv = conv;
   this.saveConversations();
   this.renderConvList();
   document.getElementById("chat").innerHTML = "";
 },

 renderConvList() {
   const list = document.getElementById("convList");
   list.innerHTML = "";
   this.conversations.forEach(c => {
     const div = document.createElement("div");
     div.textContent = c.messages[0]?.content?.slice(0,30) || "New chat";
     div.style.cursor="pointer";
     div.onclick = () => this.loadConversation(c.id);
     list.appendChild(div);
   });
 },

 loadConversation(id) {
   this.currentConv = this.conversations.find(c=>c.id===id);
   const chat = document.getElementById("chat");
   chat.innerHTML = "";
   this.currentConv.messages.forEach(m => this.addMessage(m.content, m.role));
 },

 // ---------------- UI ----------------
 bindUI() {
   document.getElementById("send").onclick = () => this.send();
   document.getElementById("stop").onclick = () => this.stopStream();
   document.getElementById("modelDropdown").onchange = e => this.currentModel = e.target.value;
   document.getElementById("modelSearch").oninput = e => {
     const term = e.target.value.toLowerCase();
     this.buildModelUI();
     [...modelDropdown.options].forEach(o=>{
       o.hidden = !o.textContent.toLowerCase().includes(term);
     });
   };

   document.getElementById("input").addEventListener("keydown", e=>{
     if(e.ctrlKey && e.key==="Enter") this.send();
   });

   if (!this.conversations.length) this.newConversation();
 },

 // ---------------- CHAT ----------------
 addMessage(text, role) {
   const chat = document.getElementById("chat");
   const div = document.createElement("div");
   div.className = "msg " + (role==="user"?"user":"ai");
   div.innerHTML = DOMPurify.sanitize(marked.parse(text));
   chat.appendChild(div);
   chat.scrollTop = chat.scrollHeight;
 },

 async send() {
   if (this.streaming) return;
   const input = document.getElementById("input");
   const text = input.value.trim();
   if (!text) return;
   input.value="";

   this.addMessage(text,"user");
   this.currentConv.messages.push({role:"user",content:text});
   this.saveConversations();

   this.streaming = true;
   this.controller = new AbortController();

   let aiDiv = document.createElement("div");
   aiDiv.className="msg ai";
   document.getElementById("chat").appendChild(aiDiv);

   let full="";

   try {
     const res = await puter.ai.chat(this.currentConv.messages, {
       model:this.currentModel,
       stream:true,
       signal:this.controller.signal
     });

     for await (const part of res) {
       if(part.text){
         full += part.text;
         aiDiv.textContent += part.text; // FAST streaming append
       }
     }

     aiDiv.innerHTML = DOMPurify.sanitize(marked.parse(full));
     this.currentConv.messages.push({role:"assistant",content:full});
     this.saveConversations();
   } catch(e) {
     aiDiv.textContent = "‚ùå " + e.message;
   }

   this.streaming=false;
 },

 stopStream() {
   if(this.controller) this.controller.abort();
   this.streaming=false;
 }
};

App.init();
</script>
</body>
</html>
