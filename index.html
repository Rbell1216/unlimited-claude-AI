<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude ‚Äì AI Interface</title>
    <script src="https://js.puter.com/v2/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* ===== RESET & TOKENS ===== */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg:        #111113;
            --bg-2:      #18181b;
            --bg-3:      #222227;
            --bg-4:      #2c2c33;
            --border:    #2e2e36;
            --border-2:  #3d3d48;
            --text:      #e4e4ef;
            --text-2:    #9090a8;
            --text-3:    #5c5c72;
            --accent:    #f97316;
            --accent-h:  #fb8c3b;
            --accent-l:  rgba(249, 115, 22, 0.12);
            --blue:      #60a5fa;
            --green:     #34d399;
            --red:       #f87171;
            --radius:    10px;
            --radius-lg: 16px;
            --shadow:    0 4px 24px rgba(0,0,0,0.4);
        }

        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 15px;
            line-height: 1.6;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-3); }

        /* ===== LAYOUT ===== */
        .app { display: flex; height: 100vh; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 260px;
            min-width: 260px;
            background: var(--bg-2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .sidebar-header {
            padding: 18px 16px 14px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 9px;
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 14px;
            letter-spacing: -0.3px;
        }

        .logo-icon {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(249,115,22,0.35);
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 9px 12px;
            background: var(--accent-l);
            border: 1px solid rgba(249,115,22,0.25);
            border-radius: var(--radius);
            color: var(--accent);
            font-size: 13.5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
        }
        .new-chat-btn:hover {
            background: rgba(249,115,22,0.2);
            border-color: rgba(249,115,22,0.4);
        }

        .sidebar-body { flex: 1; padding: 14px 12px; overflow-y: auto; }

        .section-label {
            font-size: 10.5px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: var(--text-3);
            padding: 0 4px;
            margin-bottom: 8px;
        }

        .recent-item {
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .recent-item:hover { background: var(--bg-3); color: var(--text); }
        .recent-item.active { background: var(--accent-l); color: var(--accent); }

        .empty-note {
            padding: 8px 4px;
            font-size: 12.5px;
            color: var(--text-3);
            font-style: italic;
        }

        .sidebar-footer {
            padding: 12px 14px;
            border-top: 1px solid var(--border);
        }

        .user-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 9px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .user-row:hover { background: var(--bg-3); }

        .user-avatar {
            width: 30px; height: 30px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .user-name { font-size: 13.5px; font-weight: 500; color: var(--text); }
        .user-plan { font-size: 11.5px; color: var(--text-3); }

        /* ===== MAIN ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        /* ===== WELCOME SCREEN ===== */
        #welcomeScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            gap: 28px;
            animation: fadeUp 0.4s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .greeting-block { text-align: center; }
        .greeting-time { font-size: 13px; color: var(--text-3); margin-bottom: 6px; letter-spacing: 0.5px; }
        .greeting-main {
            font-size: 34px;
            font-weight: 300;
            color: var(--text);
            letter-spacing: -1px;
            line-height: 1.15;
        }
        .greeting-main span { color: var(--accent); font-weight: 600; }

        .welcome-input-wrap {
            width: 100%;
            max-width: 620px;
            position: relative;
        }

        .welcome-textarea {
            width: 100%;
            padding: 16px 56px 16px 18px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            resize: none;
            min-height: 54px;
            max-height: 180px;
            transition: border-color 0.2s, box-shadow 0.2s;
            line-height: 1.5;
        }
        .welcome-textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.12);
        }
        .welcome-textarea::placeholder { color: var(--text-3); }

        .send-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            width: 34px; height: 34px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.18s, transform 0.12s;
        }
        .send-btn:hover:not(:disabled) { background: var(--accent-h); transform: scale(1.05); }
        .send-btn:disabled { background: var(--bg-4); cursor: not-allowed; opacity: 0.5; }

        /* model pill */
        .model-pill-wrap { position: relative; display: inline-block; }

        .model-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: 99px;
            font-size: 12.5px;
            color: var(--text-2);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.18s;
        }
        .model-pill:hover { border-color: var(--accent); color: var(--accent); }
        .model-pill .dot {
            width: 6px; height: 6px;
            background: var(--green);
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* model dropdown */
        .model-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            min-width: 260px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            z-index: 100;
            overflow: hidden;
            animation: dropIn 0.18s ease;
        }
        @keyframes dropIn {
            from { opacity: 0; transform: translateX(-50%) translateY(6px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .model-dropdown-header {
            padding: 10px 14px 8px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.7px;
            text-transform: uppercase;
            color: var(--text-3);
            border-bottom: 1px solid var(--border);
        }

        .model-option {
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer;
            transition: background 0.14s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .model-option:hover { background: var(--bg-4); color: var(--text); }
        .model-option.selected { color: var(--accent); font-weight: 500; }
        .model-option .model-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--border-2);
            flex-shrink: 0;
        }
        .model-option.selected .model-dot { background: var(--accent); }

        .action-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-chip {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 10px 18px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 99px;
            color: var(--text-2);
            font-size: 13.5px;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
        }
        .action-chip:hover {
            background: var(--bg-3);
            border-color: var(--border-2);
            color: var(--text);
            transform: translateY(-1px);
        }

        /* auth banner */
        .auth-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: rgba(96,165,250,0.08);
            border: 1px solid rgba(96,165,250,0.2);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text-2);
            max-width: 620px;
            width: 100%;
        }

        .auth-btn {
            margin-left: auto;
            padding: 5px 14px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12.5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: opacity 0.18s;
            white-space: nowrap;
        }
        .auth-btn:hover { opacity: 0.88; }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ===== CHAT ===== */
        #chatContainer {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        #chatContainer.active { display: flex; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px 0;
            scroll-behavior: smooth;
        }

        .msg-row {
            display: flex;
            gap: 14px;
            padding: 4px 24px;
            max-width: 860px;
            margin: 0 auto;
            width: 100%;
            animation: msgIn 0.22s ease;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .msg-row.user { flex-direction: row-reverse; }

        .msg-avatar {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .msg-row.user .msg-avatar {
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            color: white;
        }
        .msg-row.assistant .msg-avatar {
            background: var(--bg-3);
            border: 1px solid var(--border);
            color: var(--text-2);
        }

        .msg-body { flex: 1; min-width: 0; }

        .msg-bubble {
            display: inline-block;
            max-width: 78%;
            padding: 12px 16px;
            background: var(--bg-3);
            border: 1px solid var(--border);
            border-radius: 14px 14px 14px 4px;
            line-height: 1.65;
            word-break: break-word;
        }
        .msg-row.user .msg-bubble {
            background: linear-gradient(135deg, var(--accent), #ea6a0e);
            border-color: transparent;
            border-radius: 14px 14px 4px 14px;
            color: white;
            float: right;
        }
        .msg-row.assistant .msg-body { padding-right: 40px; }

        /* markdown styles inside assistant bubbles */
        .msg-md h1, .msg-md h2, .msg-md h3, .msg-md h4 {
            font-weight: 600;
            margin: 14px 0 6px;
            letter-spacing: -0.3px;
            line-height: 1.3;
        }
        .msg-md h1 { font-size: 20px; }
        .msg-md h2 { font-size: 17px; }
        .msg-md h3 { font-size: 15px; }
        .msg-md p { margin-bottom: 10px; }
        .msg-md p:last-child { margin-bottom: 0; }
        .msg-md ul, .msg-md ol { padding-left: 20px; margin-bottom: 10px; }
        .msg-md li { margin-bottom: 4px; }
        .msg-md strong { font-weight: 600; color: var(--text); }
        .msg-md em { font-style: italic; opacity: 0.9; }
        .msg-md a { color: var(--blue); text-decoration: none; border-bottom: 1px solid rgba(96,165,250,0.3); }
        .msg-md a:hover { border-color: var(--blue); }
        .msg-md hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
        .msg-md blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            color: var(--text-2);
            margin: 10px 0;
        }
        .msg-md code:not(pre code) {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            background: var(--bg-4);
            border: 1px solid var(--border-2);
            padding: 1px 6px;
            border-radius: 4px;
            color: var(--accent);
        }
        .msg-md table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13.5px; }
        .msg-md th, .msg-md td { padding: 7px 12px; border: 1px solid var(--border-2); text-align: left; }
        .msg-md th { background: var(--bg-4); font-weight: 600; }

        /* artifact / code block */
        .artifact {
            margin: 10px 0;
            border: 1px solid var(--border-2);
            border-radius: var(--radius);
            overflow: hidden;
            background: #0e0e10;
        }
        .artifact-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-3);
            border-bottom: 1px solid var(--border);
        }
        .artifact-lang {
            font-size: 11.5px;
            font-weight: 500;
            color: var(--text-3);
            font-family: 'JetBrains Mono', monospace;
            text-transform: lowercase;
        }
        .artifact-btns { display: flex; gap: 6px; }
        .artifact-action {
            padding: 3px 10px;
            font-size: 11.5px;
            background: none;
            border: 1px solid var(--border-2);
            border-radius: 5px;
            color: var(--text-3);
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .artifact-action:hover { background: var(--bg-4); color: var(--text); border-color: var(--border-2); }
        .artifact-action.preview { border-color: rgba(96,165,250,0.35); color: var(--blue); }
        .artifact-action.preview:hover { background: rgba(96,165,250,0.1); }
        .artifact-action.copied { border-color: rgba(52,211,153,0.35); color: var(--green); }
        .artifact-body { overflow-x: auto; max-height: 480px; }
        .artifact-body pre { margin: 0 !important; border-radius: 0 !important; }
        .artifact-body pre code.hljs { padding: 14px 16px; font-size: 13px; font-family: 'JetBrains Mono', monospace; background: #0e0e10 !important; }

        /* typing indicator */
        .typing-row {
            display: none;
            gap: 14px;
            padding: 4px 24px;
            max-width: 860px;
            margin: 0 auto;
            width: 100%;
        }
        .typing-row.visible { display: flex; }
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 14px 16px;
        }
        .typing-dot {
            width: 7px; height: 7px;
            background: var(--text-3);
            border-radius: 50%;
            animation: typeBounce 1.3s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.18s; }
        .typing-dot:nth-child(3) { animation-delay: 0.36s; }
        @keyframes typeBounce {
            0%, 70%, 100% { transform: translateY(0); opacity: 0.4; }
            35% { transform: translateY(-5px); opacity: 1; }
        }

        /* chat input bar */
        .chat-input-bar {
            padding: 12px 20px 16px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }
        .chat-input-inner {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 820px;
            margin: 0 auto;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            padding: 8px 10px 8px 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-input-inner:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
        }

        .chat-textarea {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 14.5px;
            font-family: inherit;
            resize: none;
            max-height: 160px;
            line-height: 1.55;
            padding: 4px 0;
        }
        .chat-textarea::placeholder { color: var(--text-3); }

        .chat-actions { display: flex; align-items: center; gap: 6px; }

        .stop-btn {
            width: 30px; height: 30px;
            background: none;
            border: 1px solid var(--red);
            border-radius: 7px;
            color: var(--red);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .stop-btn.visible { display: flex; }
        .stop-btn:hover { background: rgba(248,113,113,0.12); }

        .chat-send-btn {
            width: 32px; height: 32px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.18s;
            flex-shrink: 0;
        }
        .chat-send-btn:hover:not(:disabled) { background: var(--accent-h); }
        .chat-send-btn:disabled { background: var(--bg-4); cursor: not-allowed; opacity: 0.4; }

        .chat-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 820px;
            margin: 6px auto 0;
            padding: 0 4px;
        }

        .chat-model-pill {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11.5px;
            color: var(--text-3);
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 99px;
            transition: all 0.15s;
            font-family: inherit;
            background: none;
            border: 1px solid transparent;
        }
        .chat-model-pill:hover { color: var(--text-2); border-color: var(--border); }
        .chat-hint { font-size: 11px; color: var(--text-3); }

        /* ===== TOAST ===== */
        .toast-stack {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        .toast {
            padding: 10px 16px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text);
            box-shadow: var(--shadow);
            animation: toastIn 0.2s ease, toastOut 0.2s ease 2.6s forwards;
        }
        .toast.success { border-color: rgba(52,211,153,0.4); }
        .toast.error   { border-color: rgba(248,113,113,0.4); }
        @keyframes toastIn  { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { to   { opacity: 0; transform: translateY(10px); } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .sidebar { display: none; }
            .greeting-main { font-size: 26px; }
            .msg-row.assistant .msg-body { padding-right: 0; }
        }
    </style>
</head>
<body>

<div class="app">

    <!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">‚ú¶</div>
                Claude
            </div>
            <button class="new-chat-btn" id="newChatBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H13v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                New conversation
            </button>
        </div>

        <div class="sidebar-body" id="sidebarBody">
            <div class="section-label">Recents</div>
            <div id="recentList">
                <div class="empty-note" id="emptyNote">No recent chats</div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-row">
                <div class="user-avatar">H</div>
                <div>
                    <div class="user-name">Hassan</div>
                    <div class="user-plan">Free via Puter.js</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
    <main class="main">

        <!-- Welcome Screen -->
        <div id="welcomeScreen">
            <div class="greeting-block">
                <div class="greeting-time" id="greetTime"></div>
                <div class="greeting-main">Hello, <span>Hassan</span> üëã</div>
            </div>

            <div id="authBanner" class="auth-banner" style="display:none">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color:#60a5fa;flex-shrink:0"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                <span id="authBannerMsg">Session issue ‚Äî please re-authenticate.</span>
                <button class="auth-btn" id="authBtn">Authenticate</button>
            </div>

            <div class="welcome-input-wrap">
                <textarea class="welcome-textarea" id="welcomeInput" placeholder="Ask me anything‚Ä¶" rows="1"></textarea>
                <button class="send-btn" id="welcomeSendBtn" title="Send (Enter)">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>

            <!-- Model picker -->
            <div class="model-pill-wrap" id="welcomeModelWrap">
                <button class="model-pill" id="welcomeModelPill">
                    <div class="dot"></div>
                    <span id="welcomeModelName">Loading‚Ä¶</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="model-dropdown" id="modelDropdown" style="display:none">
                    <div class="model-dropdown-header">Select Model</div>
                    <div id="modelList">
                        <div style="padding:12px 14px;font-size:12.5px;color:var(--text-3)">Loading models‚Ä¶</div>
                    </div>
                </div>
            </div>

            <div class="action-chips">
                <button class="action-chip" data-prompt="Help me write ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    Write
                </button>
                <button class="action-chip" data-prompt="Help me code ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                    Code
                </button>
                <button class="action-chip" data-prompt="Explain this concept: ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    Explain
                </button>
                <button class="action-chip" data-prompt="Summarize the following: ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h7v-2H3v2zM18 7l-1.41 1.41L18.17 10H16v2h2.17l-1.59 1.59L18 15l4-4z"/></svg>
                    Summarize
                </button>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chatContainer">
            <div class="chat-messages" id="chatMessages">

                <!-- Typing indicator -->
                <div class="typing-row" id="typingRow">
                    <div class="msg-avatar" style="background:var(--bg-3);border:1px solid var(--border)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                    </div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

            </div>

            <!-- Input bar -->
            <div class="chat-input-bar">
                <div class="chat-input-inner">
                    <textarea class="chat-textarea" id="chatInput" placeholder="Message Claude‚Ä¶" rows="1"></textarea>
                    <div class="chat-actions">
                        <button class="stop-btn" id="stopBtn" title="Stop generation">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                        </button>
                        <button class="chat-send-btn" id="chatSendBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="chat-bottom-row">
                    <button class="chat-model-pill" id="chatModelPill">
                        <div class="dot" style="width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 2s infinite"></div>
                        <span id="chatModelName">‚Ä¶</span>
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                    </button>
                    <span class="chat-hint">Enter to send ¬∑ Shift+Enter for newline</span>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- Toast stack -->
<div class="toast-stack" id="toastStack"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
    models: [],
    currentModel: null,
    chatHistory: [],
    isStreaming: false,
    stopRequested: false,
    conversations: [],
    activeConvId: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    setGreeting();
    bindEvents();
    loadModels();
    document.getElementById('welcomeInput').focus();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GREETING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setGreeting() {
    const h = new Date().getHours();
    const period = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
    const icons  = { morning: 'üå§Ô∏è', afternoon: '‚òÄÔ∏è', evening: 'üåô' };
    document.getElementById('greetTime').textContent = `${icons[period]} Good ${period}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODEL LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadModels() {
    try {
        if (typeof puter === 'undefined' || !puter.ai) throw new Error('Puter not loaded');
        const raw = await puter.ai.listModels();
        if (!raw?.length) throw new Error('No models returned');

        state.models = raw;
        // Prefer claude-3-5-sonnet or first available
        const preferred = raw.find(m => m.id.includes('claude-3-5-sonnet')) || raw[0];
        state.currentModel = preferred.id;

        buildModelDropdown();
        updateModelPills();
        console.log('‚úÖ Models loaded:', state.models.length);
    } catch (err) {
        console.error('‚ùå loadModels:', err);
        document.getElementById('welcomeModelName').textContent = 'Error loading models';
        document.getElementById('chatModelName').textContent = 'Error';
    }
}

function buildModelDropdown() {
    const list = document.getElementById('modelList');
    list.innerHTML = '';
    state.models.forEach(m => {
        const div = document.createElement('div');
        div.className = 'model-option' + (m.id === state.currentModel ? ' selected' : '');
        div.dataset.id = m.id;
        div.innerHTML = `<div class="model-dot"></div><span>${m.name || m.id}</span>`;
        div.addEventListener('click', () => selectModel(m.id));
        list.appendChild(div);
    });
}

function selectModel(id) {
    state.currentModel = id;
    updateModelPills();
    buildModelDropdown();
    closeDropdown();
    toast(`Model: ${getModelLabel()}`, 'success');
}

function getModelLabel() {
    const m = state.models.find(x => x.id === state.currentModel);
    return m ? (m.name || m.id) : (state.currentModel || '‚Ä¶');
}

function updateModelPills() {
    const label = getModelLabel();
    document.getElementById('welcomeModelName').textContent = label;
    document.getElementById('chatModelName').textContent = label;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DROPDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeDropdown() {
    document.getElementById('modelDropdown').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EVENT BINDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindEvents() {
    // Send buttons
    document.getElementById('welcomeSendBtn').addEventListener('click', handleWelcomeSend);
    document.getElementById('chatSendBtn').addEventListener('click', handleChatSend);
    document.getElementById('stopBtn').addEventListener('click', stopStreaming);

    // New chat
    document.getElementById('newChatBtn').addEventListener('click', startNewChat);

    // Auth (only shown when a session error occurs)
    document.getElementById('authBtn').addEventListener('click', handleAuth);

    // Textareas
    ['welcomeInput', 'chatInput'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => autoResize(el));
        el.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                id === 'welcomeInput' ? handleWelcomeSend() : handleChatSend();
            }
        });
    });

    // Action chips
    document.querySelectorAll('.action-chip').forEach(btn => {
        btn.addEventListener('click', () => {
            const p = btn.dataset.prompt;
            const inp = document.getElementById('welcomeInput');
            inp.value = p;
            inp.focus();
            autoResize(inp);
            // move cursor to end
            inp.setSelectionRange(inp.value.length, inp.value.length);
        });
    });

    // Model dropdown toggle
    document.getElementById('welcomeModelPill').addEventListener('click', e => {
        e.stopPropagation();
        const dd = document.getElementById('modelDropdown');
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });

    // Chat model pill opens dropdown near input
    document.getElementById('chatModelPill').addEventListener('click', e => {
        e.stopPropagation();
        const dd = document.getElementById('modelDropdown');
        // Re-attach to chat bottom
        const wrap = document.getElementById('chatModelPill').parentElement;
        dd.style.bottom = '100%';
        dd.style.left = '0';
        dd.style.transform = 'none';
        wrap.style.position = 'relative';
        wrap.appendChild(dd);
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });

    // Close dropdown on outside click
    document.addEventListener('click', () => closeDropdown());

    // Model dropdowns shouldn't close when clicking inside them
    document.getElementById('modelDropdown').addEventListener('click', e => e.stopPropagation());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// Puter.js auto-creates a guest session on first use.
// This handler is only invoked when an explicit auth error occurs.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAuthBanner(msg) {
    const banner = document.getElementById('authBanner');
    if (msg) document.getElementById('authBannerMsg').textContent = msg;
    banner.style.display = 'flex';
}

async function handleAuth() {
    const btn = document.getElementById('authBtn');
    btn.textContent = 'Authenticating‚Ä¶';
    btn.disabled = true;
    try {
        // Puter will show its own popup if needed to create/restore a session
        await puter.ai.chat('hi', { model: state.currentModel || 'claude-sonnet-4' });
        document.getElementById('authBanner').style.display = 'none';
        toast('Session restored ‚úì', 'success');
        await loadModels();
    } catch (err) {
        btn.textContent = 'Retry';
        btn.disabled = false;
        toast('Auth failed ‚Äî check popup permissions', 'error');
        console.error('Auth error:', err);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEND MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleWelcomeSend() {
    const inp = document.getElementById('welcomeInput');
    const msg = inp.value.trim();
    if (!msg || state.isStreaming) return;
    inp.value = '';
    autoResize(inp);
    newConversation(msg);
    showChat();
    sendMessage(msg);
}

function handleChatSend() {
    const inp = document.getElementById('chatInput');
    const msg = inp.value.trim();
    if (!msg || state.isStreaming) return;
    inp.value = '';
    autoResize(inp);
    sendMessage(msg);
}

function stopStreaming() {
    state.stopRequested = true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CORE SEND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMessage(message) {
    if (state.isStreaming) return;

    appendMessage(message, 'user');
    state.chatHistory.push({ role: 'user', content: message });

    showTyping(true);
    setInputEnabled(false);
    state.isStreaming = true;
    state.stopRequested = false;
    document.getElementById('stopBtn').classList.add('visible');

    try {
        if (typeof puter === 'undefined') throw new Error('Puter.js not loaded');

        const response = await puter.ai.chat(state.chatHistory, {
            model: state.currentModel,
            stream: true,
        });

        const { contentEl } = appendMessage('', 'assistant');
        showTyping(false);
        let full = '';

        for await (const chunk of response) {
            if (state.stopRequested) break;
            if (chunk?.text) {
                full += chunk.text;
                renderMarkdown(full, contentEl);
                scrollBottom();
            }
        }

        renderMarkdown(full, contentEl); // Final render
        state.chatHistory.push({ role: 'assistant', content: full });
        saveConversation();

    } catch (err) {
        showTyping(false);
        console.error('sendMessage error:', err);
        const msg = err.message || '';
        const isAuthErr = /auth|login|sign.?in|unauthorized|401/i.test(msg);
        const isRateErr = /limit|quota|rate|429/i.test(msg);

        if (isAuthErr) {
            appendMessage('‚ö†Ô∏è Authentication issue ‚Äî your Puter session may have expired.', 'assistant', true);
            showAuthBanner('Session expired. Click to re-authenticate.');
        } else if (isRateErr) {
            appendMessage('‚ö†Ô∏è Rate limit reached. Please wait a moment and try again.', 'assistant', true);
        } else {
            appendMessage(`Error: ${msg || 'Unknown error. Check console.'}`, 'assistant', true);
        }
        // Remove the failed user message from history so user can retry cleanly
        if (state.chatHistory.at(-1)?.role === 'user') state.chatHistory.pop();
    } finally {
        state.isStreaming = false;
        state.stopRequested = false;
        document.getElementById('stopBtn').classList.remove('visible');
        setInputEnabled(true);
        document.getElementById('chatInput').focus();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONVERSATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function newConversation(firstMsg) {
    state.activeConvId = `c_${Date.now()}`;
    const title = firstMsg.length > 48 ? firstMsg.slice(0, 48) + '‚Ä¶' : firstMsg;
    state.conversations.unshift({ id: state.activeConvId, title, messages: [] });
    if (state.conversations.length > 20) state.conversations = state.conversations.slice(0, 20);
    renderSidebar();
}

function saveConversation() {
    const conv = state.conversations.find(c => c.id === state.activeConvId);
    if (conv) {
        conv.messages = [...state.chatHistory];
        renderSidebar();
    }
}

function renderSidebar() {
    const list = document.getElementById('recentList');
    const empty = document.getElementById('emptyNote');
    if (!state.conversations.length) {
        empty?.remove();
        list.innerHTML = '<div class="empty-note">No recent chats</div>';
        return;
    }
    list.innerHTML = '';
    state.conversations.forEach(conv => {
        const div = document.createElement('div');
        div.className = 'recent-item' + (conv.id === state.activeConvId ? ' active' : '');
        div.textContent = conv.title;
        div.title = conv.title;
        div.addEventListener('click', () => loadConversation(conv.id));
        list.appendChild(div);
    });
}

function loadConversation(id) {
    const conv = state.conversations.find(c => c.id === id);
    if (!conv) return;
    state.activeConvId = id;
    state.chatHistory = [...conv.messages];
    showChat();
    const msgs = document.getElementById('chatMessages');
    // Clear all messages except typing row
    Array.from(msgs.querySelectorAll('.msg-row')).forEach(r => r.remove());
    conv.messages.forEach(m => appendMessage(m.content, m.role));
    renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIEW SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showChat() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('chatContainer').classList.add('active');
}

function startNewChat() {
    state.chatHistory = [];
    state.activeConvId = null;
    document.getElementById('chatMessages').querySelectorAll('.msg-row').forEach(r => r.remove());
    document.getElementById('chatContainer').classList.remove('active');
    document.getElementById('welcomeScreen').style.display = '';
    document.getElementById('welcomeInput').value = '';
    autoResize(document.getElementById('welcomeInput'));
    document.getElementById('welcomeInput').focus();
    renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function appendMessage(content, role, isError = false) {
    const msgs = document.getElementById('chatMessages');
    const typing = document.getElementById('typingRow');

    const row = document.createElement('div');
    row.className = `msg-row ${role}`;

    const avatar = document.createElement('div');
    avatar.className = 'msg-avatar';
    avatar.textContent = role === 'user' ? 'H' : '‚ú¶';

    const body = document.createElement('div');
    body.className = 'msg-body';

    if (role === 'user') {
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = content;
        body.appendChild(bubble);
    } else {
        body.className += ' msg-md';
        if (isError) body.style.color = 'var(--red)';
        renderMarkdown(content, body);
    }

    row.appendChild(avatar);
    row.appendChild(body);

    // Insert before typing indicator
    msgs.insertBefore(row, typing);
    scrollBottom();

    return { row, contentEl: body };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MARKDOWN RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkdown(raw, container) {
    container.innerHTML = '';
    if (!raw) return;

    // Split on fenced code blocks
    const codeRe = /```(\w*)\n?([\s\S]*?)```/g;
    let last = 0, match;

    while ((match = codeRe.exec(raw)) !== null) {
        if (match.index > last) {
            const textNode = document.createElement('div');
            textNode.innerHTML = parseInlineMarkdown(raw.slice(last, match.index));
            container.appendChild(textNode);
        }
        container.appendChild(buildArtifact(match[2].trim(), match[1] || 'text'));
        last = match.index + match[0].length;
    }

    if (last < raw.length) {
        const textNode = document.createElement('div');
        textNode.innerHTML = parseInlineMarkdown(raw.slice(last));
        container.appendChild(textNode);
    }

    // Syntax highlight
    container.querySelectorAll('pre code').forEach(el => {
        if (el.dataset.highlighted) return;
        hljs.highlightElement(el);
    });
}

/**
 * Convert markdown text (no code blocks) to HTML.
 * Handles: headers, bold, italic, inline code, links, horizontal rules,
 * blockquotes, unordered/ordered lists, tables, line breaks.
 */
function parseInlineMarkdown(text) {
    const lines = text.split('\n');
    let html = '';
    let inList = null; // 'ul' | 'ol' | null
    let inTable = false;
    let tableHeaderDone = false;

    const closeList = () => {
        if (inList) { html += `</${inList}>`; inList = null; }
    };
    const closeTable = () => {
        if (inTable) { html += `</tbody></table>`; inTable = false; tableHeaderDone = false; }
    };

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // Horizontal rule
        if (/^[-*_]{3,}\s*$/.test(line)) { closeList(); closeTable(); html += '<hr>'; continue; }

        // Headings
        const headingMatch = line.match(/^(#{1,4})\s+(.+)$/);
        if (headingMatch) {
            closeList(); closeTable();
            const level = headingMatch[1].length;
            html += `<h${level}>${inline(headingMatch[2])}</h${level}>`;
            continue;
        }

        // Blockquote
        if (line.startsWith('> ')) {
            closeList(); closeTable();
            html += `<blockquote>${inline(line.slice(2))}</blockquote>`;
            continue;
        }

        // Table row
        if (line.includes('|')) {
            const cells = line.split('|').map(c => c.trim()).filter(Boolean);
            if (cells.length > 1) {
                closeList();
                // Separator row?
                if (cells.every(c => /^[-:]+$/.test(c))) {
                    tableHeaderDone = true;
                    html += '<thead-done>';
                    continue;
                }
                if (!inTable) {
                    html += '<table><thead><tr>' + cells.map(c => `<th>${inline(c)}</th>`).join('') + '</tr></thead><tbody>';
                    inTable = true;
                } else {
                    html += '<tr>' + cells.map(c => `<td>${inline(c)}</td>`).join('') + '</tr>';
                }
                continue;
            }
        }
        closeTable();

        // Unordered list
        const ulMatch = line.match(/^(\s*)[-*+]\s+(.+)$/);
        if (ulMatch) {
            if (inList !== 'ul') { closeList(); html += '<ul>'; inList = 'ul'; }
            html += `<li>${inline(ulMatch[2])}</li>`;
            continue;
        }

        // Ordered list
        const olMatch = line.match(/^(\s*)\d+\.\s+(.+)$/);
        if (olMatch) {
            if (inList !== 'ol') { closeList(); html += '<ol>'; inList = 'ol'; }
            html += `<li>${inline(olMatch[2])}</li>`;
            continue;
        }

        closeList();

        // Empty line ‚Üí paragraph break
        if (line.trim() === '') { html += '<br>'; continue; }

        // Regular paragraph line
        html += `<p>${inline(line)}</p>`;
    }
    closeList(); closeTable();

    // Clean up table head sentinel
    html = html.replace(/<thead-done>/g, '');
    return html;
}

function inline(text) {
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/__(.+?)__/g, '<strong>$1</strong>')
        .replace(/_(.+?)_/g, '<em>$1</em>')
        .replace(/~~(.+?)~~/g, '<del>$1</del>')
        .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARTIFACT / CODE BLOCK BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildArtifact(code, lang) {
    const wrap = document.createElement('div');
    wrap.className = 'artifact';

    const head = document.createElement('div');
    head.className = 'artifact-head';

    const langLabel = document.createElement('span');
    langLabel.className = 'artifact-lang';
    langLabel.textContent = lang === 'text' ? 'plaintext' : lang;
    head.appendChild(langLabel);

    const btns = document.createElement('div');
    btns.className = 'artifact-btns';

    // Preview for HTML
    if (lang.toLowerCase() === 'html') {
        const prevBtn = buildArtifactBtn('Preview', 'preview', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5z"/></svg>`);
        prevBtn.addEventListener('click', () => {
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const w = window.open(url, '_blank');
            // Revoke after tab opens
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        });
        btns.appendChild(prevBtn);
    }

    // Copy
    const copyBtn = buildArtifactBtn('Copy', '', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2z"/></svg>`);
    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(code).then(() => {
            copyBtn.classList.add('copied');
            copyBtn.querySelector('span').textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.classList.remove('copied');
                copyBtn.querySelector('span').textContent = 'Copy';
            }, 2000);
        });
    });
    btns.appendChild(copyBtn);

    // Download
    const extMap = { javascript: 'js', js: 'js', python: 'py', py: 'py', html: 'html', css: 'css', json: 'json', typescript: 'ts', ts: 'ts', bash: 'sh', shell: 'sh', sql: 'sql' };
    const ext = extMap[lang.toLowerCase()] || 'txt';
    const dlBtn = buildArtifactBtn('Download', '', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>`);
    dlBtn.addEventListener('click', () => {
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `code.${ext}`; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    });
    btns.appendChild(dlBtn);

    head.appendChild(btns);

    const body = document.createElement('div');
    body.className = 'artifact-body';
    const pre = document.createElement('pre');
    const codeEl = document.createElement('code');
    if (lang && lang !== 'text') codeEl.className = `language-${lang}`;
    codeEl.textContent = code;
    pre.appendChild(codeEl);
    body.appendChild(pre);

    wrap.appendChild(head);
    wrap.appendChild(body);

    // Highlight after DOM insertion (deferred)
    requestAnimationFrame(() => {
        if (lang && lang !== 'text' && !codeEl.dataset.highlighted) {
            hljs.highlightElement(codeEl);
        }
    });

    return wrap;
}

function buildArtifactBtn(label, extraClass, iconSvg) {
    const btn = document.createElement('button');
    btn.className = 'artifact-action' + (extraClass ? ' ' + extraClass : '');
    btn.innerHTML = iconSvg + `<span>${label}</span>`;
    return btn;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTyping(show) {
    document.getElementById('typingRow').classList.toggle('visible', show);
    if (show) scrollBottom();
}

function setInputEnabled(enabled) {
    ['chatInput', 'chatSendBtn', 'welcomeInput', 'welcomeSendBtn'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = !enabled; el.style.opacity = enabled ? '' : '0.5'; }
    });
}

function scrollBottom() {
    const msgs = document.getElementById('chatMessages');
    requestAnimationFrame(() => { msgs.scrollTop = msgs.scrollHeight; });
}

function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 180) + 'px';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = '') {
    const stack = document.getElementById('toastStack');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    stack.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}
</script>
</body>
</html>
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 15px;
            line-height: 1.6;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-3); }

        /* ===== LAYOUT ===== */
        .app { display: flex; height: 100vh; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 260px;
            min-width: 260px;
            background: var(--bg-2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .sidebar-header {
            padding: 18px 16px 14px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 9px;
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 14px;
            letter-spacing: -0.3px;
        }

        .logo-icon {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(249,115,22,0.35);
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 9px 12px;
            background: var(--accent-l);
            border: 1px solid rgba(249,115,22,0.25);
            border-radius: var(--radius);
            color: var(--accent);
            font-size: 13.5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
        }
        .new-chat-btn:hover {
            background: rgba(249,115,22,0.2);
            border-color: rgba(249,115,22,0.4);
        }

        .sidebar-body { flex: 1; padding: 14px 12px; overflow-y: auto; }

        .section-label {
            font-size: 10.5px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: var(--text-3);
            padding: 0 4px;
            margin-bottom: 8px;
        }

        .recent-item {
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .recent-item:hover { background: var(--bg-3); color: var(--text); }
        .recent-item.active { background: var(--accent-l); color: var(--accent); }

        .empty-note {
            padding: 8px 4px;
            font-size: 12.5px;
            color: var(--text-3);
            font-style: italic;
        }

        .sidebar-footer {
            padding: 12px 14px;
            border-top: 1px solid var(--border);
        }

        .user-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 9px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .user-row:hover { background: var(--bg-3); }

        .user-avatar {
            width: 30px; height: 30px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .user-name { font-size: 13.5px; font-weight: 500; color: var(--text); }
        .user-plan { font-size: 11.5px; color: var(--text-3); }

        /* ===== MAIN ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        /* ===== WELCOME SCREEN ===== */
        #welcomeScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            gap: 28px;
            animation: fadeUp 0.4s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .greeting-block { text-align: center; }
        .greeting-time { font-size: 13px; color: var(--text-3); margin-bottom: 6px; letter-spacing: 0.5px; }
        .greeting-main {
            font-size: 34px;
            font-weight: 300;
            color: var(--text);
            letter-spacing: -1px;
            line-height: 1.15;
        }
        .greeting-main span { color: var(--accent); font-weight: 600; }

        .welcome-input-wrap {
            width: 100%;
            max-width: 620px;
            position: relative;
        }

        .welcome-textarea {
            width: 100%;
            padding: 16px 56px 16px 18px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            resize: none;
            min-height: 54px;
            max-height: 180px;
            transition: border-color 0.2s, box-shadow 0.2s;
            line-height: 1.5;
        }
        .welcome-textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.12);
        }
        .welcome-textarea::placeholder { color: var(--text-3); }

        .send-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            width: 34px; height: 34px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.18s, transform 0.12s;
        }
        .send-btn:hover:not(:disabled) { background: var(--accent-h); transform: scale(1.05); }
        .send-btn:disabled { background: var(--bg-4); cursor: not-allowed; opacity: 0.5; }

        /* model pill */
        .model-pill-wrap { position: relative; display: inline-block; }

        .model-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: 99px;
            font-size: 12.5px;
            color: var(--text-2);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.18s;
        }
        .model-pill:hover { border-color: var(--accent); color: var(--accent); }
        .model-pill .dot {
            width: 6px; height: 6px;
            background: var(--green);
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* model dropdown */
        .model-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            min-width: 260px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            z-index: 100;
            overflow: hidden;
            animation: dropIn 0.18s ease;
        }
        @keyframes dropIn {
            from { opacity: 0; transform: translateX(-50%) translateY(6px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .model-dropdown-header {
            padding: 10px 14px 8px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.7px;
            text-transform: uppercase;
            color: var(--text-3);
            border-bottom: 1px solid var(--border);
        }

        .model-option {
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer;
            transition: background 0.14s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .model-option:hover { background: var(--bg-4); color: var(--text); }
        .model-option.selected { color: var(--accent); font-weight: 500; }
        .model-option .model-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--border-2);
            flex-shrink: 0;
        }
        .model-option.selected .model-dot { background: var(--accent); }

        .action-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-chip {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 10px 18px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 99px;
            color: var(--text-2);
            font-size: 13.5px;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
        }
        .action-chip:hover {
            background: var(--bg-3);
            border-color: var(--border-2);
            color: var(--text);
            transform: translateY(-1px);
        }

        /* auth banner */
        .auth-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: rgba(96,165,250,0.08);
            border: 1px solid rgba(96,165,250,0.2);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text-2);
            max-width: 620px;
            width: 100%;
        }

        .auth-btn {
            margin-left: auto;
            padding: 5px 14px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12.5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: opacity 0.18s;
            white-space: nowrap;
        }
        .auth-btn:hover { opacity: 0.88; }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ===== CHAT ===== */
        #chatContainer {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        #chatContainer.active { display: flex; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px 0;
            scroll-behavior: smooth;
        }

        .msg-row {
            display: flex;
            gap: 14px;
            padding: 4px 24px;
            max-width: 860px;
            margin: 0 auto;
            width: 100%;
            animation: msgIn 0.22s ease;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .msg-row.user { flex-direction: row-reverse; }

        .msg-avatar {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .msg-row.user .msg-avatar {
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            color: white;
        }
        .msg-row.assistant .msg-avatar {
            background: var(--bg-3);
            border: 1px solid var(--border);
            color: var(--text-2);
        }

        .msg-body { flex: 1; min-width: 0; }

        .msg-bubble {
            display: inline-block;
            max-width: 78%;
            padding: 12px 16px;
            background: var(--bg-3);
            border: 1px solid var(--border);
            border-radius: 14px 14px 14px 4px;
            line-height: 1.65;
            word-break: break-word;
        }
        .msg-row.user .msg-bubble {
            background: linear-gradient(135deg, var(--accent), #ea6a0e);
            border-color: transparent;
            border-radius: 14px 14px 4px 14px;
            color: white;
            float: right;
        }
        .msg-row.assistant .msg-body { padding-right: 40px; }

        /* markdown styles inside assistant bubbles */
        .msg-md h1, .msg-md h2, .msg-md h3, .msg-md h4 {
            font-weight: 600;
            margin: 14px 0 6px;
            letter-spacing: -0.3px;
            line-height: 1.3;
        }
        .msg-md h1 { font-size: 20px; }
        .msg-md h2 { font-size: 17px; }
        .msg-md h3 { font-size: 15px; }
        .msg-md p { margin-bottom: 10px; }
        .msg-md p:last-child { margin-bottom: 0; }
        .msg-md ul, .msg-md ol { padding-left: 20px; margin-bottom: 10px; }
        .msg-md li { margin-bottom: 4px; }
        .msg-md strong { font-weight: 600; color: var(--text); }
        .msg-md em { font-style: italic; opacity: 0.9; }
        .msg-md a { color: var(--blue); text-decoration: none; border-bottom: 1px solid rgba(96,165,250,0.3); }
        .msg-md a:hover { border-color: var(--blue); }
        .msg-md hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
        .msg-md blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            color: var(--text-2);
            margin: 10px 0;
        }
        .msg-md code:not(pre code) {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            background: var(--bg-4);
            border: 1px solid var(--border-2);
            padding: 1px 6px;
            border-radius: 4px;
            color: var(--accent);
        }
        .msg-md table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13.5px; }
        .msg-md th, .msg-md td { padding: 7px 12px; border: 1px solid var(--border-2); text-align: left; }
        .msg-md th { background: var(--bg-4); font-weight: 600; }

        /* artifact / code block */
        .artifact {
            margin: 10px 0;
            border: 1px solid var(--border-2);
            border-radius: var(--radius);
            overflow: hidden;
            background: #0e0e10;
        }
        .artifact-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-3);
            border-bottom: 1px solid var(--border);
        }
        .artifact-lang {
            font-size: 11.5px;
            font-weight: 500;
            color: var(--text-3);
            font-family: 'JetBrains Mono', monospace;
            text-transform: lowercase;
        }
        .artifact-btns { display: flex; gap: 6px; }
        .artifact-action {
            padding: 3px 10px;
            font-size: 11.5px;
            background: none;
            border: 1px solid var(--border-2);
            border-radius: 5px;
            color: var(--text-3);
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .artifact-action:hover { background: var(--bg-4); color: var(--text); border-color: var(--border-2); }
        .artifact-action.preview { border-color: rgba(96,165,250,0.35); color: var(--blue); }
        .artifact-action.preview:hover { background: rgba(96,165,250,0.1); }
        .artifact-action.copied { border-color: rgba(52,211,153,0.35); color: var(--green); }
        .artifact-body { overflow-x: auto; max-height: 480px; }
        .artifact-body pre { margin: 0 !important; border-radius: 0 !important; }
        .artifact-body pre code.hljs { padding: 14px 16px; font-size: 13px; font-family: 'JetBrains Mono', monospace; background: #0e0e10 !important; }

        /* typing indicator */
        .typing-row {
            display: none;
            gap: 14px;
            padding: 4px 24px;
            max-width: 860px;
            margin: 0 auto;
            width: 100%;
        }
        .typing-row.visible { display: flex; }
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 14px 16px;
        }
        .typing-dot {
            width: 7px; height: 7px;
            background: var(--text-3);
            border-radius: 50%;
            animation: typeBounce 1.3s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.18s; }
        .typing-dot:nth-child(3) { animation-delay: 0.36s; }
        @keyframes typeBounce {
            0%, 70%, 100% { transform: translateY(0); opacity: 0.4; }
            35% { transform: translateY(-5px); opacity: 1; }
        }

        /* chat input bar */
        .chat-input-bar {
            padding: 12px 20px 16px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }
        .chat-input-inner {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 820px;
            margin: 0 auto;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            padding: 8px 10px 8px 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-input-inner:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
        }

        .chat-textarea {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 14.5px;
            font-family: inherit;
            resize: none;
            max-height: 160px;
            line-height: 1.55;
            padding: 4px 0;
        }
        .chat-textarea::placeholder { color: var(--text-3); }

        .chat-actions { display: flex; align-items: center; gap: 6px; }

        .stop-btn {
            width: 30px; height: 30px;
            background: none;
            border: 1px solid var(--red);
            border-radius: 7px;
            color: var(--red);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .stop-btn.visible { display: flex; }
        .stop-btn:hover { background: rgba(248,113,113,0.12); }

        .chat-send-btn {
            width: 32px; height: 32px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.18s;
            flex-shrink: 0;
        }
        .chat-send-btn:hover:not(:disabled) { background: var(--accent-h); }
        .chat-send-btn:disabled { background: var(--bg-4); cursor: not-allowed; opacity: 0.4; }

        .chat-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 820px;
            margin: 6px auto 0;
            padding: 0 4px;
        }

        .chat-model-pill {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11.5px;
            color: var(--text-3);
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 99px;
            transition: all 0.15s;
            font-family: inherit;
            background: none;
            border: 1px solid transparent;
        }
        .chat-model-pill:hover { color: var(--text-2); border-color: var(--border); }
        .chat-hint { font-size: 11px; color: var(--text-3); }

        /* ===== TOAST ===== */
        .toast-stack {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        .toast {
            padding: 10px 16px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text);
            box-shadow: var(--shadow);
            animation: toastIn 0.2s ease, toastOut 0.2s ease 2.6s forwards;
        }
        .toast.success { border-color: rgba(52,211,153,0.4); }
        .toast.error   { border-color: rgba(248,113,113,0.4); }
        @keyframes toastIn  { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { to   { opacity: 0; transform: translateY(10px); } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .sidebar { display: none; }
            .greeting-main { font-size: 26px; }
            .msg-row.assistant .msg-body { padding-right: 0; }
        }
    </style>
</head>
<body>

<div class="app">

    <!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">‚ú¶</div>
                Claude
            </div>
            <button class="new-chat-btn" id="newChatBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H13v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                New conversation
            </button>
        </div>

        <div class="sidebar-body" id="sidebarBody">
            <div class="section-label">Recents</div>
            <div id="recentList">
                <div class="empty-note" id="emptyNote">No recent chats</div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-row">
                <div class="user-avatar">H</div>
                <div>
                    <div class="user-name">Hassan</div>
                    <div class="user-plan">Free via Puter.js</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
    <main class="main">

        <!-- Welcome Screen -->
        <div id="welcomeScreen">
            <div class="greeting-block">
                <div class="greeting-time" id="greetTime"></div>
                <div class="greeting-main">Hello, <span>Hassan</span> üëã</div>
            </div>

            <!-- Auth Banner Restored -->
            <div id="authBanner" class="auth-banner">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color:#60a5fa;flex-shrink:0"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                <span>Authenticate with Puter to start chatting.</span>
                <button class="auth-btn" id="authBtn">Authenticate</button>
            </div>

            <div class="welcome-input-wrap">
                <textarea class="welcome-textarea" id="welcomeInput" placeholder="Ask me anything‚Ä¶" rows="1"></textarea>
                <button class="send-btn" id="welcomeSendBtn" title="Send (Enter)">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>

            <!-- Model picker -->
            <div class="model-pill-wrap" id="welcomeModelWrap">
                <button class="model-pill" id="welcomeModelPill">
                    <div class="dot"></div>
                    <span id="welcomeModelName">Loading‚Ä¶</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="model-dropdown" id="modelDropdown" style="display:none">
                    <div class="model-dropdown-header">Select Model</div>
                    <div id="modelList">
                        <div style="padding:12px 14px;font-size:12.5px;color:var(--text-3)">Loading models‚Ä¶</div>
                    </div>
                </div>
            </div>

            <div class="action-chips">
                <button class="action-chip" data-prompt="Help me write ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    Write
                </button>
                <button class="action-chip" data-prompt="Help me code ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                    Code
                </button>
                <button class="action-chip" data-prompt="Explain this concept: ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    Explain
                </button>
                <button class="action-chip" data-prompt="Summarize the following: ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h7v-2H3v2zM18 7l-1.41 1.41L18.17 10H16v2h2.17l-1.59 1.59L18 15l4-4z"/></svg>
                    Summarize
                </button>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chatContainer">
            <div class="chat-messages" id="chatMessages">

                <!-- Typing indicator -->
                <div class="typing-row" id="typingRow">
                    <div class="msg-avatar" style="background:var(--bg-3);border:1px solid var(--border)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                    </div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

            </div>

            <!-- Input bar -->
            <div class="chat-input-bar">
                <div class="chat-input-inner">
                    <textarea class="chat-textarea" id="chatInput" placeholder="Message Claude‚Ä¶" rows="1"></textarea>
                    <div class="chat-actions">
                        <button class="stop-btn" id="stopBtn" title="Stop generation">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                        </button>
                        <button class="chat-send-btn" id="chatSendBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="chat-bottom-row">
                    <button class="chat-model-pill" id="chatModelPill">
                        <div class="dot" style="width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 2s infinite"></div>
                        <span id="chatModelName">‚Ä¶</span>
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                    </button>
                    <span class="chat-hint">Enter to send ¬∑ Shift+Enter for newline</span>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- Toast stack -->
<div class="toast-stack" id="toastStack"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
    models: [],
    currentModel: null,
    chatHistory: [],
    isStreaming: false,
    stopRequested: false,
    conversations: [],
    activeConvId: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    setGreeting();
    bindEvents();
    loadModels();
    checkAuth();
    document.getElementById('welcomeInput').focus();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GREETING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setGreeting() {
    const h = new Date().getHours();
    const period = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
    const icons  = { morning: 'üå§Ô∏è', afternoon: '‚òÄÔ∏è', evening: 'üåô' };
    document.getElementById('greetTime').textContent = `${icons[period]} Good ${period}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Check if user is already authenticated
function checkAuth() {
    if (puter.auth.isSignedIn()) {
        document.getElementById('authBanner').style.display = 'none';
    }
}

// Handle Auth Button Click
// NOTE: Do NOT use async/await here. We want to trigger the popup
// and let the SDK handle the flow without blocking.
function handleAuth() {
    const btn = document.getElementById('authBtn');
    btn.textContent = 'Signing in‚Ä¶';
    btn.disabled = true;

    // puter.auth.signIn returns a promise, but we don't want to block the UI
    // or prevent the popup from opening.
    puter.auth.signIn().then(user => {
        console.log('User signed in:', user);
        document.getElementById('authBanner').style.display = 'none';
        toast('Authenticated successfully ‚úì', 'success');
        loadModels(); // Reload models just in case
    }).catch(err => {
        console.error('Auth error:', err);
        // Only show error if it's a real error, not just closing the popup
        if (err && !err.message.includes('closed')) {
            toast('Authentication failed. Please try again.', 'error');
        }
        btn.textContent = 'Authenticate';
        btn.disabled = false;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODEL LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadModels() {
    try {
        if (typeof puter === 'undefined' || !puter.ai) throw new Error('Puter not loaded');
        const raw = await puter.ai.listModels();
        if (!raw?.length) throw new Error('No models returned');

        state.models = raw;
        // Prefer claude-3-5-sonnet or first available
        const preferred = raw.find(m => m.id.includes('claude-3-5-sonnet')) || raw[0];
        state.currentModel = preferred.id;

        buildModelDropdown();
        updateModelPills();
        console.log('‚úÖ Models loaded:', state.models.length);
    } catch (err) {
        console.error('‚ùå loadModels:', err);
        document.getElementById('welcomeModelName').textContent = 'Error loading models';
        document.getElementById('chatModelName').textContent = 'Error';
    }
}

function buildModelDropdown() {
    const list = document.getElementById('modelList');
    list.innerHTML = '';
    state.models.forEach(m => {
        const div = document.createElement('div');
        div.className = 'model-option' + (m.id === state.currentModel ? ' selected' : '');
        div.dataset.id = m.id;
        div.innerHTML = `<div class="model-dot"></div><span>${m.name || m.id}</span>`;
        div.addEventListener('click', () => selectModel(m.id));
        list.appendChild(div);
    });
}

function selectModel(id) {
    state.currentModel = id;
    updateModelPills();
    buildModelDropdown();
    closeDropdown();
    toast(`Model: ${getModelLabel()}`, 'success');
}

function getModelLabel() {
    const m = state.models.find(x => x.id === state.currentModel);
    return m ? (m.name || m.id) : (state.currentModel || '‚Ä¶');
}

function updateModelPills() {
    const label = getModelLabel();
    document.getElementById('welcomeModelName').textContent = label;
    document.getElementById('chatModelName').textContent = label;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DROPDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeDropdown() {
    document.getElementById('modelDropdown').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EVENT BINDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindEvents() {
    // Send buttons
    document.getElementById('welcomeSendBtn').addEventListener('click', handleWelcomeSend);
    document.getElementById('chatSendBtn').addEventListener('click', handleChatSend);
    document.getElementById('stopBtn').addEventListener('click', stopStreaming);

    // New chat
    document.getElementById('newChatBtn').addEventListener('click', startNewChat);

    // Auth button
    document.getElementById('authBtn').addEventListener('click', handleAuth);

    // Textareas
    ['welcomeInput', 'chatInput'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => autoResize(el));
        el.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                id === 'welcomeInput' ? handleWelcomeSend() : handleChatSend();
            }
        });
    });

    // Action chips
    document.querySelectorAll('.action-chip').forEach(btn => {
        btn.addEventListener('click', () => {
            const p = btn.dataset.prompt;
            const inp = document.getElementById('welcomeInput');
            inp.value = p;
            inp.focus();
            autoResize(inp);
            // move cursor to end
            inp.setSelectionRange(inp.value.length, inp.value.length);
        });
    });

    // Model dropdown toggle
    document.getElementById('welcomeModelPill').addEventListener('click', e => {
        e.stopPropagation();
        const dd = document.getElementById('modelDropdown');
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });

    // Chat model pill opens dropdown near input
    document.getElementById('chatModelPill').addEventListener('click', e => {
        e.stopPropagation();
        const dd = document.getElementById('modelDropdown');
        // Re-attach to chat bottom
        const wrap = document.getElementById('chatModelPill').parentElement;
        dd.style.bottom = '100%';
        dd.style.left = '0';
        dd.style.transform = 'none';
        wrap.style.position = 'relative';
        wrap.appendChild(dd);
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });

    // Close dropdown on outside click
    document.addEventListener('click', () => closeDropdown());

    // Model dropdowns shouldn't close when clicking inside them
    document.getElementById('modelDropdown').addEventListener('click', e => e.stopPropagation());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEND MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleWelcomeSend() {
    const inp = document.getElementById('welcomeInput');
    const msg = inp.value.trim();
    if (!msg || state.isStreaming) return;
    inp.value = '';
    autoResize(inp);
    newConversation(msg);
    showChat();
    sendMessage(msg);
}

function handleChatSend() {
    const inp = document.getElementById('chatInput');
    const msg = inp.value.trim();
    if (!msg || state.isStreaming) return;
    inp.value = '';
    autoResize(inp);
    sendMessage(msg);
}

function stopStreaming() {
    state.stopRequested = true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CORE SEND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMessage(message) {
    if (state.isStreaming) return;

    appendMessage(message, 'user');
    state.chatHistory.push({ role: 'user', content: message });

    showTyping(true);
    setInputEnabled(false);
    state.isStreaming = true;
    state.stopRequested = false;
    document.getElementById('stopBtn').classList.add('visible');

    try {
        if (typeof puter === 'undefined') throw new Error('Puter.js not loaded');

        // This call will automatically use the session from the Auth button
        const response = await puter.ai.chat(state.chatHistory, {
            model: state.currentModel,
            stream: true,
        });

        if (response?.success === false) throw new Error('API returned failure');

        const { contentEl } = appendMessage('', 'assistant');
        showTyping(false);
        let full = '';

        for await (const chunk of response) {
            if (state.stopRequested) break;
            if (chunk?.text) {
                full += chunk.text;
                renderMarkdown(full, contentEl);
                scrollBottom();
            }
        }

        renderMarkdown(full, contentEl); // Final render
        state.chatHistory.push({ role: 'assistant', content: full });
        saveConversation();

    } catch (err) {
        showTyping(false);
        console.error('sendMessage error:', err);
        
        // Check if it's an auth error
        const isAuthErr = /auth|authenticate|login|session|not signed/i.test(err.message || '');
        
        const errMsg = isAuthErr
            ? '‚ö†Ô∏è Please click the "Authenticate" button to log in.'
            : `Error: ${err.message}`;
            
        appendMessage(errMsg, 'assistant', true);
        
        // Show banner if auth error
        if (isAuthErr) {
            document.getElementById('authBanner').style.display = 'flex';
        }

        // Remove the failed user message from history
        if (state.chatHistory.at(-1)?.role === 'user') state.chatHistory.pop();
    } finally {
        state.isStreaming = false;
        state.stopRequested = false;
        document.getElementById('stopBtn').classList.remove('visible');
        setInputEnabled(true);
        document.getElementById('chatInput').focus();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONVERSATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function newConversation(firstMsg) {
    state.activeConvId = `c_${Date.now()}`;
    const title = firstMsg.length > 48 ? firstMsg.slice(0, 48) + '‚Ä¶' : firstMsg;
    state.conversations.unshift({ id: state.activeConvId, title, messages: [] });
    if (state.conversations.length > 20) state.conversations = state.conversations.slice(0, 20);
    renderSidebar();
}

function saveConversation() {
    const conv = state.conversations.find(c => c.id === state.activeConvId);
    if (conv) {
        conv.messages = [...state.chatHistory];
        renderSidebar();
    }
}

function renderSidebar() {
    const list = document.getElementById('recentList');
    const empty = document.getElementById('emptyNote');
    if (!state.conversations.length) {
        empty?.remove();
        list.innerHTML = '<div class="empty-note">No recent chats</div>';
        return;
    }
    list.innerHTML = '';
    state.conversations.forEach(conv => {
        const div = document.createElement('div');
        div.className = 'recent-item' + (conv.id === state.activeConvId ? ' active' : '');
        div.textContent = conv.title;
        div.title = conv.title;
        div.addEventListener('click', () => loadConversation(conv.id));
        list.appendChild(div);
    });
}

function loadConversation(id) {
    const conv = state.conversations.find(c => c.id === id);
    if (!conv) return;
    state.activeConvId = id;
    state.chatHistory = [...conv.messages];
    showChat();
    const msgs = document.getElementById('chatMessages');
    // Clear all messages except typing row
    Array.from(msgs.querySelectorAll('.msg-row')).forEach(r => r.remove());
    conv.messages.forEach(m => appendMessage(m.content, m.role));
    renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIEW SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showChat() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('chatContainer').classList.add('active');
}

function startNewChat() {
    state.chatHistory = [];
    state.activeConvId = null;
    document.getElementById('chatMessages').querySelectorAll('.msg-row').forEach(r => r.remove());
    document.getElementById('chatContainer').classList.remove('active');
    document.getElementById('welcomeScreen').style.display = '';
    document.getElementById('welcomeInput').value = '';
    autoResize(document.getElementById('welcomeInput'));
    document.getElementById('welcomeInput').focus();
    renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function appendMessage(content, role, isError = false) {
    const msgs = document.getElementById('chatMessages');
    const typing = document.getElementById('typingRow');

    const row = document.createElement('div');
    row.className = `msg-row ${role}`;

    const avatar = document.createElement('div');
    avatar.className = 'msg-avatar';
    avatar.textContent = role === 'user' ? 'H' : '‚ú¶';

    const body = document.createElement('div');
    body.className = 'msg-body';

    if (role === 'user') {
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = content;
        body.appendChild(bubble);
    } else {
        body.className += ' msg-md';
        if (isError) body.style.color = 'var(--red)';
        renderMarkdown(content, body);
    }

    row.appendChild(avatar);
    row.appendChild(body);

    // Insert before typing indicator
    msgs.insertBefore(row, typing);
    scrollBottom();

    return { row, contentEl: body };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MARKDOWN RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkdown(raw, container) {
    container.innerHTML = '';
    if (!raw) return;

    // Split on fenced code blocks
    const codeRe = /```(\w*)\n?([\s\S]*?)```/g;
    let last = 0, match;

    while ((match = codeRe.exec(raw)) !== null) {
        if (match.index > last) {
            const textNode = document.createElement('div');
            textNode.innerHTML = parseInlineMarkdown(raw.slice(last, match.index));
            container.appendChild(textNode);
        }
        container.appendChild(buildArtifact(match[2].trim(), match[1] || 'text'));
        last = match.index + match[0].length;
    }

    if (last < raw.length) {
        const textNode = document.createElement('div');
        textNode.innerHTML = parseInlineMarkdown(raw.slice(last));
        container.appendChild(textNode);
    }

    // Syntax highlight
    container.querySelectorAll('pre code').forEach(el => {
        if (el.dataset.highlighted) return;
        hljs.highlightElement(el);
    });
}

/**
 * Convert markdown text (no code blocks) to HTML.
 */
function parseInlineMarkdown(text) {
    const lines = text.split('\n');
    let html = '';
    let inList = null; // 'ul' | 'ol' | null
    let inTable = false;
    let tableHeaderDone = false;

    const closeList = () => {
        if (inList) { html += `</${inList}>`; inList = null; }
    };
    const closeTable = () => {
        if (inTable) { html += `</tbody></table>`; inTable = false; tableHeaderDone = false; }
    };

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // Horizontal rule
        if (/^[-*_]{3,}\s*$/.test(line)) { closeList(); closeTable(); html += '<hr>'; continue; }

        // Headings
        const headingMatch = line.match(/^(#{1,4})\s+(.+)$/);
        if (headingMatch) {
            closeList(); closeTable();
            const level = headingMatch[1].length;
            html += `<h${level}>${inline(headingMatch[2])}</h${level}>`;
            continue;
        }

        // Blockquote
        if (line.startsWith('> ')) {
            closeList(); closeTable();
            html += `<blockquote>${inline(line.slice(2))}</blockquote>`;
            continue;
        }

        // Table row
        if (line.includes('|')) {
            const cells = line.split('|').map(c => c.trim()).filter(Boolean);
            if (cells.length > 1) {
                closeList();
                // Separator row?
                if (cells.every(c => /^[-:]+$/.test(c))) {
                    tableHeaderDone = true;
                    html += '<thead-done>';
                    continue;
                }
                if (!inTable) {
                    html += '<table><thead><tr>' + cells.map(c => `<th>${inline(c)}</th>`).join('') + '</tr></thead><tbody>';
                    inTable = true;
                } else {
                    html += '<tr>' + cells.map(c => `<td>${inline(c)}</td>`).join('') + '</tr>';
                }
                continue;
            }
        }
        closeTable();

        // Unordered list
        const ulMatch = line.match(/^(\s*)[-*+]\s+(.+)$/);
        if (ulMatch) {
            if (inList !== 'ul') { closeList(); html += '<ul>'; inList = 'ul'; }
            html += `<li>${inline(ulMatch[2])}</li>`;
            continue;
        }

        // Ordered list
        const olMatch = line.match(/^(\s*)\d+\.\s+(.+)$/);
        if (olMatch) {
            if (inList !== 'ol') { closeList(); html += '<ol>'; inList = 'ol'; }
            html += `<li>${inline(olMatch[2])}</li>`;
            continue;
        }

        closeList();

        // Empty line ‚Üí paragraph break
        if (line.trim() === '') { html += '<br>'; continue; }

        // Regular paragraph line
        html += `<p>${inline(line)}</p>`;
    }
    closeList(); closeTable();

    // Clean up table head sentinel
    html = html.replace(/<thead-done>/g, '');
    return html;
}

function inline(text) {
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/__(.+?)__/g, '<strong>$1</strong>')
        .replace(/_(.+?)_/g, '<em>$1</em>')
        .replace(/~~(.+?)~~/g, '<del>$1</del>')
        .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARTIFACT / CODE BLOCK BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildArtifact(code, lang) {
    const wrap = document.createElement('div');
    wrap.className = 'artifact';

    const head = document.createElement('div');
    head.className = 'artifact-head';

    const langLabel = document.createElement('span');
    langLabel.className = 'artifact-lang';
    langLabel.textContent = lang === 'text' ? 'plaintext' : lang;
    head.appendChild(langLabel);

    const btns = document.createElement('div');
    btns.className = 'artifact-btns';

    // Preview for HTML
    if (lang.toLowerCase() === 'html') {
        const prevBtn = buildArtifactBtn('Preview', 'preview', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5z"/></svg>`);
        prevBtn.addEventListener('click', () => {
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const w = window.open(url, '_blank');
            // Revoke after tab opens
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        });
        btns.appendChild(prevBtn);
    }

    // Copy
    const copyBtn = buildArtifactBtn('Copy', '', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2z"/></svg>`);
    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(code).then(() => {
            copyBtn.classList.add('copied');
            copyBtn.querySelector('span').textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.classList.remove('copied');
                copyBtn.querySelector('span').textContent = 'Copy';
            }, 2000);
        });
    });
    btns.appendChild(copyBtn);

    // Download
    const extMap = { javascript: 'js', js: 'js', python: 'py', py: 'py', html: 'html', css: 'css', json: 'json', typescript: 'ts', ts: 'ts', bash: 'sh', shell: 'sh', sql: 'sql' };
    const ext = extMap[lang.toLowerCase()] || 'txt';
    const dlBtn = buildArtifactBtn('Download', '', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>`);
    dlBtn.addEventListener('click', () => {
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `code.${ext}`; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    });
    btns.appendChild(dlBtn);

    head.appendChild(btns);

    const body = document.createElement('div');
    body.className = 'artifact-body';
    const pre = document.createElement('pre');
    const codeEl = document.createElement('code');
    if (lang && lang !== 'text') codeEl.className = `language-${lang}`;
    codeEl.textContent = code;
    pre.appendChild(codeEl);
    body.appendChild(pre);

    wrap.appendChild(head);
    wrap.appendChild(body);

    // Highlight after DOM insertion (deferred)
    requestAnimationFrame(() => {
        if (lang && lang !== 'text' && !codeEl.dataset.highlighted) {
            hljs.highlightElement(codeEl);
        }
    });

    return wrap;
}

function buildArtifactBtn(label, extraClass, iconSvg) {
    const btn = document.createElement('button');
    btn.className = 'artifact-action' + (extraClass ? ' ' + extraClass : '');
    btn.innerHTML = iconSvg + `<span>${label}</span>`;
    return btn;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTyping(show) {
    document.getElementById('typingRow').classList.toggle('visible', show);
    if (show) scrollBottom();
}

function setInputEnabled(enabled) {
    ['chatInput', 'chatSendBtn', 'welcomeInput', 'welcomeSendBtn'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = !enabled; el.style.opacity = enabled ? '' : '0.5'; }
    });
}

function scrollBottom() {
    const msgs = document.getElementById('chatMessages');
    requestAnimationFrame(() => { msgs.scrollTop = msgs.scrollHeight; });
}

function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 180) + 'px';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = '') {
    const stack = document.getElementById('toastStack');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    stack.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}
</script>
</body>
</html>
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 15px;
            line-height: 1.6;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-3); }

        /* ===== LAYOUT ===== */
        .app { display: flex; height: 100vh; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 260px;
            min-width: 260px;
            background: var(--bg-2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .sidebar-header {
            padding: 18px 16px 14px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 9px;
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 14px;
            letter-spacing: -0.3px;
        }

        .logo-icon {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(249,115,22,0.35);
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 9px 12px;
            background: var(--accent-l);
            border: 1px solid rgba(249,115,22,0.25);
            border-radius: var(--radius);
            color: var(--accent);
            font-size: 13.5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
        }
        .new-chat-btn:hover {
            background: rgba(249,115,22,0.2);
            border-color: rgba(249,115,22,0.4);
        }

        .sidebar-body { flex: 1; padding: 14px 12px; overflow-y: auto; }

        .section-label {
            font-size: 10.5px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: var(--text-3);
            padding: 0 4px;
            margin-bottom: 8px;
        }

        .recent-item {
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .recent-item:hover { background: var(--bg-3); color: var(--text); }
        .recent-item.active { background: var(--accent-l); color: var(--accent); }

        .empty-note {
            padding: 8px 4px;
            font-size: 12.5px;
            color: var(--text-3);
            font-style: italic;
        }

        .sidebar-footer {
            padding: 12px 14px;
            border-top: 1px solid var(--border);
        }

        .user-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 9px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .user-row:hover { background: var(--bg-3); }

        .user-avatar {
            width: 30px; height: 30px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .user-name { font-size: 13.5px; font-weight: 500; color: var(--text); }
        .user-plan { font-size: 11.5px; color: var(--text-3); }

        /* ===== MAIN ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        /* ===== WELCOME SCREEN ===== */
        #welcomeScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            gap: 28px;
            animation: fadeUp 0.4s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .greeting-block { text-align: center; }
        .greeting-time { font-size: 13px; color: var(--text-3); margin-bottom: 6px; letter-spacing: 0.5px; }
        .greeting-main {
            font-size: 34px;
            font-weight: 300;
            color: var(--text);
            letter-spacing: -1px;
            line-height: 1.15;
        }
        .greeting-main span { color: var(--accent); font-weight: 600; }

        .welcome-input-wrap {
            width: 100%;
            max-width: 620px;
            position: relative;
        }

        .welcome-textarea {
            width: 100%;
            padding: 16px 56px 16px 18px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            resize: none;
            min-height: 54px;
            max-height: 180px;
            transition: border-color 0.2s, box-shadow 0.2s;
            line-height: 1.5;
        }
        .welcome-textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.12);
        }
        .welcome-textarea::placeholder { color: var(--text-3); }

        .send-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            width: 34px; height: 34px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.18s, transform 0.12s;
        }
        .send-btn:hover:not(:disabled) { background: var(--accent-h); transform: scale(1.05); }
        .send-btn:disabled { background: var(--bg-4); cursor: not-allowed; opacity: 0.5; }

        /* model pill */
        .model-pill-wrap { position: relative; display: inline-block; }

        .model-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: 99px;
            font-size: 12.5px;
            color: var(--text-2);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.18s;
        }
        .model-pill:hover { border-color: var(--accent); color: var(--accent); }
        .model-pill .dot {
            width: 6px; height: 6px;
            background: var(--green);
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* model dropdown */
        .model-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            min-width: 260px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            z-index: 100;
            overflow: hidden;
            animation: dropIn 0.18s ease;
        }
        @keyframes dropIn {
            from { opacity: 0; transform: translateX(-50%) translateY(6px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .model-dropdown-header {
            padding: 10px 14px 8px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.7px;
            text-transform: uppercase;
            color: var(--text-3);
            border-bottom: 1px solid var(--border);
        }

        .model-option {
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer;
            transition: background 0.14s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .model-option:hover { background: var(--bg-4); color: var(--text); }
        .model-option.selected { color: var(--accent); font-weight: 500; }
        .model-option .model-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--border-2);
            flex-shrink: 0;
        }
        .model-option.selected .model-dot { background: var(--accent); }

        .action-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-chip {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 10px 18px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 99px;
            color: var(--text-2);
            font-size: 13.5px;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
        }
        .action-chip:hover {
            background: var(--bg-3);
            border-color: var(--border-2);
            color: var(--text);
            transform: translateY(-1px);
        }

        /* ===== CHAT ===== */
        #chatContainer {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        #chatContainer.active { display: flex; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px 0;
            scroll-behavior: smooth;
        }

        .msg-row {
            display: flex;
            gap: 14px;
            padding: 4px 24px;
            max-width: 860px;
            margin: 0 auto;
            width: 100%;
            animation: msgIn 0.22s ease;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .msg-row.user { flex-direction: row-reverse; }

        .msg-avatar {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .msg-row.user .msg-avatar {
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            color: white;
        }
        .msg-row.assistant .msg-avatar {
            background: var(--bg-3);
            border: 1px solid var(--border);
            color: var(--text-2);
        }

        .msg-body { flex: 1; min-width: 0; }

        .msg-bubble {
            display: inline-block;
            max-width: 78%;
            padding: 12px 16px;
            background: var(--bg-3);
            border: 1px solid var(--border);
            border-radius: 14px 14px 14px 4px;
            line-height: 1.65;
            word-break: break-word;
        }
        .msg-row.user .msg-bubble {
            background: linear-gradient(135deg, var(--accent), #ea6a0e);
            border-color: transparent;
            border-radius: 14px 14px 4px 14px;
            color: white;
            float: right;
        }
        .msg-row.assistant .msg-body { padding-right: 40px; }

        /* markdown styles inside assistant bubbles */
        .msg-md h1, .msg-md h2, .msg-md h3, .msg-md h4 {
            font-weight: 600;
            margin: 14px 0 6px;
            letter-spacing: -0.3px;
            line-height: 1.3;
        }
        .msg-md h1 { font-size: 20px; }
        .msg-md h2 { font-size: 17px; }
        .msg-md h3 { font-size: 15px; }
        .msg-md p { margin-bottom: 10px; }
        .msg-md p:last-child { margin-bottom: 0; }
        .msg-md ul, .msg-md ol { padding-left: 20px; margin-bottom: 10px; }
        .msg-md li { margin-bottom: 4px; }
        .msg-md strong { font-weight: 600; color: var(--text); }
        .msg-md em { font-style: italic; opacity: 0.9; }
        .msg-md a { color: var(--blue); text-decoration: none; border-bottom: 1px solid rgba(96,165,250,0.3); }
        .msg-md a:hover { border-color: var(--blue); }
        .msg-md hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
        .msg-md blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            color: var(--text-2);
            margin: 10px 0;
        }
        .msg-md code:not(pre code) {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            background: var(--bg-4);
            border: 1px solid var(--border-2);
            padding: 1px 6px;
            border-radius: 4px;
            color: var(--accent);
        }
        .msg-md table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13.5px; }
        .msg-md th, .msg-md td { padding: 7px 12px; border: 1px solid var(--border-2); text-align: left; }
        .msg-md th { background: var(--bg-4); font-weight: 600; }

        /* artifact / code block */
        .artifact {
            margin: 10px 0;
            border: 1px solid var(--border-2);
            border-radius: var(--radius);
            overflow: hidden;
            background: #0e0e10;
        }
        .artifact-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-3);
            border-bottom: 1px solid var(--border);
        }
        .artifact-lang {
            font-size: 11.5px;
            font-weight: 500;
            color: var(--text-3);
            font-family: 'JetBrains Mono', monospace;
            text-transform: lowercase;
        }
        .artifact-btns { display: flex; gap: 6px; }
        .artifact-action {
            padding: 3px 10px;
            font-size: 11.5px;
            background: none;
            border: 1px solid var(--border-2);
            border-radius: 5px;
            color: var(--text-3);
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .artifact-action:hover { background: var(--bg-4); color: var(--text); border-color: var(--border-2); }
        .artifact-action.preview { border-color: rgba(96,165,250,0.35); color: var(--blue); }
        .artifact-action.preview:hover { background: rgba(96,165,250,0.1); }
        .artifact-action.copied { border-color: rgba(52,211,153,0.35); color: var(--green); }
        .artifact-body { overflow-x: auto; max-height: 480px; }
        .artifact-body pre { margin: 0 !important; border-radius: 0 !important; }
        .artifact-body pre code.hljs { padding: 14px 16px; font-size: 13px; font-family: 'JetBrains Mono', monospace; background: #0e0e10 !important; }

        /* typing indicator */
        .typing-row {
            display: none;
            gap: 14px;
            padding: 4px 24px;
            max-width: 860px;
            margin: 0 auto;
            width: 100%;
        }
        .typing-row.visible { display: flex; }
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 14px 16px;
        }
        .typing-dot {
            width: 7px; height: 7px;
            background: var(--text-3);
            border-radius: 50%;
            animation: typeBounce 1.3s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.18s; }
        .typing-dot:nth-child(3) { animation-delay: 0.36s; }
        @keyframes typeBounce {
            0%, 70%, 100% { transform: translateY(0); opacity: 0.4; }
            35% { transform: translateY(-5px); opacity: 1; }
        }

        /* chat input bar */
        .chat-input-bar {
            padding: 12px 20px 16px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }
        .chat-input-inner {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 820px;
            margin: 0 auto;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            padding: 8px 10px 8px 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-input-inner:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
        }

        .chat-textarea {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 14.5px;
            font-family: inherit;
            resize: none;
            max-height: 160px;
            line-height: 1.55;
            padding: 4px 0;
        }
        .chat-textarea::placeholder { color: var(--text-3); }

        .chat-actions { display: flex; align-items: center; gap: 6px; }

        .stop-btn {
            width: 30px; height: 30px;
            background: none;
            border: 1px solid var(--red);
            border-radius: 7px;
            color: var(--red);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .stop-btn.visible { display: flex; }
        .stop-btn:hover { background: rgba(248,113,113,0.12); }

        .chat-send-btn {
            width: 32px; height: 32px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.18s;
            flex-shrink: 0;
        }
        .chat-send-btn:hover:not(:disabled) { background: var(--accent-h); }
        .chat-send-btn:disabled { background: var(--bg-4); cursor: not-allowed; opacity: 0.4; }

        .chat-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 820px;
            margin: 6px auto 0;
            padding: 0 4px;
        }

        .chat-model-pill {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11.5px;
            color: var(--text-3);
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 99px;
            transition: all 0.15s;
            font-family: inherit;
            background: none;
            border: 1px solid transparent;
        }
        .chat-model-pill:hover { color: var(--text-2); border-color: var(--border); }
        .chat-hint { font-size: 11px; color: var(--text-3); }

        /* ===== TOAST ===== */
        .toast-stack {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        .toast {
            padding: 10px 16px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text);
            box-shadow: var(--shadow);
            animation: toastIn 0.2s ease, toastOut 0.2s ease 2.6s forwards;
        }
        .toast.success { border-color: rgba(52,211,153,0.4); }
        .toast.error   { border-color: rgba(248,113,113,0.4); }
        @keyframes toastIn  { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { to   { opacity: 0; transform: translateY(10px); } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .sidebar { display: none; }
            .greeting-main { font-size: 26px; }
            .msg-row.assistant .msg-body { padding-right: 0; }
        }
    </style>
</head>
<body>

<div class="app">

    <!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">‚ú¶</div>
                Claude
            </div>
            <button class="new-chat-btn" id="newChatBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H13v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                New conversation
            </button>
        </div>

        <div class="sidebar-body" id="sidebarBody">
            <div class="section-label">Recents</div>
            <div id="recentList">
                <div class="empty-note" id="emptyNote">No recent chats</div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-row">
                <div class="user-avatar">H</div>
                <div>
                    <div class="user-name">Hassan</div>
                    <div class="user-plan">Free via Puter.js</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
    <main class="main">

        <!-- Welcome Screen -->
        <div id="welcomeScreen">
            <div class="greeting-block">
                <div class="greeting-time" id="greetTime"></div>
                <div class="greeting-main">Hello, <span>Hassan</span> üëã</div>
            </div>

            <div class="welcome-input-wrap">
                <textarea class="welcome-textarea" id="welcomeInput" placeholder="Ask me anything‚Ä¶" rows="1"></textarea>
                <button class="send-btn" id="welcomeSendBtn" title="Send (Enter)">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>

            <!-- Model picker -->
            <div class="model-pill-wrap" id="welcomeModelWrap">
                <button class="model-pill" id="welcomeModelPill">
                    <div class="dot"></div>
                    <span id="welcomeModelName">Loading‚Ä¶</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="model-dropdown" id="modelDropdown" style="display:none">
                    <div class="model-dropdown-header">Select Model</div>
                    <div id="modelList">
                        <div style="padding:12px 14px;font-size:12.5px;color:var(--text-3)">Loading models‚Ä¶</div>
                    </div>
                </div>
            </div>

            <div class="action-chips">
                <button class="action-chip" data-prompt="Help me write ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    Write
                </button>
                <button class="action-chip" data-prompt="Help me code ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                    Code
                </button>
                <button class="action-chip" data-prompt="Explain this concept: ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    Explain
                </button>
                <button class="action-chip" data-prompt="Summarize the following: ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h7v-2H3v2zM18 7l-1.41 1.41L18.17 10H16v2h2.17l-1.59 1.59L18 15l4-4z"/></svg>
                    Summarize
                </button>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chatContainer">
            <div class="chat-messages" id="chatMessages">

                <!-- Typing indicator -->
                <div class="typing-row" id="typingRow">
                    <div class="msg-avatar" style="background:var(--bg-3);border:1px solid var(--border)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                    </div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

            </div>

            <!-- Input bar -->
            <div class="chat-input-bar">
                <div class="chat-input-inner">
                    <textarea class="chat-textarea" id="chatInput" placeholder="Message Claude‚Ä¶" rows="1"></textarea>
                    <div class="chat-actions">
                        <button class="stop-btn" id="stopBtn" title="Stop generation">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                        </button>
                        <button class="chat-send-btn" id="chatSendBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="chat-bottom-row">
                    <button class="chat-model-pill" id="chatModelPill">
                        <div class="dot" style="width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 2s infinite"></div>
                        <span id="chatModelName">‚Ä¶</span>
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                    </button>
                    <span class="chat-hint">Enter to send ¬∑ Shift+Enter for newline</span>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- Toast stack -->
<div class="toast-stack" id="toastStack"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
    models: [],
    currentModel: null,
    chatHistory: [],
    isStreaming: false,
    stopRequested: false,
    conversations: [],
    activeConvId: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    setGreeting();
    bindEvents();
    loadModels();
    document.getElementById('welcomeInput').focus();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GREETING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setGreeting() {
    const h = new Date().getHours();
    const period = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
    const icons  = { morning: 'üå§Ô∏è', afternoon: '‚òÄÔ∏è', evening: 'üåô' };
    document.getElementById('greetTime').textContent = `${icons[period]} Good ${period}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODEL LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadModels() {
    try {
        if (typeof puter === 'undefined' || !puter.ai) throw new Error('Puter not loaded');
        const raw = await puter.ai.listModels();
        if (!raw?.length) throw new Error('No models returned');

        state.models = raw;
        // Prefer claude-3-5-sonnet or first available
        const preferred = raw.find(m => m.id.includes('claude-3-5-sonnet')) || raw[0];
        state.currentModel = preferred.id;

        buildModelDropdown();
        updateModelPills();
        console.log('‚úÖ Models loaded:', state.models.length);
    } catch (err) {
        console.error('‚ùå loadModels:', err);
        document.getElementById('welcomeModelName').textContent = 'Error loading models';
        document.getElementById('chatModelName').textContent = 'Error';
    }
}

function buildModelDropdown() {
    const list = document.getElementById('modelList');
    list.innerHTML = '';
    state.models.forEach(m => {
        const div = document.createElement('div');
        div.className = 'model-option' + (m.id === state.currentModel ? ' selected' : '');
        div.dataset.id = m.id;
        div.innerHTML = `<div class="model-dot"></div><span>${m.name || m.id}</span>`;
        div.addEventListener('click', () => selectModel(m.id));
        list.appendChild(div);
    });
}

function selectModel(id) {
    state.currentModel = id;
    updateModelPills();
    buildModelDropdown();
    closeDropdown();
    toast(`Model: ${getModelLabel()}`, 'success');
}

function getModelLabel() {
    const m = state.models.find(x => x.id === state.currentModel);
    return m ? (m.name || m.id) : (state.currentModel || '‚Ä¶');
}

function updateModelPills() {
    const label = getModelLabel();
    document.getElementById('welcomeModelName').textContent = label;
    document.getElementById('chatModelName').textContent = label;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DROPDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeDropdown() {
    document.getElementById('modelDropdown').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EVENT BINDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindEvents() {
    // Send buttons
    document.getElementById('welcomeSendBtn').addEventListener('click', handleWelcomeSend);
    document.getElementById('chatSendBtn').addEventListener('click', handleChatSend);
    document.getElementById('stopBtn').addEventListener('click', stopStreaming);

    // New chat
    document.getElementById('newChatBtn').addEventListener('click', startNewChat);

    // Textareas
    ['welcomeInput', 'chatInput'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => autoResize(el));
        el.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                id === 'welcomeInput' ? handleWelcomeSend() : handleChatSend();
            }
        });
    });

    // Action chips
    document.querySelectorAll('.action-chip').forEach(btn => {
        btn.addEventListener('click', () => {
            const p = btn.dataset.prompt;
            const inp = document.getElementById('welcomeInput');
            inp.value = p;
            inp.focus();
            autoResize(inp);
            // move cursor to end
            inp.setSelectionRange(inp.value.length, inp.value.length);
        });
    });

    // Model dropdown toggle
    document.getElementById('welcomeModelPill').addEventListener('click', e => {
        e.stopPropagation();
        const dd = document.getElementById('modelDropdown');
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });

    // Chat model pill opens dropdown near input
    document.getElementById('chatModelPill').addEventListener('click', e => {
        e.stopPropagation();
        const dd = document.getElementById('modelDropdown');
        // Re-attach to chat bottom
        const wrap = document.getElementById('chatModelPill').parentElement;
        dd.style.bottom = '100%';
        dd.style.left = '0';
        dd.style.transform = 'none';
        wrap.style.position = 'relative';
        wrap.appendChild(dd);
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });

    // Close dropdown on outside click
    document.addEventListener('click', () => closeDropdown());

    // Model dropdowns shouldn't close when clicking inside them
    document.getElementById('modelDropdown').addEventListener('click', e => e.stopPropagation());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEND MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleWelcomeSend() {
    const inp = document.getElementById('welcomeInput');
    const msg = inp.value.trim();
    if (!msg || state.isStreaming) return;
    inp.value = '';
    autoResize(inp);
    newConversation(msg);
    showChat();
    sendMessage(msg);
}

function handleChatSend() {
    const inp = document.getElementById('chatInput');
    const msg = inp.value.trim();
    if (!msg || state.isStreaming) return;
    inp.value = '';
    autoResize(inp);
    sendMessage(msg);
}

function stopStreaming() {
    state.stopRequested = true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CORE SEND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMessage(message) {
    if (state.isStreaming) return;

    appendMessage(message, 'user');
    state.chatHistory.push({ role: 'user', content: message });

    showTyping(true);
    setInputEnabled(false);
    state.isStreaming = true;
    state.stopRequested = false;
    document.getElementById('stopBtn').classList.add('visible');

    try {
        if (typeof puter === 'undefined') throw new Error('Puter.js not loaded');

        // Authentication is handled automatically by puter.ai.chat
        // If the user is not authenticated, it will trigger a login popup.
        const response = await puter.ai.chat(state.chatHistory, {
            model: state.currentModel,
            stream: true,
        });

        if (response?.success === false) throw new Error('API returned failure');

        const { contentEl } = appendMessage('', 'assistant');
        showTyping(false);
        let full = '';

        for await (const chunk of response) {
            if (state.stopRequested) break;
            if (chunk?.text) {
                full += chunk.text;
                renderMarkdown(full, contentEl);
                scrollBottom();
            }
        }

        renderMarkdown(full, contentEl); // Final render
        state.chatHistory.push({ role: 'assistant', content: full });
        saveConversation();

    } catch (err) {
        showTyping(false);
        console.error('sendMessage error:', err);
        
        // Check if it's an auth error or if puter needs interaction
        const isAuthErr = /auth|authenticate|login|session/i.test(err.message || '');
        
        const errMsg = isAuthErr
            ? '‚ö†Ô∏è Please wait for the login window to appear, or check if popups are blocked.'
            : `Error: ${err.message}`;
            
        appendMessage(errMsg, 'assistant', true);

        // Remove the failed user message from history so they can retry
        if (state.chatHistory.at(-1)?.role === 'user') state.chatHistory.pop();
    } finally {
        state.isStreaming = false;
        state.stopRequested = false;
        document.getElementById('stopBtn').classList.remove('visible');
        setInputEnabled(true);
        document.getElementById('chatInput').focus();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONVERSATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function newConversation(firstMsg) {
    state.activeConvId = `c_${Date.now()}`;
    const title = firstMsg.length > 48 ? firstMsg.slice(0, 48) + '‚Ä¶' : firstMsg;
    state.conversations.unshift({ id: state.activeConvId, title, messages: [] });
    if (state.conversations.length > 20) state.conversations = state.conversations.slice(0, 20);
    renderSidebar();
}

function saveConversation() {
    const conv = state.conversations.find(c => c.id === state.activeConvId);
    if (conv) {
        conv.messages = [...state.chatHistory];
        renderSidebar();
    }
}

function renderSidebar() {
    const list = document.getElementById('recentList');
    const empty = document.getElementById('emptyNote');
    if (!state.conversations.length) {
        empty?.remove();
        list.innerHTML = '<div class="empty-note">No recent chats</div>';
        return;
    }
    list.innerHTML = '';
    state.conversations.forEach(conv => {
        const div = document.createElement('div');
        div.className = 'recent-item' + (conv.id === state.activeConvId ? ' active' : '');
        div.textContent = conv.title;
        div.title = conv.title;
        div.addEventListener('click', () => loadConversation(conv.id));
        list.appendChild(div);
    });
}

function loadConversation(id) {
    const conv = state.conversations.find(c => c.id === id);
    if (!conv) return;
    state.activeConvId = id;
    state.chatHistory = [...conv.messages];
    showChat();
    const msgs = document.getElementById('chatMessages');
    // Clear all messages except typing row
    Array.from(msgs.querySelectorAll('.msg-row')).forEach(r => r.remove());
    conv.messages.forEach(m => appendMessage(m.content, m.role));
    renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIEW SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showChat() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('chatContainer').classList.add('active');
}

function startNewChat() {
    state.chatHistory = [];
    state.activeConvId = null;
    document.getElementById('chatMessages').querySelectorAll('.msg-row').forEach(r => r.remove());
    document.getElementById('chatContainer').classList.remove('active');
    document.getElementById('welcomeScreen').style.display = '';
    document.getElementById('welcomeInput').value = '';
    autoResize(document.getElementById('welcomeInput'));
    document.getElementById('welcomeInput').focus();
    renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function appendMessage(content, role, isError = false) {
    const msgs = document.getElementById('chatMessages');
    const typing = document.getElementById('typingRow');

    const row = document.createElement('div');
    row.className = `msg-row ${role}`;

    const avatar = document.createElement('div');
    avatar.className = 'msg-avatar';
    avatar.textContent = role === 'user' ? 'H' : '‚ú¶';

    const body = document.createElement('div');
    body.className = 'msg-body';

    if (role === 'user') {
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = content;
        body.appendChild(bubble);
    } else {
        body.className += ' msg-md';
        if (isError) body.style.color = 'var(--red)';
        renderMarkdown(content, body);
    }

    row.appendChild(avatar);
    row.appendChild(body);

    // Insert before typing indicator
    msgs.insertBefore(row, typing);
    scrollBottom();

    return { row, contentEl: body };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MARKDOWN RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkdown(raw, container) {
    container.innerHTML = '';
    if (!raw) return;

    // Split on fenced code blocks
    const codeRe = /```(\w*)\n?([\s\S]*?)```/g;
    let last = 0, match;

    while ((match = codeRe.exec(raw)) !== null) {
        if (match.index > last) {
            const textNode = document.createElement('div');
            textNode.innerHTML = parseInlineMarkdown(raw.slice(last, match.index));
            container.appendChild(textNode);
        }
        container.appendChild(buildArtifact(match[2].trim(), match[1] || 'text'));
        last = match.index + match[0].length;
    }

    if (last < raw.length) {
        const textNode = document.createElement('div');
        textNode.innerHTML = parseInlineMarkdown(raw.slice(last));
        container.appendChild(textNode);
    }

    // Syntax highlight
    container.querySelectorAll('pre code').forEach(el => {
        if (el.dataset.highlighted) return;
        hljs.highlightElement(el);
    });
}

/**
 * Convert markdown text (no code blocks) to HTML.
 * Handles: headers, bold, italic, inline code, links, horizontal rules,
 * blockquotes, unordered/ordered lists, tables, line breaks.
 */
function parseInlineMarkdown(text) {
    const lines = text.split('\n');
    let html = '';
    let inList = null; // 'ul' | 'ol' | null
    let inTable = false;
    let tableHeaderDone = false;

    const closeList = () => {
        if (inList) { html += `</${inList}>`; inList = null; }
    };
    const closeTable = () => {
        if (inTable) { html += `</tbody></table>`; inTable = false; tableHeaderDone = false; }
    };

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // Horizontal rule
        if (/^[-*_]{3,}\s*$/.test(line)) { closeList(); closeTable(); html += '<hr>'; continue; }

        // Headings
        const headingMatch = line.match(/^(#{1,4})\s+(.+)$/);
        if (headingMatch) {
            closeList(); closeTable();
            const level = headingMatch[1].length;
            html += `<h${level}>${inline(headingMatch[2])}</h${level}>`;
            continue;
        }

        // Blockquote
        if (line.startsWith('> ')) {
            closeList(); closeTable();
            html += `<blockquote>${inline(line.slice(2))}</blockquote>`;
            continue;
        }

        // Table row
        if (line.includes('|')) {
            const cells = line.split('|').map(c => c.trim()).filter(Boolean);
            if (cells.length > 1) {
                closeList();
                // Separator row?
                if (cells.every(c => /^[-:]+$/.test(c))) {
                    tableHeaderDone = true;
                    html += '<thead-done>';
                    continue;
                }
                if (!inTable) {
                    html += '<table><thead><tr>' + cells.map(c => `<th>${inline(c)}</th>`).join('') + '</tr></thead><tbody>';
                    inTable = true;
                } else {
                    html += '<tr>' + cells.map(c => `<td>${inline(c)}</td>`).join('') + '</tr>';
                }
                continue;
            }
        }
        closeTable();

        // Unordered list
        const ulMatch = line.match(/^(\s*)[-*+]\s+(.+)$/);
        if (ulMatch) {
            if (inList !== 'ul') { closeList(); html += '<ul>'; inList = 'ul'; }
            html += `<li>${inline(ulMatch[2])}</li>`;
            continue;
        }

        // Ordered list
        const olMatch = line.match(/^(\s*)\d+\.\s+(.+)$/);
        if (olMatch) {
            if (inList !== 'ol') { closeList(); html += '<ol>'; inList = 'ol'; }
            html += `<li>${inline(olMatch[2])}</li>`;
            continue;
        }

        closeList();

        // Empty line ‚Üí paragraph break
        if (line.trim() === '') { html += '<br>'; continue; }

        // Regular paragraph line
        html += `<p>${inline(line)}</p>`;
    }
    closeList(); closeTable();

    // Clean up table head sentinel
    html = html.replace(/<thead-done>/g, '');
    return html;
}

function inline(text) {
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/__(.+?)__/g, '<strong>$1</strong>')
        .replace(/_(.+?)_/g, '<em>$1</em>')
        .replace(/~~(.+?)~~/g, '<del>$1</del>')
        .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARTIFACT / CODE BLOCK BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildArtifact(code, lang) {
    const wrap = document.createElement('div');
    wrap.className = 'artifact';

    const head = document.createElement('div');
    head.className = 'artifact-head';

    const langLabel = document.createElement('span');
    langLabel.className = 'artifact-lang';
    langLabel.textContent = lang === 'text' ? 'plaintext' : lang;
    head.appendChild(langLabel);

    const btns = document.createElement('div');
    btns.className = 'artifact-btns';

    // Preview for HTML
    if (lang.toLowerCase() === 'html') {
        const prevBtn = buildArtifactBtn('Preview', 'preview', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5z"/></svg>`);
        prevBtn.addEventListener('click', () => {
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const w = window.open(url, '_blank');
            // Revoke after tab opens
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        });
        btns.appendChild(prevBtn);
    }

    // Copy
    const copyBtn = buildArtifactBtn('Copy', '', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2z"/></svg>`);
    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(code).then(() => {
            copyBtn.classList.add('copied');
            copyBtn.querySelector('span').textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.classList.remove('copied');
                copyBtn.querySelector('span').textContent = 'Copy';
            }, 2000);
        });
    });
    btns.appendChild(copyBtn);

    // Download
    const extMap = { javascript: 'js', js: 'js', python: 'py', py: 'py', html: 'html', css: 'css', json: 'json', typescript: 'ts', ts: 'ts', bash: 'sh', shell: 'sh', sql: 'sql' };
    const ext = extMap[lang.toLowerCase()] || 'txt';
    const dlBtn = buildArtifactBtn('Download', '', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>`);
    dlBtn.addEventListener('click', () => {
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `code.${ext}`; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    });
    btns.appendChild(dlBtn);

    head.appendChild(btns);

    const body = document.createElement('div');
    body.className = 'artifact-body';
    const pre = document.createElement('pre');
    const codeEl = document.createElement('code');
    if (lang && lang !== 'text') codeEl.className = `language-${lang}`;
    codeEl.textContent = code;
    pre.appendChild(codeEl);
    body.appendChild(pre);

    wrap.appendChild(head);
    wrap.appendChild(body);

    // Highlight after DOM insertion (deferred)
    requestAnimationFrame(() => {
        if (lang && lang !== 'text' && !codeEl.dataset.highlighted) {
            hljs.highlightElement(codeEl);
        }
    });

    return wrap;
}

function buildArtifactBtn(label, extraClass, iconSvg) {
    const btn = document.createElement('button');
    btn.className = 'artifact-action' + (extraClass ? ' ' + extraClass : '');
    btn.innerHTML = iconSvg + `<span>${label}</span>`;
    return btn;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTyping(show) {
    document.getElementById('typingRow').classList.toggle('visible', show);
    if (show) scrollBottom();
}

function setInputEnabled(enabled) {
    ['chatInput', 'chatSendBtn', 'welcomeInput', 'welcomeSendBtn'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = !enabled; el.style.opacity = enabled ? '' : '0.5'; }
    });
}

function scrollBottom() {
    const msgs = document.getElementById('chatMessages');
    requestAnimationFrame(() => { msgs.scrollTop = msgs.scrollHeight; });
}

function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 180) + 'px';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = '') {
    const stack = document.getElementById('toastStack');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    stack.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}
</script>
</body>
</html>
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 15px;
            line-height: 1.6;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-3); }

        /* ===== LAYOUT ===== */
        .app { display: flex; height: 100vh; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 260px;
            min-width: 260px;
            background: var(--bg-2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .sidebar-header {
            padding: 18px 16px 14px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 9px;
            font-size: 17px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 14px;
            letter-spacing: -0.3px;
        }

        .logo-icon {
            width: 28px; height: 28px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 7px;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(249,115,22,0.35);
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 9px 12px;
            background: var(--accent-l);
            border: 1px solid rgba(249,115,22,0.25);
            border-radius: var(--radius);
            color: var(--accent);
            font-size: 13.5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
        }
        .new-chat-btn:hover {
            background: rgba(249,115,22,0.2);
            border-color: rgba(249,115,22,0.4);
        }

        .sidebar-body { flex: 1; padding: 14px 12px; overflow-y: auto; }

        .section-label {
            font-size: 10.5px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: var(--text-3);
            padding: 0 4px;
            margin-bottom: 8px;
        }

        .recent-item {
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .recent-item:hover { background: var(--bg-3); color: var(--text); }
        .recent-item.active { background: var(--accent-l); color: var(--accent); }

        .empty-note {
            padding: 8px 4px;
            font-size: 12.5px;
            color: var(--text-3);
            font-style: italic;
        }

        .sidebar-footer {
            padding: 12px 14px;
            border-top: 1px solid var(--border);
        }

        .user-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 9px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .user-row:hover { background: var(--bg-3); }

        .user-avatar {
            width: 30px; height: 30px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .user-name { font-size: 13.5px; font-weight: 500; color: var(--text); }
        .user-plan { font-size: 11.5px; color: var(--text-3); }

        /* ===== MAIN ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        /* ===== WELCOME SCREEN ===== */
        #welcomeScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            gap: 28px;
            animation: fadeUp 0.4s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .greeting-block { text-align: center; }
        .greeting-time { font-size: 13px; color: var(--text-3); margin-bottom: 6px; letter-spacing: 0.5px; }
        .greeting-main {
            font-size: 34px;
            font-weight: 300;
            color: var(--text);
            letter-spacing: -1px;
            line-height: 1.15;
        }
        .greeting-main span { color: var(--accent); font-weight: 600; }

        .welcome-input-wrap {
            width: 100%;
            max-width: 620px;
            position: relative;
        }

        .welcome-textarea {
            width: 100%;
            padding: 16px 56px 16px 18px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            resize: none;
            min-height: 54px;
            max-height: 180px;
            transition: border-color 0.2s, box-shadow 0.2s;
            line-height: 1.5;
        }
        .welcome-textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.12);
        }
        .welcome-textarea::placeholder { color: var(--text-3); }

        .send-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            width: 34px; height: 34px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.18s, transform 0.12s;
        }
        .send-btn:hover:not(:disabled) { background: var(--accent-h); transform: scale(1.05); }
        .send-btn:disabled { background: var(--bg-4); cursor: not-allowed; opacity: 0.5; }

        /* model pill */
        .model-pill-wrap { position: relative; display: inline-block; }

        .model-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: 99px;
            font-size: 12.5px;
            color: var(--text-2);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.18s;
        }
        .model-pill:hover { border-color: var(--accent); color: var(--accent); }
        .model-pill .dot {
            width: 6px; height: 6px;
            background: var(--green);
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* model dropdown */
        .model-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            min-width: 260px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            z-index: 100;
            overflow: hidden;
            animation: dropIn 0.18s ease;
        }
        @keyframes dropIn {
            from { opacity: 0; transform: translateX(-50%) translateY(6px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .model-dropdown-header {
            padding: 10px 14px 8px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.7px;
            text-transform: uppercase;
            color: var(--text-3);
            border-bottom: 1px solid var(--border);
        }

        .model-option {
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-2);
            cursor: pointer;
            transition: background 0.14s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .model-option:hover { background: var(--bg-4); color: var(--text); }
        .model-option.selected { color: var(--accent); font-weight: 500; }
        .model-option .model-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--border-2);
            flex-shrink: 0;
        }
        .model-option.selected .model-dot { background: var(--accent); }

        .action-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-chip {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 10px 18px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 99px;
            color: var(--text-2);
            font-size: 13.5px;
            cursor: pointer;
            transition: all 0.18s;
            font-family: inherit;
        }
        .action-chip:hover {
            background: var(--bg-3);
            border-color: var(--border-2);
            color: var(--text);
            transform: translateY(-1px);
        }

        /* auth banner */
        .auth-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: rgba(96,165,250,0.08);
            border: 1px solid rgba(96,165,250,0.2);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text-2);
            max-width: 620px;
            width: 100%;
        }

        .auth-btn {
            margin-left: auto;
            padding: 5px 14px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12.5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: opacity 0.18s;
            white-space: nowrap;
        }
        .auth-btn:hover { opacity: 0.88; }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ===== CHAT ===== */
        #chatContainer {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        #chatContainer.active { display: flex; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px 0;
            scroll-behavior: smooth;
        }

        .msg-row {
            display: flex;
            gap: 14px;
            padding: 4px 24px;
            max-width: 860px;
            margin: 0 auto;
            width: 100%;
            animation: msgIn 0.22s ease;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .msg-row.user { flex-direction: row-reverse; }

        .msg-avatar {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .msg-row.user .msg-avatar {
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            color: white;
        }
        .msg-row.assistant .msg-avatar {
            background: var(--bg-3);
            border: 1px solid var(--border);
            color: var(--text-2);
        }

        .msg-body { flex: 1; min-width: 0; }

        .msg-bubble {
            display: inline-block;
            max-width: 78%;
            padding: 12px 16px;
            background: var(--bg-3);
            border: 1px solid var(--border);
            border-radius: 14px 14px 14px 4px;
            line-height: 1.65;
            word-break: break-word;
        }
        .msg-row.user .msg-bubble {
            background: linear-gradient(135deg, var(--accent), #ea6a0e);
            border-color: transparent;
            border-radius: 14px 14px 4px 14px;
            color: white;
            float: right;
        }
        .msg-row.assistant .msg-body { padding-right: 40px; }

        /* markdown styles inside assistant bubbles */
        .msg-md h1, .msg-md h2, .msg-md h3, .msg-md h4 {
            font-weight: 600;
            margin: 14px 0 6px;
            letter-spacing: -0.3px;
            line-height: 1.3;
        }
        .msg-md h1 { font-size: 20px; }
        .msg-md h2 { font-size: 17px; }
        .msg-md h3 { font-size: 15px; }
        .msg-md p { margin-bottom: 10px; }
        .msg-md p:last-child { margin-bottom: 0; }
        .msg-md ul, .msg-md ol { padding-left: 20px; margin-bottom: 10px; }
        .msg-md li { margin-bottom: 4px; }
        .msg-md strong { font-weight: 600; color: var(--text); }
        .msg-md em { font-style: italic; opacity: 0.9; }
        .msg-md a { color: var(--blue); text-decoration: none; border-bottom: 1px solid rgba(96,165,250,0.3); }
        .msg-md a:hover { border-color: var(--blue); }
        .msg-md hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
        .msg-md blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            color: var(--text-2);
            margin: 10px 0;
        }
        .msg-md code:not(pre code) {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            background: var(--bg-4);
            border: 1px solid var(--border-2);
            padding: 1px 6px;
            border-radius: 4px;
            color: var(--accent);
        }
        .msg-md table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13.5px; }
        .msg-md th, .msg-md td { padding: 7px 12px; border: 1px solid var(--border-2); text-align: left; }
        .msg-md th { background: var(--bg-4); font-weight: 600; }

        /* artifact / code block */
        .artifact {
            margin: 10px 0;
            border: 1px solid var(--border-2);
            border-radius: var(--radius);
            overflow: hidden;
            background: #0e0e10;
        }
        .artifact-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-3);
            border-bottom: 1px solid var(--border);
        }
        .artifact-lang {
            font-size: 11.5px;
            font-weight: 500;
            color: var(--text-3);
            font-family: 'JetBrains Mono', monospace;
            text-transform: lowercase;
        }
        .artifact-btns { display: flex; gap: 6px; }
        .artifact-action {
            padding: 3px 10px;
            font-size: 11.5px;
            background: none;
            border: 1px solid var(--border-2);
            border-radius: 5px;
            color: var(--text-3);
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .artifact-action:hover { background: var(--bg-4); color: var(--text); border-color: var(--border-2); }
        .artifact-action.preview { border-color: rgba(96,165,250,0.35); color: var(--blue); }
        .artifact-action.preview:hover { background: rgba(96,165,250,0.1); }
        .artifact-action.copied { border-color: rgba(52,211,153,0.35); color: var(--green); }
        .artifact-body { overflow-x: auto; max-height: 480px; }
        .artifact-body pre { margin: 0 !important; border-radius: 0 !important; }
        .artifact-body pre code.hljs { padding: 14px 16px; font-size: 13px; font-family: 'JetBrains Mono', monospace; background: #0e0e10 !important; }

        /* typing indicator */
        .typing-row {
            display: none;
            gap: 14px;
            padding: 4px 24px;
            max-width: 860px;
            margin: 0 auto;
            width: 100%;
        }
        .typing-row.visible { display: flex; }
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 14px 16px;
        }
        .typing-dot {
            width: 7px; height: 7px;
            background: var(--text-3);
            border-radius: 50%;
            animation: typeBounce 1.3s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.18s; }
        .typing-dot:nth-child(3) { animation-delay: 0.36s; }
        @keyframes typeBounce {
            0%, 70%, 100% { transform: translateY(0); opacity: 0.4; }
            35% { transform: translateY(-5px); opacity: 1; }
        }

        /* chat input bar */
        .chat-input-bar {
            padding: 12px 20px 16px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }
        .chat-input-inner {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 820px;
            margin: 0 auto;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius-lg);
            padding: 8px 10px 8px 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-input-inner:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
        }

        .chat-textarea {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 14.5px;
            font-family: inherit;
            resize: none;
            max-height: 160px;
            line-height: 1.55;
            padding: 4px 0;
        }
        .chat-textarea::placeholder { color: var(--text-3); }

        .chat-actions { display: flex; align-items: center; gap: 6px; }

        .stop-btn {
            width: 30px; height: 30px;
            background: none;
            border: 1px solid var(--red);
            border-radius: 7px;
            color: var(--red);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .stop-btn.visible { display: flex; }
        .stop-btn:hover { background: rgba(248,113,113,0.12); }

        .chat-send-btn {
            width: 32px; height: 32px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.18s;
            flex-shrink: 0;
        }
        .chat-send-btn:hover:not(:disabled) { background: var(--accent-h); }
        .chat-send-btn:disabled { background: var(--bg-4); cursor: not-allowed; opacity: 0.4; }

        .chat-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 820px;
            margin: 6px auto 0;
            padding: 0 4px;
        }

        .chat-model-pill {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11.5px;
            color: var(--text-3);
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 99px;
            transition: all 0.15s;
            font-family: inherit;
            background: none;
            border: 1px solid transparent;
        }
        .chat-model-pill:hover { color: var(--text-2); border-color: var(--border); }
        .chat-hint { font-size: 11px; color: var(--text-3); }

        /* ===== TOAST ===== */
        .toast-stack {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        .toast {
            padding: 10px 16px;
            background: var(--bg-3);
            border: 1px solid var(--border-2);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text);
            box-shadow: var(--shadow);
            animation: toastIn 0.2s ease, toastOut 0.2s ease 2.6s forwards;
        }
        .toast.success { border-color: rgba(52,211,153,0.4); }
        .toast.error   { border-color: rgba(248,113,113,0.4); }
        @keyframes toastIn  { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { to   { opacity: 0; transform: translateY(10px); } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .sidebar { display: none; }
            .greeting-main { font-size: 26px; }
            .msg-row.assistant .msg-body { padding-right: 0; }
        }
    </style>
</head>
<body>

<div class="app">

    <!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">‚ú¶</div>
                Claude
            </div>
            <button class="new-chat-btn" id="newChatBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H13v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                New conversation
            </button>
        </div>

        <div class="sidebar-body" id="sidebarBody">
            <div class="section-label">Recents</div>
            <div id="recentList">
                <div class="empty-note" id="emptyNote">No recent chats</div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-row">
                <div class="user-avatar">H</div>
                <div>
                    <div class="user-name">Hassan</div>
                    <div class="user-plan">Free via Puter.js</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
    <main class="main">

        <!-- Welcome Screen -->
        <div id="welcomeScreen">
            <div class="greeting-block">
                <div class="greeting-time" id="greetTime"></div>
                <div class="greeting-main">Hello, <span>Hassan</span> üëã</div>
            </div>

            <div id="authBanner" class="auth-banner">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color:#60a5fa;flex-shrink:0"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                <span>Authenticate to start chatting with Claude.</span>
                <button class="auth-btn" id="authBtn">Authenticate</button>
            </div>

            <div class="welcome-input-wrap">
                <textarea class="welcome-textarea" id="welcomeInput" placeholder="Ask me anything‚Ä¶" rows="1"></textarea>
                <button class="send-btn" id="welcomeSendBtn" title="Send (Enter)">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>

            <!-- Model picker -->
            <div class="model-pill-wrap" id="welcomeModelWrap">
                <button class="model-pill" id="welcomeModelPill">
                    <div class="dot"></div>
                    <span id="welcomeModelName">Loading‚Ä¶</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div class="model-dropdown" id="modelDropdown" style="display:none">
                    <div class="model-dropdown-header">Select Model</div>
                    <div id="modelList">
                        <div style="padding:12px 14px;font-size:12.5px;color:var(--text-3)">Loading models‚Ä¶</div>
                    </div>
                </div>
            </div>

            <div class="action-chips">
                <button class="action-chip" data-prompt="Help me write ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    Write
                </button>
                <button class="action-chip" data-prompt="Help me code ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                    Code
                </button>
                <button class="action-chip" data-prompt="Explain this concept: ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    Explain
                </button>
                <button class="action-chip" data-prompt="Summarize the following: ">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h7v-2H3v2zM18 7l-1.41 1.41L18.17 10H16v2h2.17l-1.59 1.59L18 15l4-4z"/></svg>
                    Summarize
                </button>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chatContainer">
            <div class="chat-messages" id="chatMessages">

                <!-- Typing indicator -->
                <div class="typing-row" id="typingRow">
                    <div class="msg-avatar" style="background:var(--bg-3);border:1px solid var(--border)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                    </div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

            </div>

            <!-- Input bar -->
            <div class="chat-input-bar">
                <div class="chat-input-inner">
                    <textarea class="chat-textarea" id="chatInput" placeholder="Message Claude‚Ä¶" rows="1"></textarea>
                    <div class="chat-actions">
                        <button class="stop-btn" id="stopBtn" title="Stop generation">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                        </button>
                        <button class="chat-send-btn" id="chatSendBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="chat-bottom-row">
                    <button class="chat-model-pill" id="chatModelPill">
                        <div class="dot" style="width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 2s infinite"></div>
                        <span id="chatModelName">‚Ä¶</span>
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                    </button>
                    <span class="chat-hint">Enter to send ¬∑ Shift+Enter for newline</span>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- Toast stack -->
<div class="toast-stack" id="toastStack"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
    models: [],
    currentModel: null,
    chatHistory: [],
    isStreaming: false,
    stopRequested: false,
    conversations: [],
    activeConvId: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    setGreeting();
    bindEvents();
    loadModels();
    document.getElementById('welcomeInput').focus();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GREETING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setGreeting() {
    const h = new Date().getHours();
    const period = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
    const icons  = { morning: 'üå§Ô∏è', afternoon: '‚òÄÔ∏è', evening: 'üåô' };
    document.getElementById('greetTime').textContent = `${icons[period]} Good ${period}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODEL LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadModels() {
    try {
        if (typeof puter === 'undefined' || !puter.ai) throw new Error('Puter not loaded');
        const raw = await puter.ai.listModels();
        if (!raw?.length) throw new Error('No models returned');

        state.models = raw;
        // Prefer claude-3-5-sonnet or first available
        const preferred = raw.find(m => m.id.includes('claude-3-5-sonnet')) || raw[0];
        state.currentModel = preferred.id;

        buildModelDropdown();
        updateModelPills();
        console.log('‚úÖ Models loaded:', state.models.length);
    } catch (err) {
        console.error('‚ùå loadModels:', err);
        document.getElementById('welcomeModelName').textContent = 'Error loading models';
        document.getElementById('chatModelName').textContent = 'Error';
    }
}

function buildModelDropdown() {
    const list = document.getElementById('modelList');
    list.innerHTML = '';
    state.models.forEach(m => {
        const div = document.createElement('div');
        div.className = 'model-option' + (m.id === state.currentModel ? ' selected' : '');
        div.dataset.id = m.id;
        div.innerHTML = `<div class="model-dot"></div><span>${m.name || m.id}</span>`;
        div.addEventListener('click', () => selectModel(m.id));
        list.appendChild(div);
    });
}

function selectModel(id) {
    state.currentModel = id;
    updateModelPills();
    buildModelDropdown();
    closeDropdown();
    toast(`Model: ${getModelLabel()}`, 'success');
}

function getModelLabel() {
    const m = state.models.find(x => x.id === state.currentModel);
    return m ? (m.name || m.id) : (state.currentModel || '‚Ä¶');
}

function updateModelPills() {
    const label = getModelLabel();
    document.getElementById('welcomeModelName').textContent = label;
    document.getElementById('chatModelName').textContent = label;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DROPDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeDropdown() {
    document.getElementById('modelDropdown').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EVENT BINDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindEvents() {
    // Send buttons
    document.getElementById('welcomeSendBtn').addEventListener('click', handleWelcomeSend);
    document.getElementById('chatSendBtn').addEventListener('click', handleChatSend);
    document.getElementById('stopBtn').addEventListener('click', stopStreaming);

    // New chat
    document.getElementById('newChatBtn').addEventListener('click', startNewChat);

    // Auth
    document.getElementById('authBtn').addEventListener('click', handleAuth);

    // Textareas
    ['welcomeInput', 'chatInput'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => autoResize(el));
        el.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                id === 'welcomeInput' ? handleWelcomeSend() : handleChatSend();
            }
        });
    });

    // Action chips
    document.querySelectorAll('.action-chip').forEach(btn => {
        btn.addEventListener('click', () => {
            const p = btn.dataset.prompt;
            const inp = document.getElementById('welcomeInput');
            inp.value = p;
            inp.focus();
            autoResize(inp);
            // move cursor to end
            inp.setSelectionRange(inp.value.length, inp.value.length);
        });
    });

    // Model dropdown toggle
    document.getElementById('welcomeModelPill').addEventListener('click', e => {
        e.stopPropagation();
        const dd = document.getElementById('modelDropdown');
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });

    // Chat model pill opens dropdown near input
    document.getElementById('chatModelPill').addEventListener('click', e => {
        e.stopPropagation();
        const dd = document.getElementById('modelDropdown');
        // Re-attach to chat bottom
        const wrap = document.getElementById('chatModelPill').parentElement;
        dd.style.bottom = '100%';
        dd.style.left = '0';
        dd.style.transform = 'none';
        wrap.style.position = 'relative';
        wrap.appendChild(dd);
        dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
    });

    // Close dropdown on outside click
    document.addEventListener('click', () => closeDropdown());

    // Model dropdowns shouldn't close when clicking inside them
    document.getElementById('modelDropdown').addEventListener('click', e => e.stopPropagation());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleAuth() {
    const btn = document.getElementById('authBtn');
    btn.textContent = 'Authenticating‚Ä¶';
    btn.disabled = true;
    try {
        await puter.ai.chat('Hello', { model: state.currentModel || 'claude-3-5-sonnet' });
        document.getElementById('authBanner').style.display = 'none';
        toast('Authenticated successfully ‚úì', 'success');
        await loadModels();
    } catch (err) {
        btn.textContent = 'Retry';
        btn.disabled = false;
        toast('Auth failed ‚Äî try again', 'error');
        console.error('Auth error:', err);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEND MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleWelcomeSend() {
    const inp = document.getElementById('welcomeInput');
    const msg = inp.value.trim();
    if (!msg || state.isStreaming) return;
    inp.value = '';
    autoResize(inp);
    newConversation(msg);
    showChat();
    sendMessage(msg);
}

function handleChatSend() {
    const inp = document.getElementById('chatInput');
    const msg = inp.value.trim();
    if (!msg || state.isStreaming) return;
    inp.value = '';
    autoResize(inp);
    sendMessage(msg);
}

function stopStreaming() {
    state.stopRequested = true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CORE SEND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMessage(message) {
    if (state.isStreaming) return;

    appendMessage(message, 'user');
    state.chatHistory.push({ role: 'user', content: message });

    showTyping(true);
    setInputEnabled(false);
    state.isStreaming = true;
    state.stopRequested = false;
    document.getElementById('stopBtn').classList.add('visible');

    try {
        if (typeof puter === 'undefined') throw new Error('Puter.js not loaded');

        const response = await puter.ai.chat(state.chatHistory, {
            model: state.currentModel,
            stream: true,
        });

        if (response?.success === false) throw new Error('Auth required ‚Äî click Authenticate');

        const { contentEl } = appendMessage('', 'assistant');
        showTyping(false);
        let full = '';

        for await (const chunk of response) {
            if (state.stopRequested) break;
            if (chunk?.text) {
                full += chunk.text;
                renderMarkdown(full, contentEl);
                scrollBottom();
            }
        }

        renderMarkdown(full, contentEl); // Final render
        state.chatHistory.push({ role: 'assistant', content: full });
        saveConversation();

    } catch (err) {
        showTyping(false);
        console.error('sendMessage error:', err);
        const isAuthErr = /auth|limit|quota|rate/i.test(err.message || '');
        const errMsg = isAuthErr
            ? '‚ö†Ô∏è Authentication or rate limit error. Please click **Authenticate** or try again.'
            : `Error: ${err.message}`;
        appendMessage(errMsg, 'assistant', true);
        if (isAuthErr) {
            document.getElementById('authBanner').style.display = 'flex';
        }
        // Remove the failed user message from history
        if (state.chatHistory.at(-1)?.role === 'user') state.chatHistory.pop();
    } finally {
        state.isStreaming = false;
        state.stopRequested = false;
        document.getElementById('stopBtn').classList.remove('visible');
        setInputEnabled(true);
        document.getElementById('chatInput').focus();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONVERSATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function newConversation(firstMsg) {
    state.activeConvId = `c_${Date.now()}`;
    const title = firstMsg.length > 48 ? firstMsg.slice(0, 48) + '‚Ä¶' : firstMsg;
    state.conversations.unshift({ id: state.activeConvId, title, messages: [] });
    if (state.conversations.length > 20) state.conversations = state.conversations.slice(0, 20);
    renderSidebar();
}

function saveConversation() {
    const conv = state.conversations.find(c => c.id === state.activeConvId);
    if (conv) {
        conv.messages = [...state.chatHistory];
        renderSidebar();
    }
}

function renderSidebar() {
    const list = document.getElementById('recentList');
    const empty = document.getElementById('emptyNote');
    if (!state.conversations.length) {
        empty?.remove();
        list.innerHTML = '<div class="empty-note">No recent chats</div>';
        return;
    }
    list.innerHTML = '';
    state.conversations.forEach(conv => {
        const div = document.createElement('div');
        div.className = 'recent-item' + (conv.id === state.activeConvId ? ' active' : '');
        div.textContent = conv.title;
        div.title = conv.title;
        div.addEventListener('click', () => loadConversation(conv.id));
        list.appendChild(div);
    });
}

function loadConversation(id) {
    const conv = state.conversations.find(c => c.id === id);
    if (!conv) return;
    state.activeConvId = id;
    state.chatHistory = [...conv.messages];
    showChat();
    const msgs = document.getElementById('chatMessages');
    // Clear all messages except typing row
    Array.from(msgs.querySelectorAll('.msg-row')).forEach(r => r.remove());
    conv.messages.forEach(m => appendMessage(m.content, m.role));
    renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIEW SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showChat() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('chatContainer').classList.add('active');
}

function startNewChat() {
    state.chatHistory = [];
    state.activeConvId = null;
    document.getElementById('chatMessages').querySelectorAll('.msg-row').forEach(r => r.remove());
    document.getElementById('chatContainer').classList.remove('active');
    document.getElementById('welcomeScreen').style.display = '';
    document.getElementById('welcomeInput').value = '';
    autoResize(document.getElementById('welcomeInput'));
    document.getElementById('welcomeInput').focus();
    renderSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function appendMessage(content, role, isError = false) {
    const msgs = document.getElementById('chatMessages');
    const typing = document.getElementById('typingRow');

    const row = document.createElement('div');
    row.className = `msg-row ${role}`;

    const avatar = document.createElement('div');
    avatar.className = 'msg-avatar';
    avatar.textContent = role === 'user' ? 'H' : '‚ú¶';

    const body = document.createElement('div');
    body.className = 'msg-body';

    if (role === 'user') {
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = content;
        body.appendChild(bubble);
    } else {
        body.className += ' msg-md';
        if (isError) body.style.color = 'var(--red)';
        renderMarkdown(content, body);
    }

    row.appendChild(avatar);
    row.appendChild(body);

    // Insert before typing indicator
    msgs.insertBefore(row, typing);
    scrollBottom();

    return { row, contentEl: body };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MARKDOWN RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkdown(raw, container) {
    container.innerHTML = '';
    if (!raw) return;

    // Split on fenced code blocks
    const codeRe = /```(\w*)\n?([\s\S]*?)```/g;
    let last = 0, match;

    while ((match = codeRe.exec(raw)) !== null) {
        if (match.index > last) {
            const textNode = document.createElement('div');
            textNode.innerHTML = parseInlineMarkdown(raw.slice(last, match.index));
            container.appendChild(textNode);
        }
        container.appendChild(buildArtifact(match[2].trim(), match[1] || 'text'));
        last = match.index + match[0].length;
    }

    if (last < raw.length) {
        const textNode = document.createElement('div');
        textNode.innerHTML = parseInlineMarkdown(raw.slice(last));
        container.appendChild(textNode);
    }

    // Syntax highlight
    container.querySelectorAll('pre code').forEach(el => {
        if (el.dataset.highlighted) return;
        hljs.highlightElement(el);
    });
}

/**
 * Convert markdown text (no code blocks) to HTML.
 * Handles: headers, bold, italic, inline code, links, horizontal rules,
 * blockquotes, unordered/ordered lists, tables, line breaks.
 */
function parseInlineMarkdown(text) {
    const lines = text.split('\n');
    let html = '';
    let inList = null; // 'ul' | 'ol' | null
    let inTable = false;
    let tableHeaderDone = false;

    const closeList = () => {
        if (inList) { html += `</${inList}>`; inList = null; }
    };
    const closeTable = () => {
        if (inTable) { html += `</tbody></table>`; inTable = false; tableHeaderDone = false; }
    };

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // Horizontal rule
        if (/^[-*_]{3,}\s*$/.test(line)) { closeList(); closeTable(); html += '<hr>'; continue; }

        // Headings
        const headingMatch = line.match(/^(#{1,4})\s+(.+)$/);
        if (headingMatch) {
            closeList(); closeTable();
            const level = headingMatch[1].length;
            html += `<h${level}>${inline(headingMatch[2])}</h${level}>`;
            continue;
        }

        // Blockquote
        if (line.startsWith('> ')) {
            closeList(); closeTable();
            html += `<blockquote>${inline(line.slice(2))}</blockquote>`;
            continue;
        }

        // Table row
        if (line.includes('|')) {
            const cells = line.split('|').map(c => c.trim()).filter(Boolean);
            if (cells.length > 1) {
                closeList();
                // Separator row?
                if (cells.every(c => /^[-:]+$/.test(c))) {
                    tableHeaderDone = true;
                    html += '<thead-done>';
                    continue;
                }
                if (!inTable) {
                    html += '<table><thead><tr>' + cells.map(c => `<th>${inline(c)}</th>`).join('') + '</tr></thead><tbody>';
                    inTable = true;
                } else {
                    html += '<tr>' + cells.map(c => `<td>${inline(c)}</td>`).join('') + '</tr>';
                }
                continue;
            }
        }
        closeTable();

        // Unordered list
        const ulMatch = line.match(/^(\s*)[-*+]\s+(.+)$/);
        if (ulMatch) {
            if (inList !== 'ul') { closeList(); html += '<ul>'; inList = 'ul'; }
            html += `<li>${inline(ulMatch[2])}</li>`;
            continue;
        }

        // Ordered list
        const olMatch = line.match(/^(\s*)\d+\.\s+(.+)$/);
        if (olMatch) {
            if (inList !== 'ol') { closeList(); html += '<ol>'; inList = 'ol'; }
            html += `<li>${inline(olMatch[2])}</li>`;
            continue;
        }

        closeList();

        // Empty line ‚Üí paragraph break
        if (line.trim() === '') { html += '<br>'; continue; }

        // Regular paragraph line
        html += `<p>${inline(line)}</p>`;
    }
    closeList(); closeTable();

    // Clean up table head sentinel
    html = html.replace(/<thead-done>/g, '');
    return html;
}

function inline(text) {
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/__(.+?)__/g, '<strong>$1</strong>')
        .replace(/_(.+?)_/g, '<em>$1</em>')
        .replace(/~~(.+?)~~/g, '<del>$1</del>')
        .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ARTIFACT / CODE BLOCK BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildArtifact(code, lang) {
    const wrap = document.createElement('div');
    wrap.className = 'artifact';

    const head = document.createElement('div');
    head.className = 'artifact-head';

    const langLabel = document.createElement('span');
    langLabel.className = 'artifact-lang';
    langLabel.textContent = lang === 'text' ? 'plaintext' : lang;
    head.appendChild(langLabel);

    const btns = document.createElement('div');
    btns.className = 'artifact-btns';

    // Preview for HTML
    if (lang.toLowerCase() === 'html') {
        const prevBtn = buildArtifactBtn('Preview', 'preview', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5z"/></svg>`);
        prevBtn.addEventListener('click', () => {
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const w = window.open(url, '_blank');
            // Revoke after tab opens
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        });
        btns.appendChild(prevBtn);
    }

    // Copy
    const copyBtn = buildArtifactBtn('Copy', '', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2z"/></svg>`);
    copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(code).then(() => {
            copyBtn.classList.add('copied');
            copyBtn.querySelector('span').textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.classList.remove('copied');
                copyBtn.querySelector('span').textContent = 'Copy';
            }, 2000);
        });
    });
    btns.appendChild(copyBtn);

    // Download
    const extMap = { javascript: 'js', js: 'js', python: 'py', py: 'py', html: 'html', css: 'css', json: 'json', typescript: 'ts', ts: 'ts', bash: 'sh', shell: 'sh', sql: 'sql' };
    const ext = extMap[lang.toLowerCase()] || 'txt';
    const dlBtn = buildArtifactBtn('Download', '', `<svg viewBox="0 0 24 24" fill="currentColor" width="11" height="11"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>`);
    dlBtn.addEventListener('click', () => {
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `code.${ext}`; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    });
    btns.appendChild(dlBtn);

    head.appendChild(btns);

    const body = document.createElement('div');
    body.className = 'artifact-body';
    const pre = document.createElement('pre');
    const codeEl = document.createElement('code');
    if (lang && lang !== 'text') codeEl.className = `language-${lang}`;
    codeEl.textContent = code;
    pre.appendChild(codeEl);
    body.appendChild(pre);

    wrap.appendChild(head);
    wrap.appendChild(body);

    // Highlight after DOM insertion (deferred)
    requestAnimationFrame(() => {
        if (lang && lang !== 'text' && !codeEl.dataset.highlighted) {
            hljs.highlightElement(codeEl);
        }
    });

    return wrap;
}

function buildArtifactBtn(label, extraClass, iconSvg) {
    const btn = document.createElement('button');
    btn.className = 'artifact-action' + (extraClass ? ' ' + extraClass : '');
    btn.innerHTML = iconSvg + `<span>${label}</span>`;
    return btn;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTyping(show) {
    document.getElementById('typingRow').classList.toggle('visible', show);
    if (show) scrollBottom();
}

function setInputEnabled(enabled) {
    ['chatInput', 'chatSendBtn', 'welcomeInput', 'welcomeSendBtn'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = !enabled; el.style.opacity = enabled ? '' : '0.5'; }
    });
}

function scrollBottom() {
    const msgs = document.getElementById('chatMessages');
    requestAnimationFrame(() => { msgs.scrollTop = msgs.scrollHeight; });
}

function autoResize(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 180) + 'px';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = '') {
    const stack = document.getElementById('toastStack');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    stack.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}
</script>
</body>
</html>        .main-content { flex: 1; display: flex; flex-direction: column; background-color: #1a1a1a; }
        .content-area { flex: 1; display: flex; flex-direction: column; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; position: relative; }
        .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 40px; }
        .chat-container { display: none; flex-direction: column; height: 100vh; max-height: 100vh; overflow: hidden; }
        .chat-container.active { display: flex; }
        .chat-messages { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; margin-bottom: 20px; height: calc(100vh - 200px); min-height: 0; scrollbar-width: thin; scrollbar-color: #404040 #262626; scroll-behavior: smooth; }
        .message { margin-bottom: 24px; display: flex; gap: 12px; }
        .message.user { flex-direction: row-reverse; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0; }
        .message.user .message-avatar { background-color: #ff6b35; color: white; }
        .message.assistant .message-avatar { background-color: #4a90e2; color: white; }
        .message-content { max-width: 70%; background-color: #262626; border-radius: 12px; padding: 16px; color: #e5e5e5; line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
        .message.assistant .message-content { padding: 0; }
        .message-text-part { padding: 16px; white-space: pre-wrap; }
        .message.user .message-content { background-color: #ff6b35; color: white; padding: 16px; }
        .typing-indicator { display: none; align-items: center; gap: 8px; color: #808080; font-style: italic; padding: 16px; }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dot { width: 6px; height: 6px; background-color: #808080; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(1); opacity: 0.5; } 40% { transform: scale(1.2); opacity: 1; } }
        .greeting { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; font-size: 32px; font-weight: 400; color: #fff; }
        .sun-icon { width: 32px; height: 32px; color: #ff6b35; }
        .search-container { width: 100%; max-width: 600px; position: relative; margin-bottom: 20px; }
        .chat-container .search-container { position: sticky; bottom: 0; background-color: #1a1a1a; padding: 20px 0; margin: 0; max-width: none; }
        .search-input { width: 100%; padding: 16px 120px 16px 16px; background-color: #262626; border: 1px solid #404040; border-radius: 12px; color: #fff; font-size: 16px; outline: none; transition: border-color 0.2s; resize: none; min-height: 50px; max-height: 150px; font-family: inherit; }
        .search-input:focus { border-color: #ff6b35; }
        .search-input::placeholder { color: #808080; }
        .search-actions { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 4px; align-items: center; }
        .send-btn { padding: 8px; background-color: #ff6b35; border: none; color: white; cursor: pointer; border-radius: 6px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .send-btn:hover { background-color: #e55a2b; }
        .send-btn:disabled { background-color: #404040; cursor: not-allowed; }
        .model-selector { align-self: flex-end; margin-bottom: 20px; margin-right: 60px; }
        .model-btn { display: flex; align-items: center; gap: 8px; background: none; border: none; color: #b3b3b3; font-size: 14px; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: background-color 0.2s; }
        .model-btn:hover { background-color: #262626; }
        .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        .action-btn { display: flex; align-items: center; gap: 8px; padding: 12px 20px; background-color: #262626; border: 1px solid #404040; border-radius: 8px; color: #e5e5e5; font-size: 14px; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .action-btn:hover { background-color: #333; border-color: #555; transform: translateY(-1px); }
        .action-icon { width: 16px; height: 16px; opacity: 0.8; }
        
        /* Artifact Canvas Styles */
        .artifact-canvas { background-color: #0d0d0d; border: 1px solid #404040; border-radius: 8px; margin: 16px; overflow: hidden; }
        .artifact-header { display: flex; justify-content: space-between; align-items: center; background-color: #2a2a2a; padding: 8px 12px; border-bottom: 1px solid #404040; }
        .artifact-title { font-size: 13px; font-weight: 500; color: #b3b3b3; }
        .artifact-actions { display: flex; gap: 8px; }
        .artifact-btn { background: none; border: 1px solid #555; color: #b3b3b3; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .artifact-btn:hover { background-color: #404040; color: #fff; }
        .artifact-btn.view-btn { border-color: #4a90e2; color: #4a90e2; }
        .artifact-btn.view-btn:hover { background-color: #4a90e2; color: #fff; }
        .artifact-btn svg { width: 14px; height: 14px; }
        .artifact-code { padding: 12px; max-height: 400px; overflow: auto; scrollbar-width: thin; scrollbar-color: #404040 #1a1a1a; }
        .artifact-code pre { margin: 0; }
        .artifact-code code { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-size: 13px; color: #e5e5e5; white-space: pre; }
        
        .check-models-btn { background-color: #333; color: #b3b3b3; border: 1px solid #404040; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 10px; }
        .check-models-btn:hover { background-color: #444; color: #fff; }

        @media (max-width: 768px) {
            .sidebar { width: 240px; }
            .greeting { font-size: 24px; }
            .action-buttons { flex-direction: column; width: 100%; }
            .action-btn { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg class="back-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                    Claude
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <div class="plus-icon">+</div>
                    New chat
                </button>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/>
                    </svg>
                    Chats
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="section-title">Recents</div>
                <div class="recent-items" id="recentItems">
                    <div class="empty-state" id="emptyState">
                        <span style="color: #666; font-size: 13px; font-style: italic;">No recent conversations</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">H</div>
                    <div class="user-details">
                        <div class="user-name">Hassan</div>
                        <div class="user-plan">Free via Puter</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="content-area">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="greeting">
                        <svg class="sun-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                        </svg>
                        Good morning, Hassan
                    </div>
                    
                    <div class="search-container">
                        <textarea class="search-input" id="welcomeInput" placeholder="How can I help you today?" rows="1"></textarea>
                        <div class="search-actions">
                            <button class="send-btn" id="sendBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div style="max-width: 600px; margin-bottom: 15px; padding: 12px; background-color: #2a2a2a; border-radius: 8px; border: 1px solid #404040;">
                        <div style="font-size: 13px; color: #b3b3b3; text-align: center; margin-bottom: 10px;">
                            üí° <strong>Dynamic Mode:</strong> Models loaded via Puter.js API
                        </div>
                        <div style="text-align: center;">
                            <button id="authButton" style="background-color: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                üîê Authenticate
                            </button>
                            <button id="checkModelsBtn" class="check-models-btn">üîç Refresh Models</button>
                        </div>
                    </div>
                    
                    <div class="model-selector">
                        <button class="model-btn" id="modelSelector">
                            <span id="currentModel">Loading models...</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn" data-prompt="Help me write">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                            Write
                        </button>
                        <button class="action-btn" data-prompt="Help me code">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                            </svg>
                            Code
                        </button>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container" id="chatContainer">
                    <div class="chat-messages" id="chatMessages"></div>
                    
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="message-avatar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span>Claude is typing</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    
                    <div class="search-container">
                        <textarea class="search-input" id="chatInput" placeholder="Message Claude..." rows="1"></textarea>
                        <div class="search-actions">
                            <button class="model-btn" id="chatModelSelector" style="padding: 6px 8px; font-size: 12px;">
                                <span id="chatCurrentModel">...</span>
                            </button>
                            <button class="send-btn" id="chatSendBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let availableModels = []; // Will be populated dynamically
        let currentModel = null;  // Will be set after fetch
        let chatHistory = [];
        let isStreaming = false;
        let recentConversations = [];
        let currentConversationId = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Claude interface...');
            initializeInterface();
            loadDynamicModels(); // Fetch models immediately
        });

        // --- NEW: DYNAMIC MODEL LOADER ---
        async function loadDynamicModels() {
            console.log("üîç Fetching available models from Puter...");
            try {
                if (typeof puter === 'undefined' || !puter.ai) {
                    throw new Error("Puter.js not loaded.");
                }
                
                const models = await puter.ai.listModels();
                console.log("‚úÖ Raw Models List:", models);

                if (models && models.length > 0) {
                    availableModels = models; // Store raw list
                    
                    // Set default model to the first one in the list
                    currentModel = availableModels[0].id;
                    
                    // Update UI
                    updateModelDisplay();
                } else {
                    throw new Error("No models returned.");
                }
            } catch (err) {
                console.error("‚ùå Failed to load models:", err);
                document.getElementById('currentModel').textContent = "Error loading models";
                document.getElementById('chatCurrentModel').textContent = "Error";
            }
        }

        function updateModelDisplay() {
            if (!currentModel || availableModels.length === 0) return;
            
            // Find the friendly name if available, otherwise use ID
            const modelData = availableModels.find(m => m.id === currentModel);
            const displayName = modelData ? (modelData.name || modelData.id) : currentModel;
            
            // Short name for chat header
            let shortName = displayName;
            if (displayName.includes('claude')) shortName = displayName.split('-').slice(0, 2).join(' '); // "claude-3-5" -> "claude 3"
            if (displayName.includes('gpt')) shortName = displayName.replace('openai/', '');
            
            document.getElementById('currentModel').textContent = displayName;
            document.getElementById('chatCurrentModel').textContent = shortName;
        }

        // Function to cycle models (triggered by button click)
        function toggleModel() {
            if (availableModels.length === 0) {
                alert("Models not loaded yet. Wait or check connection.");
                return;
            }

            const currentIndex = availableModels.findIndex(m => m.id === currentModel);
            const nextIndex = (currentIndex + 1) % availableModels.length;
            
            currentModel = availableModels[nextIndex].id;
            updateModelDisplay();
            console.log('üîÑ Model switched to:', currentModel);
        }

        function nukePuterSession() {
            console.log("üî• Nuking Puter session data...");
            localStorage.removeItem('puter_auth_token');
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('puter')) {
                    localStorage.removeItem(key);
                }
            });
            console.log("üî• Session data cleared. Reloading...");
            location.reload();
        }

        async function handleManualAuth() {
            const authButton = document.getElementById('authButton');
            
            try {
                if (authButton) {
                    authButton.textContent = 'üîÑ Authenticating...';
                    authButton.disabled = true;
                }
                
                console.log('üîê Manually triggering Puter authentication...');
                
                // Use the currently selected model for auth test
                const authResponse = await puter.ai.chat("test", {model: currentModel});
                
                console.log('‚úÖ Raw auth response:', authResponse);

                if (authResponse && (authResponse.message?.content || authResponse.success !== false)) {
                     console.log('‚úÖ Authentication successful!');
                    if (authButton) {
                        authButton.textContent = '‚úÖ Authenticated';
                        authButton.style.backgroundColor = '#22c55e';
                        setTimeout(() => {
                           const authBox = authButton.closest('div[style*="max-width: 600px"]');
                           if(authBox) authBox.style.display = 'none';
                        }, 2000);
                    }
                    // Reload models now that we are auth'd
                    await loadDynamicModels();
                } else {
                    throw new Error('Authentication response indicates failure.');
                }
                
            } catch (error) {
                console.error('‚ùå Manual authentication failed:', error);
                
                if (authButton) {
                    authButton.textContent = '‚ùå Auth Failed';
                    authButton.disabled = false;
                    authButton.style.backgroundColor = '#dc2626';
                }
                alert('Auth failed. Check console. Try Incognito mode.');
            }
        }

        function initializeInterface() {
            const welcomeInput = document.getElementById('welcomeInput');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const newChatBtn = document.getElementById('newChatBtn');
            const actionBtns = document.querySelectorAll('.action-btn');
            const authButton = document.getElementById('authButton');
            const checkModelsBtn = document.getElementById('checkModelsBtn');

            // Model selector buttons
            const modelSelectors = document.querySelectorAll('#modelSelector, #chatModelSelector');

            if (authButton) authButton.addEventListener('click', handleManualAuth);
            if (checkModelsBtn) checkModelsBtn.addEventListener('click', loadDynamicModels);

            [welcomeInput, chatInput].forEach(textarea => {
                if (textarea) {
                    textarea.addEventListener('input', () => autoResize(textarea));
                    textarea.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (textarea === welcomeInput) handleWelcomeMessage();
                            else handleChatMessage();
                        }
                    });
                }
            });

            if (sendBtn) sendBtn.addEventListener('click', handleWelcomeMessage);
            if (chatSendBtn) chatSendBtn.addEventListener('click', handleChatMessage);
            if (newChatBtn) newChatBtn.addEventListener('click', startNewChat);

            actionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const prompt = this.getAttribute('data-prompt');
                    if (prompt && welcomeInput) {
                        welcomeInput.value = prompt;
                        welcomeInput.focus();
                        autoResize(welcomeInput);
                    }
                });
            });

            // Add toggle logic to selectors
            modelSelectors.forEach(selector => {
                if (selector) selector.addEventListener('click', toggleModel);
            });

            if (welcomeInput) welcomeInput.focus();
            console.log('‚úÖ Interface initialized');
        }

        async function handleWelcomeMessage() {
            const welcomeInput = document.getElementById('welcomeInput');
            const message = welcomeInput.value.trim();
            if (!message || isStreaming) return;
            console.log('üì§ Sending welcome message:', message);
            createNewConversation(message);
            switchToChatView();
            await sendMessage(message);
        }

        async function handleChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || isStreaming) return;
            console.log('üì§ Sending chat message:', message);
            chatInput.value = '';
            autoResize(chatInput);
            await sendMessage(message);
        }

        function createNewConversation(firstMessage) {
            currentConversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const title = firstMessage.length > 50 ? firstMessage.substring(0, 50) + '...' : firstMessage;
            const conversation = {
                id: currentConversationId,
                title: title,
                messages: [],
                timestamp: new Date(),
            };
            recentConversations.unshift(conversation);
            if (recentConversations.length > 10) {
                recentConversations = recentConversations.slice(0, 10);
            }
            updateRecentItems();
        }

        function updateRecentItems() {
            const recentItemsContainer = document.getElementById('recentItems');
            recentItemsContainer.innerHTML = '';
            if (recentConversations.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = '<span style="color: #666; font-size: 13px; font-style: italic;">No recent conversations</span>';
                recentItemsContainer.appendChild(emptyDiv);
            } else {
                recentConversations.forEach(conversation => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'recent-item';
                    itemDiv.textContent = conversation.title;
                    itemDiv.addEventListener('click', () => loadConversation(conversation.id));
                    recentItemsContainer.appendChild(itemDiv);
                });
            }
        }

        function loadConversation(conversationId) {
            const conversation = recentConversations.find(conv => conv.id === conversationId);
            if (!conversation) return;
            currentConversationId = conversationId;
            chatHistory = [...conversation.messages];
            switchToChatView();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            conversation.messages.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
            document.getElementById('chatInput').focus();
        }

        function switchToChatView() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatContainer').classList.add('active');
        }

        function startNewChat() {
            chatHistory = [];
            currentConversationId = null;
            
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatContainer = document.getElementById('chatContainer');
            const chatMessages = document.getElementById('chatMessages');
            const welcomeInput = document.getElementById('welcomeInput');
            
            if (welcomeScreen) welcomeScreen.style.display = 'flex';
            if (chatContainer) chatContainer.classList.remove('active');
            if (chatMessages) chatMessages.innerHTML = '';
            if (welcomeInput) {
                welcomeInput.value = '';
                autoResize(welcomeInput);
                welcomeInput.focus();
            }
            autoResize(document.getElementById('chatInput'));
        }

        async function sendMessage(message) {
            if (isStreaming) return;
            
            addMessage(message, 'user');
            showTypingIndicator();
            setInputState(false);

            chatHistory.push({ role: 'user', content: message });
            
            try {
                isStreaming = true;
                if (typeof puter === 'undefined') { throw new Error('Puter.js is not available.'); }
                console.log('üì° Calling Puter AI with model:', currentModel);
                
                const response = await puter.ai.chat(chatHistory, {
                    model: currentModel,
                    stream: true
                });

                if (response && response.success === false) {
                    throw new Error('Authentication required. Please click authenticate.');
                }
                
                const { messageContent } = addMessage('', 'assistant');
                hideTypingIndicator();
                let fullResponse = '';
                
                for await (const part of response) {
                    if (part?.text) {
                        fullResponse += part.text;
                        renderFormattedMessage(fullResponse, messageContent);
                        scrollToBottom();
                    }
                }
                
                console.log('‚úÖ Streaming complete.');
                renderFormattedMessage(fullResponse, messageContent); 
                
                chatHistory.push({ role: 'assistant', content: fullResponse });
                updateCurrentConversation();
                
            } catch (error) {
                console.error('‚ùå Error in sendMessage:', error);
                hideTypingIndicator();
                
                const errorMessage = error.message || 'Unknown error.';
                const isLimitError = errorMessage.toLowerCase().includes('limit') || 
                                     errorMessage.toLowerCase().includes('quota') ||
                                     errorMessage.toLowerCase().includes('rate') ||
                                     errorMessage.toLowerCase().includes('authentication');

                if (isLimitError) {
                    addMessage('‚ö†Ô∏è Session Limit or Error. Click "Reset Session" below to try again.', 'assistant', false);
                    
                    const chatMessages = document.getElementById('chatMessages');
                    const resetDiv = document.createElement('div');
                    resetDiv.style.textAlign = 'center';
                    resetDiv.style.marginTop = '10px';
                    resetDiv.innerHTML = `<button onclick="nukePuterSession()" style="background-color:#ff6b35; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">üîÑ Reset Session</button>`;
                    chatMessages.appendChild(resetDiv);
                    scrollToBottom();
                    
                    if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
                        chatHistory.pop();
                    }
                } else {
                    addMessage('Sorry, I encountered an error: ' + errorMessage, 'assistant', true);
                }
                
            } finally {
                isStreaming = false;
                setInputState(true);
                document.getElementById('chatInput')?.focus();
            }
        }

        function updateCurrentConversation() {
            if (!currentConversationId) return;
            const conversation = recentConversations.find(conv => conv.id === currentConversationId);
            if (conversation) {
                conversation.messages = [...chatHistory];
                conversation.timestamp = new Date();
                const index = recentConversations.indexOf(conversation);
                if (index > 0) {
                    recentConversations.splice(index, 1);
                    recentConversations.unshift(conversation);
                    updateRecentItems();
                }
            }
        }

        function addMessage(content, role, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.setAttribute('data-message-id', messageId);
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user' ? 'H' : `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (role === 'assistant') renderFormattedMessage(content, messageContent);
            else messageContent.textContent = content;
            
            if (isError) messageContent.style.color = '#ff6b6b';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            scrollToBottom();
            return { messageId, messageContent };
        }
        
        function renderFormattedMessage(content, container) {
            container.innerHTML = ''; 
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let lastIndex = 0;
            let match;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                if (match.index > lastIndex) {
                    const textPart = document.createElement('div');
                    textPart.className = 'message-text-part';
                    textPart.textContent = content.substring(lastIndex, match.index);
                    container.appendChild(textPart);
                }

                const [fullMatch, language, code] = match;
                container.appendChild(createArtifactCanvas(code.trim(), language || 'text'));
                lastIndex = match.index + fullMatch.length;
            }

            if (lastIndex < content.length) {
                 const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content.substring(lastIndex);
                container.appendChild(textPart);
            }
            
            if (container.children.length === 0 && content) {
                 const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content;
                container.appendChild(textPart);
            }
        }

        function createArtifactCanvas(code, language) {
            const canvas = document.createElement('div');
            canvas.className = 'artifact-canvas';

            const header = document.createElement('div');
            header.className = 'artifact-header';
            
            const title = document.createElement('div');
            title.className = 'artifact-title';
            title.textContent = language ? `${language} code` : 'Code Artifact';
            
            const actions = document.createElement('div');
            actions.className = 'artifact-actions';

            if (language.toLowerCase() === 'html') {
                const viewBtn = document.createElement('button');
                viewBtn.className = 'artifact-btn view-btn';
                viewBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> View`;
                viewBtn.onclick = () => {
                    const blob = new Blob([code], { type: 'text/html' });
                    window.open(URL.createObjectURL(blob), '_blank');
                };
                actions.appendChild(viewBtn);
            }
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'artifact-btn';
            const copyIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy`;
            copyBtn.innerHTML = copyIcon;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(code).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.innerHTML = copyIcon; }, 2000);
                });
            };

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'artifact-btn';
            downloadBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Download`;
            downloadBtn.onclick = () => {
                const extensionMap = { javascript: 'js', python: 'py', html: 'html', css: 'css', json: 'json' };
                const extension = extensionMap[language.toLowerCase()] || 'txt';
                const filename = `claude-code.${extension}`;
                const blob = new Blob([code], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                a.remove();
            };

            actions.appendChild(copyBtn);
            actions.appendChild(downloadBtn);
            header.appendChild(title);
            header.appendChild(actions);

            const codeArea = document.createElement('div');
            codeArea.className = 'artifact-code';
            const pre = document.createElement('pre');
            const codeEl = document.createElement('code');
            codeEl.textContent = code;
            pre.appendChild(codeEl);
            codeArea.appendChild(pre);

            canvas.appendChild(header);
            canvas.appendChild(codeArea);

            return canvas;
        }

        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
                scrollToBottom();
            }
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function setInputState(enabled) {
            const inputs = [
                document.getElementById('welcomeInput'),
                document.getElementById('chatInput'),
                document.getElementById('sendBtn'),
                document.getElementById('chatSendBtn')
            ];
            inputs.forEach(input => {
                if (input) {
                    input.disabled = !enabled;
                    input.style.opacity = enabled ? '1' : '0.6';
                }
            });
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                requestAnimationFrame(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
        }

        function autoResize(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    </script>
</body>
</html>        <div style="max-width: 600px; margin-bottom: 15px; padding: 12px; background-color: #2a2a2a; border-radius: 8px; border: 1px solid #404040;">
          <div style="font-size: 13px; color: #b3b3b3; text-align: center; margin-bottom: 10px;">
            üí° <strong>First time?</strong> A small popup will appear for authentication
          </div>
          <div style="font-size: 12px; color: #808080; text-align: center; margin-bottom: 10px;" id="protocolNotice"></div>
          <div style="text-align: center;">
            <button id="authButton" style="background-color: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
              üîê Authenticate with Puter
            </button>
          </div>
        </div>

        <!-- Model selector & action buttons unchanged -->
      </div>

      <!-- Chat Container -->
      <div class="chat-container" id="chatContainer">
        <div class="chat-messages" id="chatMessages"></div>
        <!-- Typing indicator & chat input unchanged -->
      </div>
    </div>
  </div>
</div>

<script>
// ===== Global Variables & Models =====
const availableModels = [
  { apiName: 'claude-sonnet-4', displayName: 'Claude Sonnet 4', shortName: 'Sonnet 4' },
  { apiName: 'claude-opus-4', displayName: 'Claude Opus 4', shortName: 'Opus 4' },
  { apiName: 'claude-3-7-sonnet', displayName: 'Claude 3.7 Sonnet', shortName: 'Sonnet 3.7' }
];
let currentModel = availableModels[0].apiName;
let chatHistory = [];
let isStreaming = false;
let recentConversations = [];
let currentConversationId = null;

// ===== Page Initialization =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing Claude interface...');
  initializeInterface();
  updateModelDisplay();
  updateProtocolNotice();
  tryAutoAuth(); // <-- Automatic guest authentication
});

// ===== Update Protocol Notice =====
function updateProtocolNotice() {
  const protocolNotice = document.getElementById('protocolNotice');
  if (!protocolNotice) return;

  if (window.location.protocol === 'file:') {
    protocolNotice.innerHTML = '‚úÖ <strong>File mode:</strong> Authentication should work!';
    protocolNotice.style.color = '#22c55e';
  } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    protocolNotice.innerHTML = '‚ö†Ô∏è <strong>Server mode:</strong> If auth fails, browser profile issues are likely.';
    protocolNotice.style.color = '#f59e0b';
  } else {
    protocolNotice.innerHTML = 'üåê <strong>Web mode:</strong> Make sure popups are allowed.';
    protocolNotice.style.color = '#3b82f6';
  }
}

// ===== Automatic Guest Authentication =====
async function tryAutoAuth() {
  const authButton = document.getElementById('authButton');
  const authBox = authButton?.closest('div[style*="max-width: 600px"]');
  if (authButton) {
    authButton.textContent = 'üîÑ Trying guest login...';
    authButton.disabled = true;
  }

  try {
    console.log('üîÑ Attempting automatic guest authentication...');
    const resp = await puter.ai.chat("test", { model: 'claude-sonnet-4' });
    console.log('‚úÖ Auto-auth successful!', resp);

    if (authBox) authBox.style.display = 'none';
    if (authButton) {
      authButton.textContent = '‚úÖ Authenticated';
      authButton.style.backgroundColor = '#22c55e';
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Auto-auth failed, showing manual login:', error);
    if (authBox) authBox.style.display = 'block';
    if (authButton) {
      authButton.textContent = 'üîê Authenticate with Puter';
      authButton.disabled = false;
      authButton.style.backgroundColor = '#ff6b35';
    }
  }
}

// ===== Manual Auth Handler =====
async function handleManualAuth() {
  const authButton = document.getElementById('authButton');
  if (authButton) {
    authButton.textContent = 'üîÑ Authenticating...';
    authButton.disabled = true;
  }

  try {
    const authResponse = await puter.ai.chat("test", { model: 'claude-sonnet-4' });
    if (authResponse) {
      console.log('‚úÖ Authentication successful!');
      if (authButton) {
        authButton.textContent = '‚úÖ Authenticated';
        authButton.style.backgroundColor = '#22c55e';
        setTimeout(() => {
          const authBox = authButton.closest('div[style*="max-width: 600px"]');
          if (authBox) authBox.style.display = 'none';
        }, 2000);
      }
    }
  } catch (error) {
    console.error('‚ùå Manual authentication failed:', error);
    if (authButton) {
      authButton.textContent = '‚ùå Auth Failed';
      authButton.disabled = false;
      authButton.style.backgroundColor = '#dc2626';
    }
    alert('Authentication failed. Try in Incognito/Private Mode or check cookies/extensions.');
  }
}

// ===== Initialize Interface =====
function initializeInterface() {
  const welcomeInput = document.getElementById('welcomeInput');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatSendBtn = document.getElementById('chatSendBtn');
  const newChatBtn = document.getElementById('newChatBtn');
  const actionBtns = document.querySelectorAll('.action-btn');
  const modelSelectors = document.querySelectorAll('#modelSelector, #chatModelSelector');
  const authButton = document.getElementById('authButton');

  if (authButton) authButton.addEventListener('click', handleManualAuth);

  [welcomeInput, chatInput].forEach(textarea => {
    if (textarea) {
      textarea.addEventListener('input', () => autoResize(textarea));
      textarea.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (textarea === welcomeInput) handleWelcomeMessage();
          else handleChatMessage();
        }
      });
    }
  });

  if (sendBtn) sendBtn.addEventListener('click', handleWelcomeMessage);
  if (chatSendBtn) chatSendBtn.addEventListener('click', handleChatMessage);
  if (newChatBtn) newChatBtn.addEventListener('click', startNewChat);

  actionBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const prompt = this.getAttribute('data-prompt');
      if (prompt && welcomeInput) {
        welcomeInput.value = prompt;
        welcomeInput.focus();
        autoResize(welcomeInput);
      }
    });
  });

  modelSelectors.forEach(selector => {
    if (selector) selector.addEventListener('click', toggleModel);
  });

  if (welcomeInput) welcomeInput.focus();
  console.log('‚úÖ Interface initialized');
}
        function updateModelDisplay() {
            const model = availableModels.find(m => m.apiName === currentModel);
            if (!model) {
                console.error("Model not found in available models:", currentModel);
                return;
            }
            document.getElementById('currentModel').textContent = model.displayName;
            document.getElementById('chatCurrentModel').textContent = model.shortName;
        }

        function toggleModel() {
            const currentIndex = availableModels.findIndex(m => m.apiName === currentModel);
            const nextIndex = (currentIndex + 1) % availableModels.length;
            currentModel = availableModels[nextIndex].apiName;
            updateModelDisplay();
            console.log('üîÑ Model switched to:', availableModels[nextIndex].displayName);
        }

        async function handleWelcomeMessage() {
            const welcomeInput = document.getElementById('welcomeInput');
            const message = welcomeInput.value.trim();
            if (!message || isStreaming) return;
            console.log('üì§ Sending welcome message:', message);
            createNewConversation(message);
            switchToChatView();
            await sendMessage(message);
        }

        async function handleChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || isStreaming) return;
            console.log('üì§ Sending chat message:', message);
            chatInput.value = '';
            autoResize(chatInput);
            await sendMessage(message);
        }

        function createNewConversation(firstMessage) {
            currentConversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const title = firstMessage.length > 50 ? firstMessage.substring(0, 50) + '...' : firstMessage;
            const conversation = {
                id: currentConversationId,
                title: title,
                messages: [],
                timestamp: new Date(),
                model: currentModel
            };
            recentConversations.unshift(conversation);
            if (recentConversations.length > 10) {
                recentConversations = recentConversations.slice(0, 10);
            }
            updateRecentItems();
            console.log('üìù Created new conversation:', title);
        }

        function updateRecentItems() {
            const recentItemsContainer = document.getElementById('recentItems');
            recentItemsContainer.innerHTML = '';
            if (recentConversations.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = '<span style="color: #666; font-size: 13px; font-style: italic;">No recent conversations</span>';
                recentItemsContainer.appendChild(emptyDiv);
            } else {
                recentConversations.forEach(conversation => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'recent-item';
                    itemDiv.textContent = conversation.title;
                    itemDiv.addEventListener('click', () => loadConversation(conversation.id));
                    recentItemsContainer.appendChild(itemDiv);
                });
            }
        }

        function loadConversation(conversationId) {
            const conversation = recentConversations.find(conv => conv.id === conversationId);
            if (!conversation) return;
            currentConversationId = conversationId;
            chatHistory = [...conversation.messages];
            currentModel = conversation.model;
            updateModelDisplay();
            switchToChatView();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            conversation.messages.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
            document.getElementById('chatInput').focus();
            console.log('üìÇ Loaded conversation:', conversation.title);
        }

        function switchToChatView() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatContainer').classList.add('active');
            console.log('üîÑ Switched to chat view');
        }

        function startNewChat() {
            chatHistory = [];
            currentConversationId = null;
            
            // --- BUG FIX: Reset model to default on new chat ---
            currentModel = availableModels[0].apiName;
            updateModelDisplay();
            
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatContainer = document.getElementById('chatContainer');
            const chatMessages = document.getElementById('chatMessages');
            const welcomeInput = document.getElementById('welcomeInput');
            
            if (welcomeScreen) welcomeScreen.style.display = 'flex';
            if (chatContainer) chatContainer.classList.remove('active');
            if (chatMessages) chatMessages.innerHTML = '';
            if (welcomeInput) {
                welcomeInput.value = '';
                autoResize(welcomeInput);
                welcomeInput.focus();
            }
            autoResize(document.getElementById('chatInput'));
            
            console.log('üÜï Started new chat, model reset to default.');
        }

        async function sendMessage(message) {
            if (isStreaming) return;
            
            console.log('üöÄ Starting to send message...');
            addMessage(message, 'user');
            showTypingIndicator();
            setInputState(false);

            chatHistory.push({ role: 'user', content: message });
            
            try {
                isStreaming = true;
                if (typeof puter === 'undefined') { throw new Error('Puter.js is not available.'); }
                console.log('üì° Calling Puter AI with model:', currentModel, 'and full history.');
                
                const response = await puter.ai.chat(chatHistory, {
                    model: currentModel,
                    stream: true
                });

                if (response && response.success === false) {
                    throw new Error('Authentication required. Please click the authenticate button and allow the popup.');
                }
                
                const { messageContent } = addMessage('', 'assistant');
                hideTypingIndicator();
                let fullResponse = '';
                
                for await (const part of response) {
                    if (part?.text) {
                        fullResponse += part.text;
                        renderFormattedMessage(fullResponse, messageContent);
                        scrollToBottom();
                    }
                }
                
                console.log('‚úÖ Streaming complete.');
                renderFormattedMessage(fullResponse, messageContent); 
                
                chatHistory.push({ role: 'assistant', content: fullResponse });
                updateCurrentConversation();
                
            } catch (error) {
                console.error('‚ùå Error in sendMessage:', error);
                hideTypingIndicator();
                addMessage('Sorry, I encountered an error: ' + (error.message || 'Unknown error.'), 'assistant', true);
                
                // FIX: The API call failed, so the optimistic user message added to the history
                // resulted in an invalid state. Remove it to allow the user to try again.
                if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
                    chatHistory.pop();
                }

            } finally {
                isStreaming = false;
                setInputState(true);
                document.getElementById('chatInput')?.focus();
            }
        }

        function updateCurrentConversation() {
            if (!currentConversationId) return;
            const conversation = recentConversations.find(conv => conv.id === currentConversationId);
            if (conversation) {
                conversation.messages = [...chatHistory];
                conversation.timestamp = new Date();
                const index = recentConversations.indexOf(conversation);
                if (index > 0) {
                    recentConversations.splice(index, 1);
                    recentConversations.unshift(conversation);
                    updateRecentItems();
                }
            }
        }

        function addMessage(content, role, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.setAttribute('data-message-id', messageId);
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user' ? 'H' : `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (role === 'assistant') renderFormattedMessage(content, messageContent);
            else messageContent.textContent = content;
            
            if (isError) messageContent.style.color = '#ff6b6b';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            scrollToBottom();
            return { messageId, messageContent };
        }
        
        function renderFormattedMessage(content, container) {
            container.innerHTML = ''; // Clear previous content
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let lastIndex = 0;
            let match;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                if (match.index > lastIndex) {
                    const textPart = document.createElement('div');
                    textPart.className = 'message-text-part';
                    textPart.textContent = content.substring(lastIndex, match.index);
                    container.appendChild(textPart);
                }

                const [fullMatch, language, code] = match;
                container.appendChild(createArtifactCanvas(code.trim(), language || 'text'));
                lastIndex = match.index + fullMatch.length;
            }

            if (lastIndex < content.length) {
                 const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content.substring(lastIndex);
                container.appendChild(textPart);
            }
            
            if (container.children.length === 0 && content) {
                 const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content;
                container.appendChild(textPart);
            }
        }

        function createArtifactCanvas(code, language) {
            const canvas = document.createElement('div');
            canvas.className = 'artifact-canvas';

            const header = document.createElement('div');
            header.className = 'artifact-header';
            
            const title = document.createElement('div');
            title.className = 'artifact-title';
            title.textContent = language ? `${language} code` : 'Code Artifact';
            
            const actions = document.createElement('div');
            actions.className = 'artifact-actions';

            if (language.toLowerCase() === 'html') {
                const viewBtn = document.createElement('button');
                viewBtn.className = 'artifact-btn view-btn';
                viewBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> View`;
                viewBtn.onclick = () => {
                    const blob = new Blob([code], { type: 'text/html' });
                    window.open(URL.createObjectURL(blob), '_blank');
                };
                actions.appendChild(viewBtn);
            }
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'artifact-btn';
            const copyIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy`;
            copyBtn.innerHTML = copyIcon;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(code).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.innerHTML = copyIcon; }, 2000);
                });
            };

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'artifact-btn';
            downloadBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Download`;
            downloadBtn.onclick = () => {
                const extensionMap = { javascript: 'js', python: 'py', html: 'html', css: 'css', json: 'json', java: 'java', csharp: 'cs', cpp: 'cpp', ruby: 'rb', go: 'go', rust: 'rs', shell: 'sh', bash: 'sh' };
                const extension = extensionMap[language.toLowerCase()] || 'txt';
                const filename = `claude-code.${extension}`;
                const blob = new Blob([code], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                a.remove();
            };

            actions.appendChild(copyBtn);
            actions.appendChild(downloadBtn);
            header.appendChild(title);
            header.appendChild(actions);

            const codeArea = document.createElement('div');
            codeArea.className = 'artifact-code';
            const pre = document.createElement('pre');
            const codeEl = document.createElement('code');
            codeEl.textContent = code;
            pre.appendChild(codeEl);
            codeArea.appendChild(pre);

            canvas.appendChild(header);
            canvas.appendChild(codeArea);

            return canvas;
        }

        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
                scrollToBottom();
            }
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function setInputState(enabled) {
            const inputs = [
                document.getElementById('welcomeInput'),
                document.getElementById('chatInput'),
                document.getElementById('sendBtn'),
                document.getElementById('chatSendBtn')
            ];
            inputs.forEach(input => {
                if (input) {
                    input.disabled = !enabled;
                    input.style.opacity = enabled ? '1' : '0.6';
                }
            });
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                requestAnimationFrame(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
        }

        function autoResize(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    </script>
</body>
</html>        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #404040;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 16px;
        }

        .back-arrow {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #ff6b35;
            font-size: 14px;
            padding: 8px 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .new-chat-btn:hover {
            opacity: 0.8;
        }

        .plus-icon {
            width: 16px;
            height: 16px;
            background-color: #ff6b35;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .sidebar-nav {
            padding: 16px;
            border-bottom: 1px solid #404040;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: #b3b3b3;
            font-size: 14px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item:hover {
            color: #fff;
        }

        .nav-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .sidebar-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 12px;
            color: #808080;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-items {
            min-height: 20px;
        }

        .recent-item {
            padding: 8px 0;
            color: #b3b3b3;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-item:hover {
            color: #fff;
        }

        .empty-state {
            padding: 8px 0;
            text-align: center;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #404040;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            background-color: #ff6b35;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            color: #fff;
            font-weight: 500;
        }

        .user-plan {
            font-size: 12px;
            color: #808080;
        }

        .chevron-down {
            width: 16px;
            height: 16px;
            opacity: 0.5;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 40px;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            margin-bottom: 20px;
            height: calc(100vh - 200px);
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #404040 #262626;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #262626;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background-color: #ff6b35;
            color: white;
        }

        .message.assistant .message-avatar {
            background-color: #4a90e2;
            color: white;
        }

        .message-content {
            max-width: 70%;
            background-color: #262626;
            border-radius: 12px;
            padding: 16px;
            color: #e5e5e5;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        .message.assistant .message-content {
            padding: 0; /* Remove padding for container of artifacts */
        }
        .message-text-part {
            padding: 16px;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background-color: #ff6b35;
            color: white;
            padding: 16px; /* Restore padding for user messages */
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #808080;
            font-style: italic;
            padding: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #808080;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .greeting {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            font-size: 32px;
            font-weight: 400;
            color: #fff;
        }

        .sun-icon {
            width: 32px;
            height: 32px;
            color: #ff6b35;
        }

        .search-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            margin-bottom: 20px;
        }

        .chat-container .search-container {
            position: sticky;
            bottom: 0;
            background-color: #1a1a1a;
            padding: 20px 0;
            margin: 0;
            max-width: none;
        }

        .search-input {
            width: 100%;
            padding: 16px 120px 16px 16px;
            background-color: #262626;
            border: 1px solid #404040;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            font-family: inherit;
        }

        .search-input:focus {
            border-color: #ff6b35;
        }

        .search-input::placeholder {
            color: #808080;
        }

        .search-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 4px;
        }

        .search-btn {
            padding: 8px;
            background: none;
            border: none;
            color: #808080;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .search-btn:hover {
            background-color: #404040;
        }

        .send-btn {
            padding: 8px;
            background-color: #ff6b35;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background-color: #e55a2b;
        }

        .send-btn:disabled {
            background-color: #404040;
            cursor: not-allowed;
        }

        .model-selector {
            align-self: flex-end;
            margin-bottom: 20px;
            margin-right: 60px;
        }

        .model-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #b3b3b3;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .model-btn:hover {
            background-color: #262626;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background-color: #262626;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #e5e5e5;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .action-btn:hover {
            background-color: #333;
            border-color: #555;
            transform: translateY(-1px);
        }

        .action-icon {
            width: 16px;
            height: 16px;
            opacity: 0.8;
        }
        
        /* Artifact Canvas Styles */
        .artifact-canvas {
            background-color: #0d0d0d;
            border: 1px solid #404040;
            border-radius: 8px;
            margin: 16px;
            overflow: hidden;
        }

        .artifact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2a2a2a;
            padding: 8px 12px;
            border-bottom: 1px solid #404040;
        }

        .artifact-title {
            font-size: 13px;
            font-weight: 500;
            color: #b3b3b3;
        }

        .artifact-actions {
            display: flex;
            gap: 8px;
        }

        .artifact-btn {
            background: none;
            border: 1px solid #555;
            color: #b3b3b3;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .artifact-btn:hover {
            background-color: #404040;
            color: #fff;
        }
        
        .artifact-btn.view-btn {
            border-color: #4a90e2;
            color: #4a90e2;
        }
        .artifact-btn.view-btn:hover {
            background-color: #4a90e2;
            color: #fff;
        }

        .artifact-btn svg {
            width: 14px;
            height: 14px;
        }

        .artifact-code {
            padding: 12px;
            max-height: 400px;
            overflow: auto;
            scrollbar-width: thin;
            scrollbar-color: #404040 #1a1a1a;
        }
        
        .artifact-code pre {
            margin: 0;
        }

        .artifact-code code {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            color: #e5e5e5;
            white-space: pre;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }
            
            .greeting {
                font-size: 24px;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .action-btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg class="back-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                    Claude
                </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <div class="plus-icon">+</div>
                    New chat
                </button>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/>
                    </svg>
                    Chats
                </div>
                <div class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    Projects
                </div>
                <div class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Artifacts
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="section-title">Recents</div>
                <div class="recent-items" id="recentItems">
                    <div class="empty-state" id="emptyState">
                        <span style="color: #666; font-size: 13px; font-style: italic;">No recent conversations</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">H</div>
                    <div class="user-details">
                        <div class="user-name">Hassan</div>
                        <div class="user-plan">Pro plan</div>
                    </div>
                    <svg class="chevron-down" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="content-area">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="greeting">
                        <svg class="sun-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                        </svg>
                        Good morning, Hassan
                    </div>
                    
                    <div class="search-container">
                        <textarea class="search-input" id="welcomeInput" placeholder="How can I help you today?" rows="1"></textarea>
                        <div class="search-actions">
                            <button class="search-btn" id="researchBtn">Research</button>
                            <button class="send-btn" id="sendBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div style="max-width: 600px; margin-bottom: 15px; padding: 12px; background-color: #2a2a2a; border-radius: 8px; border: 1px solid #404040;">
                        <div style="font-size: 13px; color: #b3b3b3; text-align: center; margin-bottom: 10px;">
                            üí° <strong>First time?</strong> A small popup will appear for authentication - please allow it to enable free Claude access via Puter.js
                        </div>
                        <div style="font-size: 12px; color: #808080; text-align: center; margin-bottom: 10px;" id="protocolNotice">
                            <!-- This will be populated by JS -->
                        </div>
                        <div style="text-align: center;">
                            <button id="authButton" style="background-color: #ff6b35; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                üîê Authenticate with Puter
                            </button>
                        </div>
                    </div>
                    
                    <div class="model-selector">
                        <button class="model-btn" id="modelSelector">
                            <span id="currentModel">Claude Sonnet 4</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn" data-prompt="Help me write">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                            Write
                        </button>
                        <button class="action-btn" data-prompt="Teach me about">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6L23 9l-11-6zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
                            </svg>
                            Learn
                        </button>
                        <button class="action-btn" data-prompt="Help me code">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                            </svg>
                            Code
                        </button>
                        <button class="action-btn" data-prompt="Help me with daily tasks">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Life stuff
                        </button>
                        <button class="action-btn" data-prompt="Help me connect my apps">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H6.99C4.79 7 3 8.79 3 11s1.79 4 4 4H11v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1H13V17h4.01c2.2 0 4-1.79 4-4s-1.8-4-4.01-4z"/>
                            </svg>
                            Connect apps
                        </button>
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="chat-container" id="chatContainer">
                    <div class="chat-messages" id="chatMessages"></div>
                    
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="message-avatar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span>Claude is typing</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                    
                    <div class="search-container">
                        <textarea class="search-input" id="chatInput" placeholder="Message Claude..." rows="1"></textarea>
                        <div class="search-actions">
                            <button class="model-btn" id="chatModelSelector" style="padding: 6px 8px; font-size: 12px;">
                                <span id="chatCurrentModel">Sonnet 4</span>
                            </button>
                            <button class="send-btn" id="chatSendBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        const availableModels = [
            { apiName: 'claude-sonnet-4', displayName: 'Claude Sonnet 4', shortName: 'Sonnet 4' },
            { apiName: 'claude-opus-4', displayName: 'Claude Opus 4', shortName: 'Opus 4' },
            { apiName: 'claude-3-7-sonnet', displayName: 'Claude 3.7 Sonnet', shortName: 'Sonnet 3.7' }
        ];
        let currentModel = availableModels[0].apiName;
        let chatHistory = [];
        let isStreaming = false;
        let recentConversations = [];
        let currentConversationId = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Claude interface...');
            initializeInterface();
            updateModelDisplay();
            updateProtocolNotice();
        });

        function updateProtocolNotice() {
            const protocolNotice = document.getElementById('protocolNotice');
            if (protocolNotice) {
                if (window.location.protocol === 'file:') {
                    protocolNotice.innerHTML = '‚úÖ <strong>File mode:</strong> Authentication should work perfectly here!';
                    protocolNotice.style.color = '#22c55e';
                } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    protocolNotice.innerHTML = '‚ö†Ô∏è <strong>Server mode:</strong> If auth fails, browser profile issues are likely. See guide below.';
                    protocolNotice.style.color = '#f59e0b';
                } else {
                    protocolNotice.innerHTML = 'üåê <strong>Web mode:</strong> Make sure popups are allowed for this domain.';
                    protocolNotice.style.color = '#3b82f6';
                }
            }
        }

        async function handleManualAuth() {
            const authButton = document.getElementById('authButton');
            
            try {
                if (authButton) {
                    authButton.textContent = 'üîÑ Authenticating...';
                    authButton.disabled = true;
                }
                
                console.log('üîê Manually triggering Puter authentication...');
                
                // Trigger authentication with a simple test call
                const authResponse = await puter.ai.chat("test", {model: 'claude-sonnet-4'});
                
                console.log('‚úÖ Raw auth response:', authResponse);

                // Check for a successful response structure
                if (authResponse && (authResponse.message?.content || authResponse.success !== false)) {
                     console.log('‚úÖ Authentication successful!');
                    if (authButton) {
                        authButton.textContent = '‚úÖ Authenticated';
                        authButton.style.backgroundColor = '#22c55e';
                        setTimeout(() => {
                           const authBox = authButton.closest('div[style*="max-width: 600px"]');
                           if(authBox) authBox.style.display = 'none';
                        }, 2000);
                    }
                } else {
                    throw new Error('Authentication response indicates failure.');
                }
                
            } catch (error) {
                console.error('‚ùå Manual authentication failed:', error);
                
                if (authButton) {
                    authButton.textContent = '‚ùå Auth Failed - Try Guide';
                    authButton.disabled = false;
                    authButton.style.backgroundColor = '#dc2626';
                }
                
                // --- ENHANCED ERROR MESSAGE ---
                const troubleshootGuide = `
‚ö†Ô∏è AUTHENTICATION FAILED!

This usually happens because of your browser profile settings (extensions, cache, etc.), NOT a bug in the code.

As you noticed, it works in a new Guest or Incognito profile. Here is how to fix it in your MAIN profile:

--- TROUBLESHOOTING GUIDE ---

‚úÖ QUICKEST FIX (TRY FIRST):
1.  ü•∑ Use Incognito/Private Mode:
    ‚Ä¢ Press Ctrl+Shift+N (Chrome/Edge) or Ctrl+Shift+P (Firefox).
    ‚Ä¢ Open this HTML file there. This is the fastest workaround.

üîß TO FIX YOUR MAIN PROFILE (TRY IN ORDER):
2.  üîå Disable Extensions:
    ‚Ä¢ Go to your browser's extensions page (e.g., chrome://extensions).
    ‚Ä¢ TEMPORARILY disable ALL extensions, especially ad-blockers (uBlock, AdBlock) and privacy blockers.
    ‚Ä¢ Refresh this page and try authenticating again.

3.  üßπ Clear Site Data for Puter:
    ‚Ä¢ Go to puter.com, click the üîí icon in the address bar -> Site Settings/Cookies and site data -> Delete data.
    ‚Ä¢ Refresh this page and try again.

4.  üç™ Allow Third-Party Cookies:
    ‚Ä¢ Go to your browser's cookie settings (e.g., chrome://settings/cookies).
    ‚Ä¢ Ensure "Block third-party cookies" is NOT enabled, or add "[*.]puter.com" to the allowed list.

If you are running this from a local server (like localhost), the issue is almost certainly extensions or cookie settings.
`;
                alert(troubleshootGuide);
            }
        }

        function initializeInterface() {
            const welcomeInput = document.getElementById('welcomeInput');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const newChatBtn = document.getElementById('newChatBtn');
            const actionBtns = document.querySelectorAll('.action-btn');
            const modelSelectors = document.querySelectorAll('#modelSelector, #chatModelSelector');
            const authButton = document.getElementById('authButton');

            if (authButton) authButton.addEventListener('click', handleManualAuth);

            [welcomeInput, chatInput].forEach(textarea => {
                if (textarea) {
                    textarea.addEventListener('input', () => autoResize(textarea));
                    textarea.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (textarea === welcomeInput) handleWelcomeMessage();
                            else handleChatMessage();
                        }
                    });
                }
            });

            if (sendBtn) sendBtn.addEventListener('click', handleWelcomeMessage);
            if (chatSendBtn) chatSendBtn.addEventListener('click', handleChatMessage);
            if (newChatBtn) newChatBtn.addEventListener('click', startNewChat);

            actionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const prompt = this.getAttribute('data-prompt');
                    if (prompt && welcomeInput) {
                        welcomeInput.value = prompt;
                        welcomeInput.focus();
                        autoResize(welcomeInput);
                    }
                });
            });

            modelSelectors.forEach(selector => {
                if (selector) selector.addEventListener('click', toggleModel);
            });

            if (welcomeInput) welcomeInput.focus();
            console.log('‚úÖ Interface initialized');
        }

        function updateModelDisplay() {
            const model = availableModels.find(m => m.apiName === currentModel);
            if (!model) {
                console.error("Model not found in available models:", currentModel);
                return;
            }
            document.getElementById('currentModel').textContent = model.displayName;
            document.getElementById('chatCurrentModel').textContent = model.shortName;
        }

        function toggleModel() {
            const currentIndex = availableModels.findIndex(m => m.apiName === currentModel);
            const nextIndex = (currentIndex + 1) % availableModels.length;
            currentModel = availableModels[nextIndex].apiName;
            updateModelDisplay();
            console.log('üîÑ Model switched to:', availableModels[nextIndex].displayName);
        }

        async function handleWelcomeMessage() {
            const welcomeInput = document.getElementById('welcomeInput');
            const message = welcomeInput.value.trim();
            if (!message || isStreaming) return;
            console.log('üì§ Sending welcome message:', message);
            createNewConversation(message);
            switchToChatView();
            await sendMessage(message);
        }

        async function handleChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message || isStreaming) return;
            console.log('üì§ Sending chat message:', message);
            chatInput.value = '';
            autoResize(chatInput);
            await sendMessage(message);
        }

        function createNewConversation(firstMessage) {
            currentConversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const title = firstMessage.length > 50 ? firstMessage.substring(0, 50) + '...' : firstMessage;
            const conversation = {
                id: currentConversationId,
                title: title,
                messages: [],
                timestamp: new Date(),
                model: currentModel
            };
            recentConversations.unshift(conversation);
            if (recentConversations.length > 10) {
                recentConversations = recentConversations.slice(0, 10);
            }
            updateRecentItems();
            console.log('üìù Created new conversation:', title);
        }

        function updateRecentItems() {
            const recentItemsContainer = document.getElementById('recentItems');
            recentItemsContainer.innerHTML = '';
            if (recentConversations.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = '<span style="color: #666; font-size: 13px; font-style: italic;">No recent conversations</span>';
                recentItemsContainer.appendChild(emptyDiv);
            } else {
                recentConversations.forEach(conversation => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'recent-item';
                    itemDiv.textContent = conversation.title;
                    itemDiv.addEventListener('click', () => loadConversation(conversation.id));
                    recentItemsContainer.appendChild(itemDiv);
                });
            }
        }

        function loadConversation(conversationId) {
            const conversation = recentConversations.find(conv => conv.id === conversationId);
            if (!conversation) return;
            currentConversationId = conversationId;
            chatHistory = [...conversation.messages];
            currentModel = conversation.model;
            updateModelDisplay();
            switchToChatView();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            conversation.messages.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
            document.getElementById('chatInput').focus();
            console.log('üìÇ Loaded conversation:', conversation.title);
        }

        function switchToChatView() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatContainer').classList.add('active');
            console.log('üîÑ Switched to chat view');
        }

        function startNewChat() {
            chatHistory = [];
            currentConversationId = null;
            
            // --- BUG FIX: Reset model to default on new chat ---
            currentModel = availableModels[0].apiName;
            updateModelDisplay();
            
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatContainer = document.getElementById('chatContainer');
            const chatMessages = document.getElementById('chatMessages');
            const welcomeInput = document.getElementById('welcomeInput');
            
            if (welcomeScreen) welcomeScreen.style.display = 'flex';
            if (chatContainer) chatContainer.classList.remove('active');
            if (chatMessages) chatMessages.innerHTML = '';
            if (welcomeInput) {
                welcomeInput.value = '';
                autoResize(welcomeInput);
                welcomeInput.focus();
            }
            autoResize(document.getElementById('chatInput'));
            
            console.log('üÜï Started new chat, model reset to default.');
        }

        async function sendMessage(message) {
            if (isStreaming) return;
            
            console.log('üöÄ Starting to send message...');
            addMessage(message, 'user');
            showTypingIndicator();
            setInputState(false);

            chatHistory.push({ role: 'user', content: message });
            
            try {
                isStreaming = true;
                if (typeof puter === 'undefined') { throw new Error('Puter.js is not available.'); }
                console.log('üì° Calling Puter AI with model:', currentModel, 'and full history.');
                
                const response = await puter.ai.chat(chatHistory, {
                    model: currentModel,
                    stream: true
                });

                if (response && response.success === false) {
                    throw new Error('Authentication required. Please click the authenticate button and allow the popup.');
                }
                
                const { messageContent } = addMessage('', 'assistant');
                hideTypingIndicator();
                let fullResponse = '';
                
                for await (const part of response) {
                    if (part?.text) {
                        fullResponse += part.text;
                        renderFormattedMessage(fullResponse, messageContent);
                        scrollToBottom();
                    }
                }
                
                console.log('‚úÖ Streaming complete.');
                renderFormattedMessage(fullResponse, messageContent); 
                
                chatHistory.push({ role: 'assistant', content: fullResponse });
                updateCurrentConversation();
                
            } catch (error) {
                console.error('‚ùå Error in sendMessage:', error);
                hideTypingIndicator();
                addMessage('Sorry, I encountered an error: ' + (error.message || 'Unknown error.'), 'assistant', true);
                
                // FIX: The API call failed, so the optimistic user message added to the history
                // resulted in an invalid state. Remove it to allow the user to try again.
                if (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === 'user') {
                    chatHistory.pop();
                }

            } finally {
                isStreaming = false;
                setInputState(true);
                document.getElementById('chatInput')?.focus();
            }
        }

        function updateCurrentConversation() {
            if (!currentConversationId) return;
            const conversation = recentConversations.find(conv => conv.id === currentConversationId);
            if (conversation) {
                conversation.messages = [...chatHistory];
                conversation.timestamp = new Date();
                const index = recentConversations.indexOf(conversation);
                if (index > 0) {
                    recentConversations.splice(index, 1);
                    recentConversations.unshift(conversation);
                    updateRecentItems();
                }
            }
        }

        function addMessage(content, role, isError = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.setAttribute('data-message-id', messageId);
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user' ? 'H' : `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (role === 'assistant') renderFormattedMessage(content, messageContent);
            else messageContent.textContent = content;
            
            if (isError) messageContent.style.color = '#ff6b6b';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            scrollToBottom();
            return { messageId, messageContent };
        }
        
        function renderFormattedMessage(content, container) {
            container.innerHTML = ''; // Clear previous content
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let lastIndex = 0;
            let match;

            while ((match = codeBlockRegex.exec(content)) !== null) {
                if (match.index > lastIndex) {
                    const textPart = document.createElement('div');
                    textPart.className = 'message-text-part';
                    textPart.textContent = content.substring(lastIndex, match.index);
                    container.appendChild(textPart);
                }

                const [fullMatch, language, code] = match;
                container.appendChild(createArtifactCanvas(code.trim(), language || 'text'));
                lastIndex = match.index + fullMatch.length;
            }

            if (lastIndex < content.length) {
                 const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content.substring(lastIndex);
                container.appendChild(textPart);
            }
            
            if (container.children.length === 0 && content) {
                 const textPart = document.createElement('div');
                textPart.className = 'message-text-part';
                textPart.textContent = content;
                container.appendChild(textPart);
            }
        }

        function createArtifactCanvas(code, language) {
            const canvas = document.createElement('div');
            canvas.className = 'artifact-canvas';

            const header = document.createElement('div');
            header.className = 'artifact-header';
            
            const title = document.createElement('div');
            title.className = 'artifact-title';
            title.textContent = language ? `${language} code` : 'Code Artifact';
            
            const actions = document.createElement('div');
            actions.className = 'artifact-actions';

            if (language.toLowerCase() === 'html') {
                const viewBtn = document.createElement('button');
                viewBtn.className = 'artifact-btn view-btn';
                viewBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> View`;
                viewBtn.onclick = () => {
                    const blob = new Blob([code], { type: 'text/html' });
                    window.open(URL.createObjectURL(blob), '_blank');
                };
                actions.appendChild(viewBtn);
            }
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'artifact-btn';
            const copyIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy`;
            copyBtn.innerHTML = copyIcon;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(code).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.innerHTML = copyIcon; }, 2000);
                });
            };

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'artifact-btn';
            downloadBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Download`;
            downloadBtn.onclick = () => {
                const extensionMap = { javascript: 'js', python: 'py', html: 'html', css: 'css', json: 'json', java: 'java', csharp: 'cs', cpp: 'cpp', ruby: 'rb', go: 'go', rust: 'rs', shell: 'sh', bash: 'sh' };
                const extension = extensionMap[language.toLowerCase()] || 'txt';
                const filename = `claude-code.${extension}`;
                const blob = new Blob([code], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                a.remove();
            };

            actions.appendChild(copyBtn);
            actions.appendChild(downloadBtn);
            header.appendChild(title);
            header.appendChild(actions);

            const codeArea = document.createElement('div');
            codeArea.className = 'artifact-code';
            const pre = document.createElement('pre');
            const codeEl = document.createElement('code');
            codeEl.textContent = code;
            pre.appendChild(codeEl);
            codeArea.appendChild(pre);

            canvas.appendChild(header);
            canvas.appendChild(codeArea);

            return canvas;
        }

        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'flex';
                scrollToBottom();
            }
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function setInputState(enabled) {
            const inputs = [
                document.getElementById('welcomeInput'),
                document.getElementById('chatInput'),
                document.getElementById('sendBtn'),
                document.getElementById('chatSendBtn')
            ];
            inputs.forEach(input => {
                if (input) {
                    input.disabled = !enabled;
                    input.style.opacity = enabled ? '1' : '0.6';
                }
            });
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                requestAnimationFrame(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
        }

        function autoResize(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    </script>
</body>
</html>
