<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude — AI Chat</title>
    <script src="https://js.puter.com/v2/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-0: #0a0a0a;
            --bg-1: #111111;
            --bg-2: #181818;
            --bg-3: #202020;
            --bg-4: #2a2a2a;
            --border: rgba(255,255,255,0.07);
            --border-hi: rgba(255,255,255,0.13);
            --accent: #ff6b35;
            --accent-glow: rgba(255,107,53,0.18);
            --accent-hi: #ff7d4d;
            --text-1: #f0f0f0;
            --text-2: #909090;
            --text-3: #505050;
            --green: #34d399;
            --red: #f87171;
            --blue: #60a5fa;
            --font: 'DM Sans', -apple-system, sans-serif;
            --mono: 'JetBrains Mono', 'Fira Code', monospace;
            --r: 10px;
            --r-sm: 6px;
            --r-lg: 16px;
            --ease: all 0.18s cubic-bezier(0.4,0,0.2,1);
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            font-family: var(--font);
            background: var(--bg-0);
            color: var(--text-1);
            height: 100vh;
            overflow: hidden;
            font-size: 15px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-4); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-3); }

        /* ── Layout ─────────────────────────── */
        .app { display: flex; height: 100vh; }

        /* ── Sidebar ─────────────────────────── */
        .sidebar {
            width: 256px;
            flex-shrink: 0;
            background: var(--bg-1);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .sb-head {
            padding: 18px 14px 14px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 9px;
            font-size: 16.5px;
            font-weight: 600;
            letter-spacing: -0.3px;
            margin-bottom: 14px;
        }

        .logo-mark {
            width: 26px;
            height: 26px;
            background: var(--accent);
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 14px var(--accent-glow);
            flex-shrink: 0;
        }

        .new-btn {
            display: flex;
            align-items: center;
            gap: 7px;
            width: 100%;
            background: var(--bg-3);
            border: 1px solid var(--border);
            color: var(--text-1);
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font);
            padding: 8px 11px;
            border-radius: var(--r-sm);
            cursor: pointer;
            transition: var(--ease);
        }

        .new-btn:hover { background: var(--bg-4); border-color: var(--border-hi); }
        .new-btn svg { opacity: 0.6; }

        .sb-nav { padding: 8px 6px; border-bottom: 1px solid var(--border); }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 7px 8px;
            border-radius: var(--r-sm);
            color: var(--text-2);
            font-size: 13px;
            cursor: pointer;
            transition: var(--ease);
        }

        .nav-item:hover { color: var(--text-1); background: var(--bg-3); }
        .nav-item svg { opacity: 0.55; flex-shrink: 0; }

        .sb-body { flex: 1; overflow-y: auto; padding: 10px 6px; }

        .sec-label {
            font-size: 10px;
            color: var(--text-3);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0 8px;
            margin-bottom: 6px;
        }

        .recent-item {
            padding: 6px 8px;
            border-radius: var(--r-sm);
            color: var(--text-2);
            font-size: 12.5px;
            cursor: pointer;
            transition: var(--ease);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-item:hover { color: var(--text-1); background: var(--bg-3); }
        .recent-item.active { color: var(--text-1); background: var(--bg-3); }

        .empty-hint {
            padding: 8px;
            color: var(--text-3);
            font-size: 12px;
            font-style: italic;
        }

        .sb-foot {
            padding: 10px 6px;
            border-top: 1px solid var(--border);
        }

        .user-row {
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 7px 8px;
            border-radius: var(--r-sm);
            cursor: pointer;
            transition: var(--ease);
        }

        .user-row:hover { background: var(--bg-3); }

        .user-av {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .user-name { font-size: 13px; font-weight: 500; }
        .user-sub { font-size: 11px; color: var(--text-3); }

        /* ── Main ─────────────────────────── */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-0);
        }

        /* ── Welcome ─────────────────────────── */
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            animation: fadeUp 0.35s ease both;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(14px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .w-greeting {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: -0.5px;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            gap: 11px;
            color: var(--text-1);
        }

        .w-greeting svg {
            color: var(--accent);
            filter: drop-shadow(0 0 8px var(--accent-glow));
            flex-shrink: 0;
        }

        .input-wrap {
            width: 100%;
            max-width: 600px;
            position: relative;
            margin-bottom: 12px;
        }

        .chat-input {
            width: 100%;
            padding: 13px 50px 13px 15px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--r);
            color: var(--text-1);
            font-size: 14.5px;
            font-family: var(--font);
            outline: none;
            resize: none;
            min-height: 50px;
            max-height: 160px;
            line-height: 1.55;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .chat-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .chat-input::placeholder { color: var(--text-3); }
        .chat-input:disabled { opacity: 0.5; cursor: not-allowed; }

        .input-btns {
            position: absolute;
            right: 7px;
            bottom: 7px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .send-btn {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border: none;
            border-radius: var(--r-sm);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--ease);
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--accent-hi);
            box-shadow: 0 0 14px var(--accent-glow);
            transform: scale(1.06);
        }

        .send-btn:disabled { background: var(--bg-4); cursor: not-allowed; transform: none; }

        /* Model pill */
        .model-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .model-pill-wrap { position: relative; }

        .model-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: 100px;
            padding: 5px 10px 5px 9px;
            color: var(--text-2);
            font-size: 12px;
            font-family: var(--mono);
            cursor: pointer;
            transition: var(--ease);
            max-width: 260px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .model-pill:hover { background: var(--bg-3); border-color: var(--border-hi); color: var(--text-1); }

        .m-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 5px var(--green);
            flex-shrink: 0;
            transition: var(--ease);
        }

        .m-dot.spinning {
            background: var(--text-3);
            box-shadow: none;
            animation: pulse 1s ease infinite;
        }

        .m-dot.err { background: var(--red); box-shadow: 0 0 5px var(--red); }

        @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* Model dropdown */
        .m-dropdown {
            position: absolute;
            bottom: calc(100% + 6px);
            left: 0;
            background: var(--bg-2);
            border: 1px solid var(--border-hi);
            border-radius: var(--r);
            width: 300px;
            max-height: 260px;
            overflow-y: auto;
            z-index: 200;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            display: none;
        }

        .m-dropdown.open {
            display: block;
            animation: dropIn 0.14s ease both;
        }

        @keyframes dropIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .m-drop-head {
            padding: 9px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 10.5px;
            color: var(--text-3);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .m-opt {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--ease);
            border-bottom: 1px solid var(--border);
        }

        .m-opt:last-child { border-bottom: none; }
        .m-opt:hover { background: var(--bg-3); }
        .m-opt.picked { background: rgba(255,107,53,0.07); }

        .m-opt-name {
            font-size: 12.5px;
            font-family: var(--mono);
            color: var(--text-1);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 220px;
        }

        .m-check { color: var(--accent); font-size: 13px; }

        /* Auth chip */
        .auth-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,107,53,0.07);
            border: 1px solid rgba(255,107,53,0.2);
            border-radius: 100px;
            padding: 5px 10px;
            color: var(--accent);
            font-size: 12px;
            font-family: var(--font);
            cursor: pointer;
            transition: var(--ease);
            white-space: nowrap;
        }

        .auth-chip:hover { background: rgba(255,107,53,0.13); }
        .auth-chip:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Quick buttons */
        .quick-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
        }

        .quick-btn {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 8px 15px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--r);
            color: var(--text-2);
            font-size: 13px;
            font-family: var(--font);
            cursor: pointer;
            transition: var(--ease);
        }

        .quick-btn:hover {
            background: var(--bg-3);
            border-color: var(--border-hi);
            color: var(--text-1);
            transform: translateY(-1px);
        }

        /* ── Chat View ─────────────────────────── */
        .chat-view {
            display: none;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .chat-view.active { display: flex; }

        .chat-thread {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 28px 0 0;
            scroll-behavior: smooth;
        }

        .thread-inner {
            max-width: 740px;
            margin: 0 auto;
            padding: 0 24px 24px;
        }

        /* Messages */
        .msg {
            display: flex;
            gap: 12px;
            margin-bottom: 26px;
            animation: msgIn 0.22s ease both;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(7px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .msg.user { flex-direction: row-reverse; }

        .msg-av {
            width: 29px;
            height: 29px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .msg.user   .msg-av { background: var(--accent); color: white; box-shadow: 0 0 8px var(--accent-glow); }
        .msg.ai     .msg-av { background: var(--bg-3); border: 1px solid var(--border); color: var(--text-2); }

        .msg-body { max-width: calc(100% - 41px); min-width: 0; }

        .msg.user .msg-body {
            background: var(--accent);
            color: white;
            padding: 11px 15px;
            border-radius: var(--r) 3px var(--r) var(--r);
            font-size: 14.5px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .msg.ai .msg-body {
            color: var(--text-1);
            font-size: 14.5px;
            line-height: 1.7;
        }

        /* Markdown */
        .md p   { margin-bottom: 11px; }
        .md p:last-child { margin-bottom: 0; }
        .md h1  { font-size: 20px; font-weight: 600; margin: 18px 0 8px; letter-spacing: -0.3px; }
        .md h2  { font-size: 17px; font-weight: 600; margin: 14px 0 7px; }
        .md h3  { font-size: 15px; font-weight: 600; margin: 12px 0 6px; }
        .md ul, .md ol { padding-left: 22px; margin-bottom: 11px; }
        .md li  { margin-bottom: 3px; }
        .md strong { font-weight: 600; }
        .md em  { font-style: italic; }
        .md del { opacity: 0.6; }
        .md a   { color: var(--accent); text-decoration: underline; text-underline-offset: 2px; }
        .md a:hover { color: var(--accent-hi); }
        .md blockquote {
            border-left: 3px solid var(--accent);
            margin: 11px 0;
            padding: 8px 14px;
            background: var(--bg-2);
            border-radius: 0 var(--r-sm) var(--r-sm) 0;
            color: var(--text-2);
            font-style: italic;
        }
        .md code {
            background: var(--bg-3);
            color: #f9a875;
            padding: 1px 5px;
            border-radius: 4px;
            font-family: var(--mono);
            font-size: 13px;
        }
        .md hr  { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
        .md table { border-collapse: collapse; width: 100%; margin: 12px 0; font-size: 13.5px; }
        .md th, .md td { border: 1px solid var(--border); padding: 7px 11px; text-align: left; }
        .md th  { background: var(--bg-3); font-weight: 600; }

        /* Code blocks */
        .code-block {
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: var(--r);
            overflow: hidden;
            margin: 12px 0;
        }

        .cb-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 7px 12px;
            background: var(--bg-2);
            border-bottom: 1px solid var(--border);
        }

        .cb-lang {
            font-family: var(--mono);
            font-size: 10.5px;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .cb-acts { display: flex; gap: 5px; }

        .cb-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            background: none;
            border: 1px solid var(--border);
            color: var(--text-3);
            padding: 3px 7px;
            border-radius: 4px;
            font-size: 11px;
            font-family: var(--font);
            cursor: pointer;
            transition: var(--ease);
            white-space: nowrap;
        }

        .cb-btn:hover { border-color: var(--border-hi); color: var(--text-1); background: var(--bg-3); }
        .cb-btn.preview { color: var(--blue); border-color: rgba(96,165,250,0.25); }
        .cb-btn.preview:hover { background: rgba(96,165,250,0.1); border-color: var(--blue); }

        .code-block pre[class*="language-"] {
            background: transparent !important;
            margin: 0;
            padding: 14px 16px;
        }

        .code-block code[class*="language-"] {
            background: transparent;
            font-family: var(--mono);
            font-size: 12.5px;
        }

        /* Typing indicator */
        .typing {
            display: none;
            align-items: center;
            gap: 10px;
            max-width: 740px;
            margin: 0 auto;
            padding: 0 24px 16px;
        }

        .typing.on { display: flex; }

        .t-av {
            width: 29px;
            height: 29px;
            border-radius: 7px;
            background: var(--bg-3);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .t-dots { display: flex; gap: 4px; align-items: center; }

        .t-dot {
            width: 5px;
            height: 5px;
            background: var(--text-3);
            border-radius: 50%;
            animation: bounce 1.2s ease infinite;
        }

        .t-dot:nth-child(1) { animation-delay: 0s; }
        .t-dot:nth-child(2) { animation-delay: 0.14s; }
        .t-dot:nth-child(3) { animation-delay: 0.28s; }

        @keyframes bounce {
            0%,60%,100% { transform: translateY(0); opacity: 0.35; }
            30%          { transform: translateY(-5px); opacity: 1; }
        }

        /* Stream cursor */
        .s-cur {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: var(--accent);
            margin-left: 2px;
            vertical-align: text-bottom;
            animation: blink 0.65s step-end infinite;
        }

        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

        /* Chat input bar */
        .cin-area {
            padding: 10px 24px 18px;
            background: var(--bg-0);
            border-top: 1px solid var(--border);
        }

        .cin-inner {
            max-width: 740px;
            margin: 0 auto;
        }

        .cin-meta {
            display: flex;
            align-items: center;
            margin-bottom: 7px;
        }

        .cin-bar { position: relative; }

        /* Error */
        .msg-err { color: var(--red) !important; }

        .reset-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 9px;
            background: rgba(248,113,113,0.09);
            border: 1px solid rgba(248,113,113,0.25);
            color: var(--red);
            padding: 5px 12px;
            border-radius: var(--r-sm);
            font-size: 12.5px;
            font-family: var(--font);
            cursor: pointer;
            transition: var(--ease);
        }

        .reset-link:hover { background: rgba(248,113,113,0.15); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 22px;
            right: 22px;
            background: var(--bg-4);
            border: 1px solid var(--border-hi);
            border-radius: var(--r-sm);
            padding: 8px 13px;
            font-size: 12.5px;
            color: var(--text-1);
            z-index: 9999;
            opacity: 0;
            transform: translateY(6px);
            transition: all 0.2s ease;
            pointer-events: none;
        }

        .toast.show { opacity: 1; transform: translateY(0); }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { width: 220px; }
            .thread-inner, .cin-area { padding-left: 16px; padding-right: 16px; }
            .w-greeting { font-size: 22px; }
        }

        @media (max-width: 520px) { .sidebar { display: none; } }
    </style>
</head>
<body>
<div class="app">

    <!-- ── Sidebar ─────────────────── -->
    <aside class="sidebar">
        <div class="sb-head">
            <div class="logo">
                <div class="logo-mark">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                Claude
            </div>
            <button class="new-btn" id="newChatBtn">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New conversation
            </button>
        </div>

        <div class="sb-nav">
            <div class="nav-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                All conversations
            </div>
        </div>

        <div class="sb-body">
            <div class="sec-label">Recent</div>
            <div id="recentList"><div class="empty-hint">No conversations yet</div></div>
        </div>

        <div class="sb-foot">
            <div class="user-row">
                <div class="user-av">H</div>
                <div>
                    <div class="user-name">Hassan</div>
                    <div class="user-sub">Free via Puter</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ── Main ─────────────────────── -->
    <main class="main">

        <!-- Welcome Screen -->
        <div class="welcome" id="welcomeScreen">
            <div class="w-greeting">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/>
                </svg>
                <span id="greetingText">Hello, Hassan</span>
            </div>

            <div class="input-wrap">
                <textarea class="chat-input" id="welcomeInput" placeholder="What can I help you with?" rows="1"></textarea>
                <div class="input-btns">
                    <button class="send-btn" id="welcomeSendBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>

            <div class="model-bar">
                <div class="model-pill-wrap">
                    <button class="model-pill" id="welcomePill">
                        <span class="m-dot spinning" id="wDot"></span>
                        <span id="wModelTxt">Loading models…</span>
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </button>
                    <div class="m-dropdown" id="wDropdown">
                        <div class="m-drop-head">Select model</div>
                        <div id="wModelList"></div>
                    </div>
                </div>

                <button class="auth-chip" id="authBtn">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <rect x="3" y="11" width="18" height="11" rx="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <span id="authTxt">Authenticate</span>
                </button>
            </div>

            <div class="quick-btns">
                <button class="quick-btn" data-prompt="Help me write ">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                    Write
                </button>
                <button class="quick-btn" data-prompt="Help me code ">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>
                    </svg>
                    Code
                </button>
                <button class="quick-btn" data-prompt="Analyze and explain ">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    Analyze
                </button>
                <button class="quick-btn" data-prompt="Explain ">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    Explain
                </button>
            </div>
        </div>

        <!-- Chat View -->
        <div class="chat-view" id="chatView">
            <div class="chat-thread" id="chatThread">
                <div class="thread-inner" id="threadInner"></div>
            </div>

            <div class="typing" id="typingBubble">
                <div class="t-av">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
                    </svg>
                </div>
                <div class="t-dots">
                    <div class="t-dot"></div>
                    <div class="t-dot"></div>
                    <div class="t-dot"></div>
                </div>
            </div>

            <div class="cin-area">
                <div class="cin-inner">
                    <div class="cin-meta">
                        <div class="model-pill-wrap">
                            <button class="model-pill" id="chatPill">
                                <span class="m-dot" id="cDot"></span>
                                <span id="cModelTxt">—</span>
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                            </button>
                            <div class="m-dropdown" id="cDropdown">
                                <div class="m-drop-head">Select model</div>
                                <div id="cModelList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="cin-bar">
                        <textarea class="chat-input" id="chatInput" placeholder="Message Claude…" rows="1"></textarea>
                        <div class="input-btns">
                            <button class="send-btn" id="chatSendBtn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<div class="toast" id="toast"></div>

<!-- Prism syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>

<script>
/* ================================================================
   STATE
================================================================ */
let models       = [];
let currentModel = 'claude-sonnet-4-5';  // hardcoded fallback until real list loads
let modelsLoaded = false;
let history      = [];
let streaming    = false;
let convs        = [];
let activeConvId = null;

/* ================================================================
   BOOT
================================================================ */
document.addEventListener('DOMContentLoaded', () => {
    setGreeting();
    bindEvents();
    // Show default model in pill — real list loads after first successful chat
    setText('wModelTxt', currentModel);
    setText('cModelTxt', currentModel);
    setDots('ok');
    document.getElementById('welcomeInput').focus();
});

function setGreeting() {
    const h = new Date().getHours();
    const g = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
    document.getElementById('greetingText').textContent = `${g}, Hassan`;
}

/* ================================================================
   MODELS — only called after Puter is known to be authenticated
================================================================ */
async function fetchModels(openDropdown = false) {
    if (modelsLoaded) return;          // don't re-fetch if already done
    setDots('loading');
    setText('wModelTxt', 'Loading models…');
    try {
        if (!window.puter?.ai) throw new Error('Puter not loaded');
        const list = await puter.ai.listModels();
        if (!list?.length) throw new Error('Empty list');
        models       = list;
        modelsLoaded = true;
        // Prefer the same model the user was already on, or fall back to first
        if (!models.find(m => m.id === currentModel)) currentModel = models[0].id;
        setDots('ok');
        populateModelLists();
        syncPillLabels();
        showToast('Models loaded');
        // Only open the dropdown if the user clicked a pill to trigger this
        if (openDropdown) {
            if (document.getElementById('chatView').classList.contains('active')) {
                toggleDropdown('cDropdown');
            } else {
                toggleDropdown('wDropdown');
            }
        }
    } catch (e) {
        console.error('fetchModels:', e);
        setDots('err');
        // Restore the fallback label so the pill still shows something useful
        setText('wModelTxt', currentModel);
        setText('cModelTxt', currentModel);
    }
}

function setDots(state) {
    document.querySelectorAll('.m-dot').forEach(d => {
        d.className = 'm-dot';
        if (state === 'loading') d.classList.add('spinning');
        if (state === 'err')     d.style.cssText = 'background:var(--red);box-shadow:0 0 5px var(--red)';
    });
}

function syncPillLabels() {
    if (!currentModel || !models.length) return;
    const m     = models.find(x => x.id === currentModel);
    const label = m?.name || m?.id || currentModel;
    setText('wModelTxt', label);
    setText('cModelTxt', label);
    document.querySelectorAll('.m-opt').forEach(el => {
        const sel = el.dataset.id === currentModel;
        el.classList.toggle('picked', sel);
        const chk = el.querySelector('.m-check');
        if (chk) chk.style.display = sel ? '' : 'none';
    });
}

function populateModelLists() {
    ['wModelList', 'cModelList'].forEach(id => {
        const list = document.getElementById(id);
        if (!list) return;
        list.innerHTML = '';
        models.forEach(m => {
            const opt  = document.createElement('div');
            opt.className = 'm-opt' + (m.id === currentModel ? ' picked' : '');
            opt.dataset.id = m.id;
            opt.innerHTML  = `
                <span class="m-opt-name">${m.name || m.id}</span>
                <span class="m-check" style="${m.id !== currentModel ? 'display:none' : ''}">✓</span>
            `;
            opt.addEventListener('click', () => {
                currentModel = m.id;
                syncPillLabels();
                closeDropdowns();
            });
            list.appendChild(opt);
        });
    });
}

function closeDropdowns() {
    document.querySelectorAll('.m-dropdown').forEach(d => d.classList.remove('open'));
}

function toggleDropdown(ddId) {
    const dd     = document.getElementById(ddId);
    const wasOpen = dd.classList.contains('open');
    closeDropdowns();
    if (!wasOpen) dd.classList.add('open');
}

/* ================================================================
   AUTH
================================================================ */
async function handleAuth() {
    const btn = document.getElementById('authBtn');
    const txt = document.getElementById('authTxt');
    btn.disabled = true;
    txt.textContent = 'Authenticating…';
    try {
        await puter.ai.chat('ping', { model: currentModel || 'claude-sonnet-4-5' });
        txt.textContent = '✓ Authenticated';
        btn.style.cssText = 'background:rgba(52,211,153,0.08);border-color:rgba(52,211,153,0.25);color:var(--green)';
        await fetchModels(true);
        setTimeout(() => btn.closest('.model-bar')?.remove(), 3000);
    } catch (e) {
        console.error('auth:', e);
        txt.textContent = 'Failed — try again';
        btn.disabled = false;
        btn.style.color = 'var(--red)';
    }
}

/* ================================================================
   EVENTS
================================================================ */
function bindEvents() {
    // Inputs
    bindTextarea('welcomeInput', handleWelcomeSend);
    bindTextarea('chatInput',    handleChatSend);

    on('welcomeSendBtn', 'click', handleWelcomeSend);
    on('chatSendBtn',    'click', handleChatSend);
    on('newChatBtn',     'click', resetToWelcome);
    on('authBtn',        'click', handleAuth);

    // Quick prompts
    document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const inp = document.getElementById('welcomeInput');
            inp.value = btn.dataset.prompt;
            inp.focus();
            autoResize(inp);
        });
    });

    // Model pill dropdowns — fetch models on first open if not yet loaded
    on('welcomePill', 'click', e => {
        e.stopPropagation();
        if (!modelsLoaded) { fetchModels(true); return; }
        toggleDropdown('wDropdown');
    });
    on('chatPill', 'click', e => {
        e.stopPropagation();
        if (!modelsLoaded) { fetchModels(true); return; }
        toggleDropdown('cDropdown');
    });

    // Close dropdowns on outside click
    document.addEventListener('click', closeDropdowns);
    document.querySelectorAll('.m-dropdown').forEach(d => d.addEventListener('click', e => e.stopPropagation()));
}

function bindTextarea(id, sendFn) {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => autoResize(el));
    el.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendFn(); }
    });
}

function on(id, ev, fn) {
    document.getElementById(id)?.addEventListener(ev, fn);
}

/* ================================================================
   SEND MESSAGES
================================================================ */
async function handleWelcomeSend() {
    const inp = document.getElementById('welcomeInput');
    const msg = inp.value.trim();
    if (!msg || streaming) return;
    inp.value = '';
    autoResize(inp);
    startConversation(msg);
    showChatView();
    await sendMessage(msg);
}

async function handleChatSend() {
    const inp = document.getElementById('chatInput');
    const msg = inp.value.trim();
    if (!msg || streaming) return;
    inp.value = '';
    autoResize(inp);
    await sendMessage(msg);
}

async function sendMessage(text) {
    if (streaming) return;
    streaming = true;

    appendUserMsg(text);
    history.push({ role: 'user', content: text });

    showTyping(true);
    setInputsEnabled(false);

    try {
        if (!window.puter) throw new Error('Puter.js not available');

        const res = await puter.ai.chat(history, { model: currentModel, stream: true });

        showTyping(false);

        const { bodyEl, cursor } = appendAIMsg();
        let fullText = '';

        for await (const part of res) {
            if (part?.text) {
                fullText += part.text;
                renderMD(fullText, bodyEl, cursor);
                scrollBottom();
            }
        }

        // Final render — remove cursor
        cursor.remove();
        renderMD(fullText, bodyEl, null);
        if (typeof Prism !== 'undefined') Prism.highlightAll();
        scrollBottom();

        history.push({ role: 'assistant', content: fullText });
        saveConversation();

        // Lazily fetch model list after first successful response
        if (!modelsLoaded) fetchModels();

    } catch (err) {
        console.error('sendMessage:', err);
        showTyping(false);

        const isLimit = /limit|quota|rate|auth/i.test(err.message || '');
        const bodyEl  = appendErrorMsg(
            isLimit
                ? '⚠️ Session limit or authentication error. Please reset your session.'
                : `Error: ${err.message}`
        );

        if (isLimit) {
            const rb = document.createElement('button');
            rb.className = 'reset-link';
            rb.innerHTML = '↺ Reset session';
            rb.onclick   = nukePuterSession;
            bodyEl.appendChild(rb);
        }

        if (history.at(-1)?.role === 'user') history.pop();

    } finally {
        streaming = false;
        setInputsEnabled(true);
        document.getElementById('chatInput')?.focus();
    }
}

/* ================================================================
   DOM — MESSAGES
================================================================ */
function appendUserMsg(text) {
    const div       = document.createElement('div');
    div.className   = 'msg user';
    div.innerHTML   = `
        <div class="msg-av">H</div>
        <div class="msg-body">${escHtml(text)}</div>
    `;
    getThread().appendChild(div);
    scrollBottom();
}

function appendAIMsg() {
    const msg     = document.createElement('div');
    msg.className = 'msg ai';

    const av      = document.createElement('div');
    av.className  = 'msg-av';
    av.innerHTML  = aiSvg();

    const bodyEl  = document.createElement('div');
    bodyEl.className = 'msg-body md';

    const cursor  = document.createElement('span');
    cursor.className = 's-cur';
    bodyEl.appendChild(cursor);

    msg.appendChild(av);
    msg.appendChild(bodyEl);
    getThread().appendChild(msg);
    scrollBottom();

    return { bodyEl, cursor };
}

function appendErrorMsg(text) {
    const msg     = document.createElement('div');
    msg.className = 'msg ai';

    const av      = document.createElement('div');
    av.className  = 'msg-av';
    av.innerHTML  = aiSvg();

    const bodyEl  = document.createElement('div');
    bodyEl.className = 'msg-body md msg-err';
    bodyEl.textContent = text;

    msg.appendChild(av);
    msg.appendChild(bodyEl);
    getThread().appendChild(msg);
    scrollBottom();

    return bodyEl;
}

function aiSvg() {
    return `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
        <circle cx="12" cy="12" r="5"/>
        <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
    </svg>`;
}

/* ================================================================
   MARKDOWN RENDERER
================================================================ */
function renderMD(src, container, cursor) {
    container.innerHTML = '';
    parseMD(src).forEach(n => container.appendChild(n));
    if (cursor) container.appendChild(cursor);
}

function parseMD(src) {
    const nodes = [];
    const CODE  = /```(\w*)\n?([\s\S]*?)```/g;
    let   last  = 0, m;

    while ((m = CODE.exec(src)) !== null) {
        if (m.index > last) parseBlocks(src.slice(last, m.index)).forEach(n => nodes.push(n));
        nodes.push(makeCodeBlock(m[2].trim(), m[1] || 'text'));
        last = m.index + m[0].length;
    }

    if (last < src.length) parseBlocks(src.slice(last)).forEach(n => nodes.push(n));
    return nodes;
}

function parseBlocks(src) {
    const nodes = [];
    const lines = src.split('\n');
    let   i     = 0;

    while (i < lines.length) {
        const line = lines[i];

        // Heading
        const hm = line.match(/^(#{1,3})\s+(.*)/);
        if (hm) {
            const h = document.createElement(`h${hm[1].length}`);
            h.innerHTML = inlineOf(hm[2]);
            nodes.push(h);
            i++; continue;
        }

        // Blockquote
        if (line.startsWith('> ')) {
            const bq = document.createElement('blockquote');
            bq.innerHTML = inlineOf(line.slice(2));
            nodes.push(bq); i++; continue;
        }

        // HR
        if (/^[-*_]{3,}$/.test(line.trim())) {
            nodes.push(document.createElement('hr'));
            i++; continue;
        }

        // Unordered list
        if (/^[-*+] /.test(line)) {
            const ul = document.createElement('ul');
            while (i < lines.length && /^[-*+] /.test(lines[i])) {
                const li = document.createElement('li');
                li.innerHTML = inlineOf(lines[i].replace(/^[-*+] /, ''));
                ul.appendChild(li); i++;
            }
            nodes.push(ul); continue;
        }

        // Ordered list
        if (/^\d+\. /.test(line)) {
            const ol = document.createElement('ol');
            while (i < lines.length && /^\d+\. /.test(lines[i])) {
                const li = document.createElement('li');
                li.innerHTML = inlineOf(lines[i].replace(/^\d+\. /, ''));
                ol.appendChild(li); i++;
            }
            nodes.push(ol); continue;
        }

        // Empty line
        if (!line.trim()) { i++; continue; }

        // Paragraph — collect consecutive plain lines
        let text = '';
        while (i < lines.length && lines[i].trim() && !/^(#{1,3} |> |[-*+] |\d+\. |[-*_]{3,}$)/.test(lines[i])) {
            text += (text ? ' ' : '') + lines[i]; i++;
        }
        if (text) {
            const p = document.createElement('p');
            p.innerHTML = inlineOf(text);
            nodes.push(p);
        }
    }

    return nodes;
}

function inlineOf(s) {
    return s
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')   // escape HTML first
        .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.+?)\*\*/g,     '<strong>$1</strong>')
        .replace(/__(.+?)__/g,         '<strong>$1</strong>')
        .replace(/\*([^*\n]+?)\*/g,    '<em>$1</em>')
        .replace(/_([^_\n]+?)_/g,      '<em>$1</em>')
        .replace(/~~(.+?)~~/g,         '<del>$1</del>')
        .replace(/`([^`\n]+)`/g,       '<code>$1</code>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
}

function makeCodeBlock(code, lang) {
    const block  = document.createElement('div');
    block.className = 'code-block';

    // Header
    const head  = document.createElement('div');
    head.className = 'cb-head';

    const label = document.createElement('span');
    label.className = 'cb-lang';
    label.textContent = lang;

    const acts  = document.createElement('div');
    acts.className = 'cb-acts';

    // HTML preview
    if (lang.toLowerCase() === 'html') {
        const pb = makeBtn('preview', iconOpen + ' Preview');
        pb.onclick = () => window.open(URL.createObjectURL(new Blob([code], { type: 'text/html' })), '_blank');
        acts.appendChild(pb);
    }

    // Copy
    const copyDefault = iconCopy + ' Copy';
    const cb = makeBtn('', copyDefault);
    cb.onclick = () => {
        navigator.clipboard.writeText(code).then(() => {
            cb.innerHTML = '✓ Copied';
            showToast('Copied to clipboard');
            setTimeout(() => { cb.innerHTML = copyDefault; }, 2000);
        });
    };
    acts.appendChild(cb);

    // Download
    const db = makeBtn('', iconDown + ' Download');
    db.onclick = () => {
        const map = { javascript:'js', typescript:'ts', python:'py', html:'html', css:'css', json:'json', bash:'sh', shell:'sh' };
        const ext = map[lang.toLowerCase()] || 'txt';
        const a   = Object.assign(document.createElement('a'), {
            href:     URL.createObjectURL(new Blob([code], { type: 'text/plain' })),
            download: `code.${ext}`
        });
        a.click();
    };
    acts.appendChild(db);

    head.appendChild(label);
    head.appendChild(acts);

    // Code area
    const pre  = document.createElement('pre');
    const codeEl = document.createElement('code');
    const lc   = lang.toLowerCase();
    if (lc && lc !== 'text') {
        const cls = `language-${lc}`;
        pre.className  = cls;
        codeEl.className = cls;
    }
    codeEl.textContent = code;
    pre.appendChild(codeEl);

    block.appendChild(head);
    block.appendChild(pre);
    return block;
}

function makeBtn(extraClass, html) {
    const b = document.createElement('button');
    b.className = 'cb-btn' + (extraClass ? ' ' + extraClass : '');
    b.innerHTML = html;
    return b;
}

// Inline SVG icons (kept tiny)
const iconCopy = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
const iconDown = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;
const iconOpen = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>`;

/* ================================================================
   CONVERSATIONS
================================================================ */
function startConversation(firstMsg) {
    activeConvId = 'c' + Date.now();
    const title  = firstMsg.length > 46 ? firstMsg.slice(0, 46) + '…' : firstMsg;
    convs.unshift({ id: activeConvId, title, messages: [], ts: Date.now() });
    if (convs.length > 10) convs = convs.slice(0, 10);
    renderRecents();
}

function saveConversation() {
    const c = convs.find(x => x.id === activeConvId);
    if (c) { c.messages = [...history]; c.ts = Date.now(); renderRecents(); }
}

function loadConversation(id) {
    const c = convs.find(x => x.id === id);
    if (!c) return;
    activeConvId = id;
    history      = [...c.messages];
    getThread().innerHTML = '';
    c.messages.forEach(m => {
        if (m.role === 'user') appendUserMsg(m.content);
        else {
            const { bodyEl, cursor } = appendAIMsg();
            cursor.remove();
            renderMD(m.content, bodyEl, null);
        }
    });
    if (typeof Prism !== 'undefined') Prism.highlightAll();
    showChatView();
    scrollBottom();
}

function renderRecents() {
    const list = document.getElementById('recentList');
    list.innerHTML = '';
    if (!convs.length) { list.innerHTML = '<div class="empty-hint">No conversations yet</div>'; return; }
    convs.forEach(c => {
        const el = document.createElement('div');
        el.className = 'recent-item' + (c.id === activeConvId ? ' active' : '');
        el.textContent = c.title;
        el.onclick = () => loadConversation(c.id);
        list.appendChild(el);
    });
}

/* ================================================================
   VIEW SWITCHING
================================================================ */
function showChatView() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('chatView').classList.add('active');
    document.getElementById('chatInput')?.focus();
}

function resetToWelcome() {
    history      = [];
    activeConvId = null;
    getThread().innerHTML = '';
    document.getElementById('welcomeScreen').style.display = '';
    document.getElementById('chatView').classList.remove('active');
    const inp = document.getElementById('welcomeInput');
    if (inp) { inp.value = ''; autoResize(inp); inp.focus(); }
}

/* ================================================================
   UI HELPERS
================================================================ */
function showTyping(show) {
    document.getElementById('typingBubble').classList.toggle('on', show);
    if (show) scrollBottom();
}

function setInputsEnabled(en) {
    ['welcomeInput', 'chatInput', 'welcomeSendBtn', 'chatSendBtn'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.disabled = !en;
        el.style.opacity = en ? '' : '0.45';
    });
}

function scrollBottom() {
    const t = document.getElementById('chatThread');
    if (t) requestAnimationFrame(() => { t.scrollTop = t.scrollHeight; });
}

function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
}

function getThread() { return document.getElementById('threadInner'); }

function setText(id, val) {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
}

function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function nukePuterSession() {
    Object.keys(localStorage).filter(k => k.startsWith('puter')).forEach(k => localStorage.removeItem(k));
    location.reload();
}
</script>
</body>
</html>
